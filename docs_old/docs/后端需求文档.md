# RemoteGPU 后端需求文档

**版本**: v1.0
**日期**: 2026-02-02
**作者**: RemoteGPU开发团队

---

## 一、项目概述

RemoteGPU 后端负责资源管理、权限控制、任务调度、数据存储与对外 API 能力，需与前端需求文档保持一致，并支撑企业级多租户场景。

**核心目标**:
- 保障多租户数据隔离与权限审计
- 支撑整机分配与任务管理全流程
- 提供稳定的监控、告警、日志与统计能力
- 与公司 AD/LDAP/SSO 体系集成

---

## 二、角色与租户模型

### 2.1 租户模型
- 租户（Tenant）= 企业客户
- 资源强制携带 `tenantId`，并在查询层面隔离
- 管理员可跨租户访问，客户仅访问本租户资源

### 2.2 角色定义
- **Admin**: 平台管理员，拥有全局权限
- **Customer Owner**: 企业管理员，可管理团队、资源与成员
- **Customer Member**: 普通成员，可使用资源并被授权访问数据

---

## 三、认证与安全

### 3.1 认证方式
- 对接公司 AD/LDAP 或统一 SSO（优先）
- 登录成功后由后端签发 Access Token + Refresh Token
- 不提供注册接口，仅保留登录与找回密码流程

### 3.2 找回密码
- 若由平台承接：验证码发到企业邮箱/工号，并支持重置密码
- 若由统一认证承接：仅提供跳转链接

### 3.3 安全要求
- 重要操作（分配/回收/共享/审核）需审计记录
- SSH 密码默认不明文返回，仅支持重置或一次性凭证
- 所有接口需要租户与权限校验

---

## 四、API 规范

### 4.1 统一响应结构
```
{
  "code": 0,
  "message": "ok",
  "data": {},
  "traceId": "..."
}
```

### 4.2 分页与过滤
- 请求参数：`page`、`pageSize`、`sortBy`、`order`、`filters`
- 响应结构：`{ list, total, page, pageSize }`

### 4.3 状态枚举
- 机器：`online` / `offline` / `maintenance`
- 分配：`allocated` / `unallocated` / `expiring`
- 分配记录：`active` / `expired` / `reclaimed` / `pending`
- 任务：`queued` / `running` / `succeeded` / `failed` / `stopped`
- 数据集：`uploading` / `processing` / `available` / `failed`
- 镜像：`building` / `available` / `failed` / `rejected`
- 告警：`active` / `acknowledged` / `resolved`

### 4.4 错误码约定
- `400` 参数错误
- `401` 未登录
- `403` 无权限
- `404` 不存在
- `409` 资源冲突
- `429` 频率限制
- `500` 服务器错误

---

## 五、接口清单（建议）

### 5.1 认证与用户

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `POST` | `/api/auth/login` | AD/LDAP 登录并签发 Token | Public |
| `POST` | `/api/auth/refresh` | 刷新 Access Token | Public |
| `POST` | `/api/auth/logout` | 注销登录并撤销 Token | User |
| `GET` | `/api/auth/profile` | 获取当前用户信息 | User |
| `POST` | `/api/auth/password-reset/request` | 发送找回验证码 | Public |
| `POST` | `/api/auth/password-reset/confirm` | 提交新密码 | Public |

### 5.2 管理员端

#### 5.2.1 Dashboard

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/admin/dashboard/stats` | 统计卡片数据 | Admin |
| `GET` | `/api/admin/dashboard/gpu-trend` | GPU 使用率趋势 | Admin |
| `GET` | `/api/admin/allocations/recent` | 最近分配记录 | Admin |
| `GET` | `/api/admin/alerts/active` | 活跃告警列表 | Admin |

#### 5.2.2 机器管理

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/admin/machines` | 机器列表（筛选/分页） | Admin |
| `POST` | `/api/admin/machines` | 新增机器 | Admin |
| `PUT` | `/api/admin/machines/:id` | 更新机器 | Admin |
| `DELETE` | `/api/admin/machines/:id` | 删除机器 | Admin |
| `POST` | `/api/admin/machines/:id/allocate` | 分配机器 | Admin |
| `POST` | `/api/admin/machines/:id/reclaim` | 回收机器 | Admin |
| `GET` | `/api/admin/machines/import/template` | 下载导入模板 | Admin |
| `POST` | `/api/admin/machines/import` | 批量导入机器 | Admin |

#### 5.2.3 客户管理

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/admin/customers` | 客户列表 | Admin |
| `POST` | `/api/admin/customers` | 创建客户 | Admin |
| `PUT` | `/api/admin/customers/:id` | 更新客户 | Admin |
| `DELETE` | `/api/admin/customers/:id` | 删除客户 | Admin |
| `POST` | `/api/admin/customers/:id/disable` | 禁用客户 | Admin |
| `POST` | `/api/admin/customers/:id/enable` | 启用客户 | Admin |
| `GET` | `/api/admin/customers/:id` | 客户详情与统计 | Admin |

#### 5.2.4 分配管理

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/admin/allocations` | 分配记录 | Admin |
| `POST` | `/api/admin/allocations` | 创建分配 | Admin |
| `POST` | `/api/admin/allocations/:id/extend` | 续期 | Admin |
| `POST` | `/api/admin/allocations/:id/reclaim` | 提前回收 | Admin |

#### 5.2.5 监控与告警

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/admin/monitoring/realtime` | 实时监控数据 | Admin |
| `GET` | `/api/admin/alerts` | 告警列表 | Admin |
| `POST` | `/api/admin/alerts/:id/ack` | 确认告警 | Admin |
| `POST` | `/api/admin/alerts/:id/resolve` | 关闭告警 | Admin |
| `WS` | `/ws/admin/monitoring` | 实时监控推送 | Admin |

#### 5.2.6 镜像管理

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/admin/images` | 镜像列表 | Admin |
| `POST` | `/api/admin/images` | 创建镜像元数据 | Admin |
| `PUT` | `/api/admin/images/:id` | 更新镜像 | Admin |
| `DELETE` | `/api/admin/images/:id` | 删除镜像 | Admin |
| `POST` | `/api/admin/images/:id/approve` | 审核通过 | Admin |
| `POST` | `/api/admin/images/:id/reject` | 审核拒绝 | Admin |
| `POST` | `/api/admin/images/upload` | 上传镜像 | Admin |

#### 5.2.7 数据集与存储

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/admin/datasets` | 数据集列表 | Admin |
| `POST` | `/api/admin/datasets` | 创建数据集 | Admin |
| `PUT` | `/api/admin/datasets/:id` | 更新数据集 | Admin |
| `DELETE` | `/api/admin/datasets/:id` | 删除数据集 | Admin |
| `POST` | `/api/admin/datasets/:id/set-public` | 设为公开 | Admin |
| `POST` | `/api/admin/datasets/:id/set-private` | 设为私有 | Admin |
| `POST` | `/api/admin/datasets/upload` | 上传公共数据集 | Admin |
| `GET` | `/api/admin/storage/overview` | 存储概览 | Admin |
| `GET` | `/api/admin/storage/distribution` | 存储分布 | Admin |
| `GET` | `/api/admin/storage/quotas` | 配额列表 | Admin |
| `PUT` | `/api/admin/storage/quotas/:customerId` | 调整配额 | Admin |
| `GET` | `/api/admin/storage/cleanup-suggestions` | 清理建议 | Admin |

#### 5.2.8 任务管理

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/admin/tasks` | 任务列表 | Admin |
| `GET` | `/api/admin/tasks/:id` | 任务详情 | Admin |
| `GET` | `/api/admin/tasks/:id/logs` | 任务日志 | Admin |
| `POST` | `/api/admin/tasks/:id/stop` | 停止任务 | Admin |

#### 5.2.9 数据统计

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/admin/statistics/resources` | 资源统计 | Admin |
| `GET` | `/api/admin/statistics/customers` | 客户统计 | Admin |

#### 5.2.10 系统设置与审计

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/admin/settings` | 获取系统配置 | Admin |
| `PUT` | `/api/admin/settings` | 更新系统配置 | Admin |
| `GET` | `/api/admin/audits` | 审计日志 | Admin |

### 5.3 客户端

#### 5.3.1 工作台

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/customer/dashboard/stats` | 统计数据 | Customer |
| `GET` | `/api/customer/machines/summary` | 机器概览 | Customer |
| `GET` | `/api/customer/tasks/recent` | 最近任务 | Customer |

#### 5.3.2 我的机器

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/customer/machines` | 我的机器列表 | Customer |
| `GET` | `/api/customer/machines/:id` | 机器详情 | Customer |
| `GET` | `/api/customer/machines/:id/monitoring` | 实时监控 | Customer |
| `GET` | `/api/customer/machines/:id/processes` | 进程列表 | Customer |
| `GET` | `/api/customer/machines/:id/tasks` | 任务历史 | Customer |

#### 5.3.3 任务管理

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/customer/tasks` | 任务列表 | Customer |
| `GET` | `/api/customer/tasks/:id` | 任务详情 | Customer |
| `GET` | `/api/customer/tasks/:id/logs` | 任务日志 | Customer |
| `POST` | `/api/customer/tasks/:id/stop` | 停止任务 | Customer |
| `POST` | `/api/customer/tasks/:id/restart` | 重启任务 | Customer |
| `DELETE` | `/api/customer/tasks/:id` | 删除任务 | Customer |
| `POST` | `/api/customer/tasks/training` | 创建训练任务 | Customer |
| `GET` | `/api/customer/machines/available` | 可用机器 | Customer |
| `GET` | `/api/customer/images` | 可用镜像 | Customer |
| `WS` | `/ws/customer/tasks/:id/logs` | 任务日志推送 | Customer |

#### 5.3.4 镜像管理

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/customer/images/market` | 镜像市场列表 | Customer |
| `GET` | `/api/customer/images/:id` | 镜像详情 | Customer |
| `POST` | `/api/customer/images/:id/deploy` | 部署镜像 | Customer |
| `GET` | `/api/customer/images/my` | 我的镜像 | Customer |
| `POST` | `/api/customer/images/upload` | 上传镜像 | Customer |
| `DELETE` | `/api/customer/images/:id` | 删除镜像 | Customer |

#### 5.3.5 数据集管理

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/customer/datasets` | 我的数据集 | Customer |
| `GET` | `/api/customer/datasets/public` | 公共数据集 | Customer |
| `GET` | `/api/customer/datasets/shared` | 共享数据集 | Customer |
| `GET` | `/api/customer/datasets/:id` | 数据集详情 | Customer |
| `GET` | `/api/customer/storage/quota` | 存储配额 | Customer |
| `POST` | `/api/customer/datasets/:id/mount` | 挂载到机器 | Customer |
| `POST` | `/api/customer/datasets/:id/share` | 分享数据集 | Customer |
| `DELETE` | `/api/customer/datasets/:id` | 删除数据集 | Customer |
| `POST` | `/api/customer/datasets/upload` | 上传数据集 | Customer |
| `POST` | `/api/customer/datasets/import-url` | 从 URL 导入 | Customer |
| `POST` | `/api/customer/datasets/import-machine` | 从机器导入 | Customer |

#### 5.3.6 个人设置

| Method | Path | Description | Role |
| --- | --- | --- | --- |
| `GET` | `/api/customer/settings/profile` | 个人信息 | Customer |
| `PUT` | `/api/customer/settings/profile` | 更新个人信息 | Customer |
| `GET` | `/api/customer/settings/ssh-keys` | SSH 密钥列表 | Customer |
| `POST` | `/api/customer/settings/ssh-keys` | 新增 SSH 密钥 | Customer |
| `DELETE` | `/api/customer/settings/ssh-keys/:id` | 删除 SSH 密钥 | Customer |
| `GET` | `/api/customer/settings/notifications` | 通知设置 | Customer |
| `PUT` | `/api/customer/settings/notifications` | 更新通知设置 | Customer |

### 5.4 权限矩阵

权限标记说明：`M` 平台级管理（跨租户）、`W` 本租户读写（增删改）、`R` 只读、`-` 无权限。

| 模块 | Admin | Customer Owner | Customer Member | 说明 |
| --- | --- | --- | --- | --- |
| 认证与个人资料 | `R/W` | `R/W` | `R/W` | 仅操作本人资料 |
| 管理员仪表盘/统计 | `M` | `-` | `-` | `/api/admin/dashboard*` |
| 机器管理（全局） | `M` | `-` | `-` | `/api/admin/machines*` |
| 客户/租户管理 | `M` | `W` | `R` | Owner 可管理成员与基础信息 |
| 分配管理 | `M` | `R` | `R` | 客户仅查看本租户分配 |
| 监控与告警 | `M` | `W` | `R` | Owner 可确认/关闭告警 |
| 镜像管理 | `M` | `W` | `R` | Owner 管理自定义镜像 |
| 数据集与存储 | `M` | `W` | `W` | 受配额与共享权限控制 |
| 任务管理 | `M` | `W` | `W` | 可管理本人创建任务 |
| 系统设置与审计 | `M` | `R` | `-` | Owner 仅查看本租户审计 |
| 通知中心 | `R/W` | `R/W` | `R/W` | 仅本人通知 |

---

## 六、核心模块与接口需求

### 6.1 机器管理
- 机器增删改查、批量导入、维护记录
- 机器状态由 agent 心跳更新，支持离线判断
- 需校验 IP/SSH 域名唯一性
- 对应接口：`/api/admin/machines`、`/api/admin/machines/:id/allocate`

### 6.2 客户管理
- 客户信息维护、禁用/启用、客户详情统计
- 客户与租户绑定，支持团队成员管理
- 对应接口：`/api/admin/customers`

### 6.3 分配管理
- 分配记录、续期、提前回收
- 分配冲突校验（机器已分配、到期策略）
- 支持即将到期提醒
- 对应接口：`/api/admin/allocations`

### 6.4 监控中心与告警
- 监控数据由 agent 上报或拉取
- 支持实时 WebSocket 推送与历史查询
- 告警规则可配置阈值，支持确认/关闭
- 对应接口：`/api/admin/monitoring/realtime`、`/ws/admin/monitoring`

### 6.5 镜像管理
- 镜像元数据管理与审核
- 支持 Registry 拉取或上传镜像
- 镜像审核通过后对客户可见
- 对应接口：`/api/admin/images`、`/api/customer/images/market`

### 6.6 数据集管理与存储
- 记录数据集元信息与版本
- 支持分片上传、断点续传、秒传（MD5/ETag）
- 支持数据集共享、挂载、权限校验
- 维护存储配额与使用统计
- 对应接口：`/api/admin/datasets`、`/api/customer/datasets`

### 6.7 任务管理
- 支持训练/推理任务提交、状态同步
- 支持任务日志与运行指标查询
- 任务停止/重启需权限校验并记录审计
- 对应接口：`/api/customer/tasks`、`/api/admin/tasks`

### 6.8 数据统计
- 资源利用率、客户使用排行、存储占用统计
- 支持时间维度筛选与导出
- 对应接口：`/api/admin/statistics/resources`、`/api/admin/statistics/customers`

### 6.9 系统设置与审计
- 系统参数配置、权限管理、日志检索
- 审计日志包含操作者、时间、操作对象、结果
- 对应接口：`/api/admin/settings`、`/api/admin/audits`

---

## 七、实时与异步处理

### 7.1 WebSocket/事件流
- 监控实时数据推送
- 任务日志流式输出
- 告警事件实时通知

### 7.2 异步任务
- 数据集上传合并与校验
- 镜像上传/构建/扫描
- 数据集导入、挂载与清理任务

---

## 八、数据模型（概要）

- **Tenant**: id, name, status, quota
- **User**: id, tenantId, role, name, email, status
- **Machine**: id, name, specs, status, region, sshConfig
- **Allocation**: id, tenantId, machineId, status, startAt, endAt
- **Task**: id, tenantId, machineId, type, status, config
- **Dataset**: id, tenantId, name, size, status, visibility
- **Image**: id, name, tags, status, metadata
- **Alert**: id, type, level, status, targetId
- **AuditLog**: id, actorId, action, target, result

---

## 九、非功能要求

- **可用性**: 核心接口 SLA ≥ 99.5%
- **性能**: 列表接口默认分页，避免大查询
- **安全**: 全链路 HTTPS，敏感字段加密存储
- **限流**: 登录、上传、批量操作需限流
- **可观测性**: 结构化日志、指标、分布式追踪

---

## 十、MVP 范围建议

- 管理员：后台首页、机器管理、客户管理、分配管理
- 客户端：工作台、我的机器、基础监控
- 基础认证与权限校验

---

## 十一、数据库与数据表

### 11.1 数据库信息
- 数据库类型：PostgreSQL 14+
- 数据库名称：`remotegpu`
- 扩展依赖：`uuid-ossp`、`pgcrypto`
- 全量 DDL 脚本：`sql/`（执行顺序见 `sql/README.md`）
- 详细字段说明：`docs/design/database_design.md`

### 11.2 数据表清单（全量）

**系统配置**
- `system_configs` - 系统配置

**用户与权限**
- `customers` - 客户/用户
- `workspaces` - 工作空间
- `workspace_members` - 工作空间成员
- `resource_quotas` - 资源配额

**设备与资源**
- `hosts` - 主机
- `gpus` - GPU 设备

**环境与端口**
- `environments` - 开发环境/容器
- `port_mappings` - 端口映射

**数据与镜像**
- `datasets` - 数据集
- `dataset_versions` - 数据集版本
- `models` - 模型
- `model_versions` - 模型版本
- `images` - 镜像

**监控数据**
- `host_metrics` - 主机监控
- `gpu_metrics` - GPU 监控
- `environment_metrics` - 环境监控

**计费**
- `billing_records` - 计费记录
- `invoices` - 账单

**训练与推理**
- `training_jobs` - 训练任务
- `inference_services` - 推理服务

**通知与日志**
- `notifications` - 通知
- `audit_logs` - 审计日志

**告警与 Webhook**
- `alert_rules` - 告警规则
- `alert_records` - 告警记录
- `webhooks` - Webhook 配置
- `webhook_logs` - Webhook 调用日志

**工单与需求**
- `issues` - 问题单
- `requirements` - 需求单
- `comments` - 评论

**关联与制品**
- `dataset_usage` - 数据集使用记录
- `artifacts` - 制品

### 11.3 数据库表结构（字段级）

#### 11.3.1 系统配置

##### `system_configs`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `config_key` | `VARCHAR(128)` | UNIQUE, NOT NULL |
| `config_value` | `TEXT` | NOT NULL |
| `config_type` | `VARCHAR(32)` | DEFAULT `string` |
| `description` | `TEXT` |  |
| `is_public` | `BOOLEAN` | DEFAULT `false` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

#### 11.3.2 用户与权限

##### `customers`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `uuid` | `UUID` | UNIQUE, NOT NULL |
| `username` | `VARCHAR(64)` | UNIQUE, NOT NULL |
| `email` | `VARCHAR(128)` | UNIQUE, NOT NULL |
| `password_hash` | `VARCHAR(256)` | NOT NULL |
| `display_name` | `VARCHAR(128)` |  |
| `avatar_url` | `VARCHAR(512)` |  |
| `phone` | `VARCHAR(32)` |  |
| `full_name` | `VARCHAR(256)` |  |
| `company` | `VARCHAR(256)` |  |
| `user_type` | `VARCHAR(32)` | DEFAULT `external` |
| `account_type` | `VARCHAR(32)` | DEFAULT `individual` |
| `status` | `VARCHAR(32)` | DEFAULT `active` |
| `email_verified` | `BOOLEAN` | DEFAULT `false` |
| `phone_verified` | `BOOLEAN` | DEFAULT `false` |
| `balance` | `DECIMAL(10,4)` | DEFAULT `0.00` |
| `currency` | `VARCHAR(10)` | DEFAULT `CNY` |
| `overdue_status` | `VARCHAR(20)` | DEFAULT `normal` |
| `overdue_since` | `TIMESTAMP` |  |
| `last_payment_at` | `TIMESTAMP` |  |
| `last_login_at` | `TIMESTAMP` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `deleted_at` | `TIMESTAMP` |  |

##### `workspaces`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `uuid` | `UUID` | UNIQUE, NOT NULL |
| `owner_id` | `BIGINT` | NOT NULL |
| `name` | `VARCHAR(128)` | NOT NULL |
| `description` | `TEXT` |  |
| `type` | `VARCHAR(32)` | DEFAULT `personal` |
| `member_count` | `INT` | DEFAULT `1` |
| `status` | `VARCHAR(32)` | DEFAULT `active` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

##### `workspace_members`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `workspace_id` | `BIGINT` | NOT NULL |
| `customer_id` | `BIGINT` | NOT NULL |
| `role` | `VARCHAR(32)` | DEFAULT `member` |
| `status` | `VARCHAR(32)` | DEFAULT `active` |
| `joined_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |

唯一约束：`(workspace_id, customer_id)`。

##### `resource_quotas`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `customer_id` | `BIGINT` | NOT NULL |
| `workspace_id` | `BIGINT` |  |
| `quota_level` | `VARCHAR(32)` | DEFAULT `free` |
| `cpu_quota` | `INT` | DEFAULT `4` |
| `memory_quota` | `INT` | DEFAULT `8192` |
| `gpu_quota` | `INT` | DEFAULT `0` |
| `storage_quota` | `BIGINT` | DEFAULT `10737418240` |
| `environment_quota` | `INT` | DEFAULT `1` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

#### 11.3.3 设备与资源

##### `hosts`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `VARCHAR(64)` | PK |
| `name` | `VARCHAR(128)` | NOT NULL |
| `hostname` | `VARCHAR(256)` |  |
| `ip_address` | `VARCHAR(64)` | NOT NULL |
| `public_ip` | `VARCHAR(64)` |  |
| `os_type` | `VARCHAR(20)` | NOT NULL |
| `os_version` | `VARCHAR(64)` |  |
| `arch` | `VARCHAR(20)` | DEFAULT `x86_64` |
| `deployment_mode` | `VARCHAR(20)` | NOT NULL |
| `k8s_node_name` | `VARCHAR(128)` |  |
| `status` | `VARCHAR(20)` | DEFAULT `offline` |
| `health_status` | `VARCHAR(20)` | DEFAULT `unknown` |
| `total_cpu` | `INT` | NOT NULL |
| `total_memory` | `BIGINT` | NOT NULL |
| `total_disk` | `BIGINT` |  |
| `total_gpu` | `INT` | DEFAULT `0` |
| `used_cpu` | `INT` | DEFAULT `0` |
| `used_memory` | `BIGINT` | DEFAULT `0` |
| `used_disk` | `BIGINT` | DEFAULT `0` |
| `used_gpu` | `INT` | DEFAULT `0` |
| `ssh_port` | `INT` | DEFAULT `22` |
| `winrm_port` | `INT` |  |
| `agent_port` | `INT` | DEFAULT `8080` |
| `labels` | `JSONB` |  |
| `tags` | `TEXT[]` |  |
| `last_heartbeat` | `TIMESTAMP` |  |
| `registered_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

##### `gpus`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `host_id` | `VARCHAR(64)` | NOT NULL |
| `gpu_index` | `INT` | NOT NULL |
| `uuid` | `VARCHAR(128)` | UNIQUE |
| `name` | `VARCHAR(128)` |  |
| `brand` | `VARCHAR(64)` |  |
| `architecture` | `VARCHAR(64)` |  |
| `memory_total` | `BIGINT` |  |
| `cuda_cores` | `INT` |  |
| `compute_capability` | `VARCHAR(32)` |  |
| `status` | `VARCHAR(20)` | DEFAULT `available` |
| `health_status` | `VARCHAR(20)` | DEFAULT `healthy` |
| `allocated_to` | `VARCHAR(64)` |  |
| `allocated_at` | `TIMESTAMP` |  |
| `power_limit` | `INT` |  |
| `temperature_limit` | `INT` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

唯一约束：`(host_id, gpu_index)`。

#### 11.3.4 环境与端口

##### `environments`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `VARCHAR(64)` | PK |
| `customer_id` | `BIGINT` | NOT NULL |
| `workspace_id` | `BIGINT` |  |
| `host_id` | `VARCHAR(64)` | NOT NULL |
| `name` | `VARCHAR(128)` | NOT NULL |
| `description` | `TEXT` |  |
| `image` | `VARCHAR(256)` | NOT NULL |
| `status` | `VARCHAR(20)` | DEFAULT `creating` |
| `cpu` | `INT` | NOT NULL |
| `memory` | `BIGINT` | NOT NULL |
| `gpu` | `INT` | DEFAULT `0` |
| `gpu_memory` | `BIGINT` |  |
| `storage` | `BIGINT` |  |
| `temp_storage` | `BIGINT` |  |
| `ssh_port` | `INT` |  |
| `ssh_enabled` | `BOOLEAN` | DEFAULT `true` |
| `rdp_port` | `INT` |  |
| `rdp_enabled` | `BOOLEAN` | DEFAULT `false` |
| `jupyter_port` | `INT` |  |
| `jupyter_token` | `VARCHAR(128)` |  |
| `jupyter_enabled` | `BOOLEAN` | DEFAULT `true` |
| `tensorboard_port` | `INT` |  |
| `tensorboard_enabled` | `BOOLEAN` | DEFAULT `false` |
| `web_terminal_enabled` | `BOOLEAN` | DEFAULT `true` |
| `mounted_datasets` | `JSONB` |  |
| `mounted_models` | `JSONB` |  |
| `env_vars` | `JSONB` |  |
| `config` | `JSONB` |  |
| `container_id` | `VARCHAR(128)` |  |
| `pod_name` | `VARCHAR(128)` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `started_at` | `TIMESTAMP` |  |
| `stopped_at` | `TIMESTAMP` |  |
| `deleted_at` | `TIMESTAMP` |  |

##### `port_mappings`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `env_id` | `VARCHAR(64)` | NOT NULL |
| `service_type` | `VARCHAR(32)` | NOT NULL |
| `external_port` | `INT` | UNIQUE, NOT NULL |
| `internal_port` | `INT` | NOT NULL |
| `status` | `VARCHAR(20)` | DEFAULT `active` |
| `allocated_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `last_accessed_at` | `TIMESTAMP` |  |
| `auto_release_hours` | `INT` | DEFAULT `48` |
| `released_at` | `TIMESTAMP` |  |

#### 11.3.5 数据与镜像

##### `datasets`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `uuid` | `UUID` | UNIQUE, NOT NULL |
| `customer_id` | `BIGINT` | NOT NULL |
| `workspace_id` | `BIGINT` |  |
| `name` | `VARCHAR(256)` | NOT NULL |
| `description` | `TEXT` |  |
| `storage_path` | `VARCHAR(512)` | NOT NULL |
| `storage_type` | `VARCHAR(32)` | DEFAULT `minio` |
| `total_size` | `BIGINT` | DEFAULT `0` |
| `file_count` | `INT` | DEFAULT `0` |
| `status` | `VARCHAR(20)` | DEFAULT `uploading` |
| `visibility` | `VARCHAR(20)` | DEFAULT `private` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

##### `dataset_versions`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `dataset_id` | `BIGINT` | NOT NULL |
| `version` | `VARCHAR(64)` | NOT NULL |
| `description` | `TEXT` |  |
| `storage_path` | `VARCHAR(512)` | NOT NULL |
| `size` | `BIGINT` | DEFAULT `0` |
| `file_count` | `INT` | DEFAULT `0` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |

唯一约束：`(dataset_id, version)`。

##### `models`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `uuid` | `UUID` | UNIQUE, NOT NULL |
| `customer_id` | `BIGINT` | NOT NULL |
| `workspace_id` | `BIGINT` |  |
| `name` | `VARCHAR(256)` | NOT NULL |
| `description` | `TEXT` |  |
| `framework` | `VARCHAR(64)` |  |
| `storage_path` | `VARCHAR(512)` | NOT NULL |
| `total_size` | `BIGINT` | DEFAULT `0` |
| `status` | `VARCHAR(20)` | DEFAULT `uploading` |
| `visibility` | `VARCHAR(20)` | DEFAULT `private` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

##### `model_versions`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `model_id` | `BIGINT` | NOT NULL |
| `version` | `VARCHAR(64)` | NOT NULL |
| `description` | `TEXT` |  |
| `storage_path` | `VARCHAR(512)` | NOT NULL |
| `size` | `BIGINT` | DEFAULT `0` |
| `metrics` | `JSONB` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |

唯一约束：`(model_id, version)`。

##### `images`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `name` | `VARCHAR(256)` | UNIQUE, NOT NULL |
| `display_name` | `VARCHAR(256)` |  |
| `description` | `TEXT` |  |
| `category` | `VARCHAR(64)` |  |
| `framework` | `VARCHAR(64)` |  |
| `framework_version` | `VARCHAR(64)` |  |
| `cuda_version` | `VARCHAR(32)` |  |
| `python_version` | `VARCHAR(32)` |  |
| `is_official` | `BOOLEAN` | DEFAULT `false` |
| `size` | `BIGINT` |  |
| `registry_url` | `VARCHAR(512)` |  |
| `status` | `VARCHAR(20)` | DEFAULT `active` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

#### 11.3.6 监控数据

##### `host_metrics`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `host_id` | `VARCHAR(64)` | NOT NULL |
| `cpu_usage_percent` | `FLOAT` |  |
| `cpu_load_1m` | `FLOAT` |  |
| `cpu_load_5m` | `FLOAT` |  |
| `cpu_load_15m` | `FLOAT` |  |
| `memory_used` | `BIGINT` |  |
| `memory_available` | `BIGINT` |  |
| `memory_usage_percent` | `FLOAT` |  |
| `disk_used` | `BIGINT` |  |
| `disk_available` | `BIGINT` |  |
| `disk_usage_percent` | `FLOAT` |  |
| `disk_io_read_bytes` | `BIGINT` |  |
| `disk_io_write_bytes` | `BIGINT` |  |
| `network_rx_bytes` | `BIGINT` |  |
| `network_tx_bytes` | `BIGINT` |  |
| `network_rx_packets` | `BIGINT` |  |
| `network_tx_packets` | `BIGINT` |  |
| `gpu_avg_utilization` | `FLOAT` |  |
| `gpu_avg_memory_used` | `BIGINT` |  |
| `gpu_avg_temperature` | `FLOAT` |  |
| `gpu_avg_power` | `FLOAT` |  |
| `collected_at` | `TIMESTAMP` | DEFAULT `NOW()` |

##### `gpu_metrics`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `gpu_id` | `BIGINT` | NOT NULL |
| `host_id` | `VARCHAR(64)` | NOT NULL |
| `utilization_percent` | `FLOAT` |  |
| `memory_used` | `BIGINT` |  |
| `memory_usage_percent` | `FLOAT` |  |
| `temperature` | `FLOAT` |  |
| `power_draw` | `FLOAT` |  |
| `fan_speed_percent` | `FLOAT` |  |
| `sm_clock` | `INT` |  |
| `memory_clock` | `INT` |  |
| `process_count` | `INT` |  |
| `collected_at` | `TIMESTAMP` | DEFAULT `NOW()` |

##### `environment_metrics`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `env_id` | `VARCHAR(64)` | NOT NULL |
| `cpu_usage_percent` | `FLOAT` |  |
| `memory_usage_percent` | `FLOAT` |  |
| `gpu_usage_percent` | `FLOAT` |  |
| `disk_usage_percent` | `FLOAT` |  |
| `network_rx_bytes` | `BIGINT` |  |
| `network_tx_bytes` | `BIGINT` |  |
| `collected_at` | `TIMESTAMP` | DEFAULT `NOW()` |

#### 11.3.7 计费

##### `billing_records`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `customer_id` | `BIGINT` | NOT NULL |
| `workspace_id` | `BIGINT` |  |
| `resource_id` | `VARCHAR(64)` |  |
| `resource_type` | `VARCHAR(32)` | NOT NULL |
| `resource_name` | `VARCHAR(256)` |  |
| `quantity` | `FLOAT` | NOT NULL |
| `unit_price` | `DECIMAL(10,4)` | NOT NULL |
| `amount` | `DECIMAL(10,4)` | NOT NULL |
| `currency` | `VARCHAR(10)` | DEFAULT `CNY` |
| `billing_unit` | `VARCHAR(20)` | DEFAULT `minute` |
| `billing_minutes` | `INT` |  |
| `start_time` | `TIMESTAMP` | NOT NULL |
| `end_time` | `TIMESTAMP` | NOT NULL |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |

##### `invoices`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `invoice_no` | `VARCHAR(64)` | UNIQUE, NOT NULL |
| `customer_id` | `BIGINT` | NOT NULL |
| `billing_period_start` | `TIMESTAMP` | NOT NULL |
| `billing_period_end` | `TIMESTAMP` | NOT NULL |
| `total_amount` | `DECIMAL(10,4)` | NOT NULL |
| `currency` | `VARCHAR(10)` | DEFAULT `CNY` |
| `status` | `VARCHAR(20)` | DEFAULT `pending` |
| `paid_at` | `TIMESTAMP` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

#### 11.3.8 训练与推理

##### `training_jobs`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `VARCHAR(64)` | PK |
| `customer_id` | `BIGINT` | NOT NULL |
| `workspace_id` | `BIGINT` |  |
| `env_id` | `VARCHAR(64)` |  |
| `name` | `VARCHAR(256)` | NOT NULL |
| `description` | `TEXT` |  |
| `image` | `VARCHAR(256)` | NOT NULL |
| `framework` | `VARCHAR(64)` |  |
| `mounted_datasets` | `JSONB` |  |
| `mounted_models` | `JSONB` |  |
| `command` | `TEXT` | NOT NULL |
| `env_vars` | `JSONB` |  |
| `output_path` | `VARCHAR(512)` | DEFAULT `/gemini/output/` |
| `node_count` | `INT` | DEFAULT `1` |
| `distributed_config` | `JSONB` |  |
| `status` | `VARCHAR(20)` | DEFAULT `pending` |
| `priority` | `INT` | DEFAULT `0` |
| `cpu` | `INT` |  |
| `memory` | `BIGINT` |  |
| `gpu` | `INT` |  |
| `gpu_memory` | `BIGINT` |  |
| `started_at` | `TIMESTAMP` |  |
| `completed_at` | `TIMESTAMP` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `deleted_at` | `TIMESTAMP` |  |

##### `inference_services`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `VARCHAR(64)` | PK |
| `customer_id` | `BIGINT` | NOT NULL |
| `workspace_id` | `BIGINT` |  |
| `name` | `VARCHAR(256)` | NOT NULL |
| `description` | `TEXT` |  |
| `model_id` | `BIGINT` |  |
| `model_version` | `VARCHAR(64)` |  |
| `image` | `VARCHAR(256)` | NOT NULL |
| `framework` | `VARCHAR(64)` |  |
| `status` | `VARCHAR(20)` | DEFAULT `creating` |
| `endpoint_url` | `VARCHAR(512)` |  |
| `replicas` | `INT` | DEFAULT `1` |
| `min_replicas` | `INT` | DEFAULT `1` |
| `max_replicas` | `INT` | DEFAULT `10` |
| `autoscaling_enabled` | `BOOLEAN` | DEFAULT `false` |
| `autoscaling_config` | `JSONB` |  |
| `version` | `VARCHAR(64)` |  |
| `previous_version` | `VARCHAR(64)` |  |
| `health_check_path` | `VARCHAR(256)` |  |
| `health_check_interval` | `INT` | DEFAULT `30` |
| `env_vars` | `JSONB` |  |
| `cpu` | `INT` |  |
| `memory` | `BIGINT` |  |
| `gpu` | `INT` |  |
| `gpu_memory` | `BIGINT` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `deleted_at` | `TIMESTAMP` |  |

#### 11.3.9 通知与日志

##### `notifications`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `customer_id` | `BIGINT` | NOT NULL |
| `title` | `VARCHAR(256)` | NOT NULL |
| `content` | `TEXT` |  |
| `type` | `VARCHAR(32)` | NOT NULL |
| `level` | `VARCHAR(20)` | DEFAULT `info` |
| `is_read` | `BOOLEAN` | DEFAULT `false` |
| `read_at` | `TIMESTAMP` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |

##### `audit_logs`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `customer_id` | `BIGINT` |  |
| `username` | `VARCHAR(128)` |  |
| `action` | `VARCHAR(128)` | NOT NULL |
| `resource_type` | `VARCHAR(64)` |  |
| `resource_id` | `VARCHAR(128)` |  |
| `ip_address` | `VARCHAR(64)` |  |
| `user_agent` | `TEXT` |  |
| `request_method` | `VARCHAR(10)` |  |
| `request_path` | `VARCHAR(512)` |  |
| `status_code` | `INT` |  |
| `error_message` | `TEXT` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |

#### 11.3.10 告警与 Webhook

##### `alert_rules`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `customer_id` | `BIGINT` |  |
| `name` | `VARCHAR(256)` | NOT NULL |
| `description` | `TEXT` |  |
| `metric_type` | `VARCHAR(64)` | NOT NULL |
| `threshold` | `FLOAT` | NOT NULL |
| `comparison` | `VARCHAR(10)` | NOT NULL |
| `duration` | `INT` | DEFAULT `60` |
| `severity` | `VARCHAR(20)` | DEFAULT `warning` |
| `enabled` | `BOOLEAN` | DEFAULT `true` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

##### `alert_records`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `rule_id` | `BIGINT` | NOT NULL |
| `customer_id` | `BIGINT` |  |
| `resource_type` | `VARCHAR(64)` |  |
| `resource_id` | `VARCHAR(128)` |  |
| `metric_type` | `VARCHAR(64)` | NOT NULL |
| `current_value` | `FLOAT` | NOT NULL |
| `threshold` | `FLOAT` | NOT NULL |
| `severity` | `VARCHAR(20)` | NOT NULL |
| `status` | `VARCHAR(20)` | DEFAULT `firing` |
| `message` | `TEXT` |  |
| `triggered_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `resolved_at` | `TIMESTAMP` |  |

##### `webhooks`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `customer_id` | `BIGINT` | NOT NULL |
| `name` | `VARCHAR(256)` | NOT NULL |
| `url` | `VARCHAR(512)` | NOT NULL |
| `secret` | `VARCHAR(256)` |  |
| `events` | `TEXT[]` | NOT NULL |
| `enabled` | `BOOLEAN` | DEFAULT `true` |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

##### `webhook_logs`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `webhook_id` | `BIGINT` | NOT NULL |
| `event_type` | `VARCHAR(64)` | NOT NULL |
| `payload` | `JSONB` |  |
| `status_code` | `INT` |  |
| `response_body` | `TEXT` |  |
| `error_message` | `TEXT` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |

#### 11.3.11 工单与需求

##### `issues`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `issue_no` | `VARCHAR(64)` | UNIQUE, NOT NULL |
| `customer_id` | `BIGINT` | NOT NULL |
| `title` | `VARCHAR(256)` | NOT NULL |
| `description` | `TEXT` |  |
| `type` | `VARCHAR(32)` | NOT NULL |
| `priority` | `VARCHAR(20)` | DEFAULT `medium` |
| `status` | `VARCHAR(20)` | DEFAULT `open` |
| `assignee_id` | `BIGINT` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `resolved_at` | `TIMESTAMP` |  |

##### `requirements`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `requirement_no` | `VARCHAR(64)` | UNIQUE, NOT NULL |
| `customer_id` | `BIGINT` | NOT NULL |
| `title` | `VARCHAR(256)` | NOT NULL |
| `description` | `TEXT` |  |
| `priority` | `VARCHAR(20)` | DEFAULT `medium` |
| `status` | `VARCHAR(20)` | DEFAULT `submitted` |
| `assignee_id` | `BIGINT` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `completed_at` | `TIMESTAMP` |  |

##### `comments`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `customer_id` | `BIGINT` | NOT NULL |
| `resource_type` | `VARCHAR(32)` | NOT NULL |
| `resource_id` | `BIGINT` | NOT NULL |
| `content` | `TEXT` | NOT NULL |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `updated_at` | `TIMESTAMP` | DEFAULT `NOW()` |

#### 11.3.12 关联与制品

##### `dataset_usage`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `env_id` | `VARCHAR(64)` | NOT NULL |
| `dataset_id` | `BIGINT` | NOT NULL |
| `mount_path` | `VARCHAR(512)` | NOT NULL |
| `readonly` | `BOOLEAN` | DEFAULT `true` |
| `mounted_at` | `TIMESTAMP` | DEFAULT `NOW()` |
| `unmounted_at` | `TIMESTAMP` |  |

##### `artifacts`
| Column | Type | Notes |
| --- | --- | --- |
| `id` | `BIGSERIAL` | PK |
| `customer_id` | `BIGINT` | NOT NULL |
| `workspace_id` | `BIGINT` |  |
| `name` | `VARCHAR(256)` | NOT NULL |
| `type` | `VARCHAR(64)` | NOT NULL |
| `storage_path` | `VARCHAR(512)` | NOT NULL |
| `size` | `BIGINT` | DEFAULT `0` |
| `source_type` | `VARCHAR(32)` |  |
| `source_id` | `VARCHAR(128)` |  |
| `created_at` | `TIMESTAMP` | DEFAULT `NOW()` |

---

**文档结束**
