1# 用户认证与授权

> 所属模块：模块 2 - 用户与权限模块
>
> 功能编号：2.1
>
> 优先级：P0（必须）

---

## 1. 功能概述

### 1.1 功能描述

用户认证与授权功能提供完整的用户身份验证和权限控制机制，支持多种认证方式（用户名密码、OAuth2、LDAP），实现基于角色的访问控制（RBAC），确保系统安全性。

### 1.2 业务价值

- ✅ 保障系统安全，防止未授权访问
- ✅ 支持多种认证方式，灵活接入
- ✅ 细粒度权限控制，满足企业需求
- ✅ 统一的用户管理，降低运维成本

---

## 2. 认证方式

### 2.1 用户名密码认证

**实现方式：**
```go
// 用户登录
POST /api/auth/login
Body: {
  "username": "john_doe",
  "password": "password123"
}
Response: {
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
  "expires_in": 3600,
  "user": {
    "id": 1,
    "username": "john_doe",
    "email": "john@example.com",
    "roles": ["user"]
  }
}
```

**密码安全：**
- 使用 bcrypt 加密存储
- 密码强度要求：至少 8 位，包含大小写字母和数字
- 登录失败 5 次后锁定账户 30 分钟
- 支持密码重置功能

### 2.2 OAuth2 认证

**支持的 OAuth2 提供商：**
- GitHub
- Google
- 企业微信
- 钉钉

**实现流程：**
```
1. 用户点击"使用 GitHub 登录"
2. 跳转到 GitHub 授权页面
3. 用户授权后回调到系统
4. 系统获取 access_token
5. 使用 token 获取用户信息
6. 创建或更新用户记录
7. 返回系统 JWT token
```

### 2.3 LDAP/AD 认证

**配置示例：**
```yaml
ldap:
  host: ldap.example.com
  port: 389
  base_dn: dc=example,dc=com
  bind_dn: cn=admin,dc=example,dc=com
  bind_password: password
  user_filter: (uid=%s)
  group_filter: (memberUid=%s)
```

---

## 3. JWT Token 管理

### 3.1 Token 结构

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "user_id": 1,
    "username": "john_doe",
    "roles": ["user"],
    "exp": 1640995200,
    "iat": 1640991600
  }
}
```

### 3.2 Token 刷新机制

```go
// 刷新 Token
POST /api/auth/refresh
Headers: {
  "Authorization": "Bearer <refresh_token>"
}
Response: {
  "token": "new_access_token",
  "expires_in": 3600
}
```

---

## 4. 权限模型（RBAC）

### 4.1 角色定义

| 角色 | 说明 | 权限范围 |
|------|------|---------|
| super_admin | 超级管理员 | 所有权限 |
| admin | 管理员 | 用户管理、设备管理、系统配置 |
| operator | 运维人员 | 设备管理、监控查看 |
| user | 普通用户 | 创建环境、使用资源 |
| viewer | 访客 | 只读权限 |

### 4.2 权限列表

```yaml
权限定义:
  # 用户管理
  - user:create    # 创建用户
  - user:read      # 查看用户
  - user:update    # 更新用户
  - user:delete    # 删除用户

  # 设备管理
  - device:create  # 注册设备
  - device:read    # 查看设备
  - device:update  # 更新设备
  - device:delete  # 删除设备

  # 环境管理
  - env:create     # 创建环境
  - env:read       # 查看环境
  - env:update     # 更新环境
  - env:delete     # 删除环境
  - env:start      # 启动环境
  - env:stop       # 停止环境
```

---

## 5. API 接口

### 5.1 用户注册

```go
POST /api/auth/register
Body: {
  "username": "john_doe",
  "email": "john@example.com",
  "password": "Password123!",
  "full_name": "John Doe"
}
```

### 5.2 用户登录

```go
POST /api/auth/login
Body: {
  "username": "john_doe",
  "password": "Password123!"
}
```

### 5.3 权限检查

```go
// 中间件：检查权限
func RequirePermission(permission string) gin.HandlerFunc {
    return func(c *gin.Context) {
        user := GetCurrentUser(c)

        if !user.HasPermission(permission) {
            c.JSON(403, gin.H{"error": "权限不足"})
            c.Abort()
            return
        }

        c.Next()
    }
}

// 使用示例
router.POST("/api/devices",
    RequireAuth(),
    RequirePermission("device:create"),
    CreateDevice)
```

---

## 6. 数据模型

### 6.1 用户表

```sql
CREATE TABLE customers (
    id BIGSERIAL PRIMARY KEY,
    uuid VARCHAR(64) UNIQUE NOT NULL,
    username VARCHAR(128) UNIQUE NOT NULL,
    email VARCHAR(256) UNIQUE NOT NULL,
    password_hash VARCHAR(256) NOT NULL,
    full_name VARCHAR(256),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 6.2 角色表

```sql
CREATE TABLE roles (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(64) UNIQUE NOT NULL,
    description TEXT,
    permissions TEXT[]
);
```

---

## 7. 测试用例

| 用例 | 场景 | 预期结果 |
|------|------|---------|
| TC-01 | 正确的用户名密码 | 登录成功，返回 token |
| TC-02 | 错误的密码 | 登录失败，返回错误 |
| TC-03 | 连续 5 次失败 | 账户锁定 30 分钟 |
| TC-04 | Token 过期 | 返回 401，需要刷新 |
| TC-05 | 无权限访问 | 返回 403 |

---

**文档版本：** v1.0
**创建日期：** 2026-01-26
