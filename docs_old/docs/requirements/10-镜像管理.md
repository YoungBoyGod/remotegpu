# 镜像管理

> 所属模块：模块 6 - 镜像管理模块
>
> 功能编号：6.1
>
> 优先级：P0（必须）

---

## 1. 功能概述

### 1.1 功能描述

镜像管理功能提供 Docker 镜像的管理能力，包括官方镜像库、自定义镜像构建、镜像版本管理和镜像仓库集成，为环境创建提供基础镜像支持。

### 1.2 业务价值

- ✅ 提供预配置的深度学习镜像
- ✅ 支持用户自定义镜像
- ✅ 镜像版本管理和回滚
- ✅ 与 Harbor 镜像仓库集成

---

## 2. 核心功能

### 2.1 官方镜像库

**预置镜像列表：**

| 镜像名称 | 基础系统 | 框架 | CUDA | 大小 |
|---------|---------|------|------|------|
| ubuntu20-pytorch:2.0 | Ubuntu 20.04 | PyTorch 2.0 | 11.8 | 8GB |
| ubuntu20-tensorflow:2.12 | Ubuntu 20.04 | TensorFlow 2.12 | 11.8 | 7GB |
| ubuntu22-cuda:12.0 | Ubuntu 22.04 | - | 12.0 | 5GB |
| ubuntu20-jupyter:latest | Ubuntu 20.04 | JupyterLab | 11.8 | 6GB |

### 2.2 自定义镜像构建

**构建方式：**
1. **Dockerfile 构建**：用户提供 Dockerfile
2. **基于现有镜像**：在官方镜像基础上安装软件包
3. **从环境保存**：将运行中的环境保存为镜像

**构建流程：**
```yaml
构建流程:
  1. 用户提交构建请求
  2. 验证 Dockerfile
  3. 创建构建任务
  4. 执行 docker build
  5. 推送到镜像仓库
  6. 更新镜像记录
```

---

## 3. 数据模型

```sql
CREATE TABLE images (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(256) UNIQUE NOT NULL,
    description TEXT,
    category VARCHAR(64),

    -- 镜像信息
    registry VARCHAR(256),
    repository VARCHAR(256),
    tag VARCHAR(128),
    digest VARCHAR(128),
    size BIGINT,

    -- 类型
    is_official BOOLEAN DEFAULT false,
    visibility VARCHAR(20) DEFAULT 'public',

    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 4. API 接口

### 4.1 查询镜像列表

```go
GET /api/images
Query: category, is_official

Response: {
  "images": [
    {
      "id": 1,
      "name": "ubuntu20-pytorch:2.0",
      "description": "Ubuntu 20.04 + PyTorch 2.0",
      "category": "pytorch",
      "size": 8589934592,
      "is_official": true
    }
  ]
}
```

### 4.2 构建自定义镜像

```go
POST /api/images/build
Body: {
  "name": "my-custom-image:1.0",
  "base_image": "ubuntu20-pytorch:2.0",
  "dockerfile": "FROM ubuntu20-pytorch:2.0\nRUN pip install transformers",
  "description": "自定义 NLP 镜像"
}

Response: {
  "build_id": "build-abc123",
  "status": "building"
}
```

---

## 5. 前端界面

```vue
<template>
  <el-card>
    <h3>镜像管理</h3>

    <el-tabs v-model="activeTab">
      <el-tab-pane label="官方镜像" name="official">
        <el-row :gutter="20">
          <el-col :span="6" v-for="image in officialImages" :key="image.id">
            <el-card>
              <h4>{{ image.name }}</h4>
              <p>{{ image.description }}</p>
              <el-tag>{{ formatSize(image.size) }}</el-tag>
              <el-button type="primary" size="small" @click="useImage(image)">
                使用
              </el-button>
            </el-card>
          </el-col>
        </el-row>
      </el-tab-pane>

      <el-tab-pane label="自定义镜像" name="custom">
        <el-button type="primary" @click="showBuildDialog">
          构建镜像
        </el-button>
      </el-tab-pane>
    </el-tabs>
  </el-card>
</template>
```

---

## 6. 测试用例

| 用例 | 场景 | 预期结果 |
|------|------|---------|
| TC-01 | 查询官方镜像 | 返回镜像列表 |
| TC-02 | 构建自定义镜像 | 构建成功 |
| TC-03 | 使用镜像创建环境 | 环境创建成功 |

---

**文档版本：** v1.0
**创建日期：** 2026-01-26
