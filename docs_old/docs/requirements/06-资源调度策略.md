# 资源调度策略

> 所属模块：模块 4 - 资源调度模块
>
> 功能编号：4.1
>
> 优先级：P0（必须）

---

## 1. 功能概述

### 1.1 功能描述

资源调度策略负责根据用户的资源需求（CPU、内存、GPU）和调度策略，从可用主机池中选择最合适的主机，实现负载均衡和资源高效利用。

### 1.2 调度策略

```yaml
支持的调度策略:
  1. 首次适配 (First Fit):
     - 选择第一个满足条件的主机
     - 优点: 速度快
     - 缺点: 可能导致负载不均

  2. 最佳适配 (Best Fit):
     - 选择资源最接近需求的主机
     - 优点: 资源利用率高
     - 缺点: 计算开销大

  3. 最少负载 (Least Loaded):
     - 选择负载最低的主机
     - 优点: 负载均衡好
     - 缺点: 可能导致资源碎片

  4. 轮询 (Round Robin):
     - 轮流分配到各主机
     - 优点: 简单公平
     - 缺点: 不考虑实际负载
```

---

## 2. 调度流程

```go
// 调度请求
type ScheduleRequest struct {
    EnvID      string
    CustomerID int64
    CPU        int
    Memory     int64
    GPU        int
    OSType     string  // linux, windows
    Strategy   string  // least_loaded, first_fit
}

// 调度器
func (s *Scheduler) Schedule(req ScheduleRequest) (*Host, error) {
    // 1. 查询可用主机
    hosts := s.findAvailableHosts(req)
    if len(hosts) == 0 {
        return nil, errors.New("无可用主机")
    }

    // 2. 根据策略选择主机
    var selectedHost *Host
    switch req.Strategy {
    case "least_loaded":
        selectedHost = s.selectLeastLoaded(hosts)
    case "first_fit":
        selectedHost = hosts[0]
    default:
        selectedHost = hosts[0]
    }

    // 3. 分配资源
    s.allocateResources(selectedHost, req)

    return selectedHost, nil
}
```

---

## 3. API 接口

```go
// 内部调度接口
POST /internal/scheduler/schedule
Body: {
  "env_id": "env-abc123",
  "customer_id": 1,
  "cpu": 4,
  "memory": 17179869184,
  "gpu": 1,
  "os_type": "linux",
  "strategy": "least_loaded"
}

Response: {
  "host_id": "host-xyz789",
  "host_ip": "192.168.1.10",
  "allocated_gpus": [
    {"gpu_id": 1, "gpu_index": 0}
  ]
}
```

---

## 4. 测试用例

| 用例 | 场景 | 预期结果 |
|------|------|---------|
| TC-01 | 有可用主机 | 调度成功 |
| TC-02 | 无可用主机 | 返回错误 |
| TC-03 | 并发调度 | 无资源冲突 |

---

**文档版本：** v1.0
**创建日期：** 2026-01-26
