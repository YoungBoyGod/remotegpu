# 数据集管理

> 所属模块：模块 5 - 数据管理模块
>
> 功能编号：5.1
>
> 优先级：P0（必须）

---

## 1. 功能概述

### 1.1 功能描述

数据集管理功能提供数据集的上传、存储、版本管理和挂载能力，支持大规模数据集的高效管理，为训练任务提供数据支持。

### 1.2 业务价值

- ✅ 统一管理训练数据集
- ✅ 支持数据集版本控制
- ✅ 数据集共享和权限控制
- ✅ 高效的数据挂载机制

---

## 2. 核心功能

### 2.1 数据集上传

**支持的上传方式：**
1. **Web 上传**：通过浏览器上传小文件（< 1GB）
2. **命令行上传**：使用 CLI 工具上传大文件
3. **对象存储同步**：从 S3/OSS 同步数据

**上传流程：**
```yaml
上传流程:
  1. 创建数据集记录
  2. 获取上传凭证
  3. 分片上传文件
  4. 合并分片
  5. 计算文件哈希
  6. 更新数据集状态
```

### 2.2 数据集版本管理

**版本策略：**
- 每次修改创建新版本
- 版本号格式：v1.0.0（语义化版本）
- 支持版本回滚
- 保留历史版本

---

## 3. 数据模型

```sql
CREATE TABLE datasets (
    id BIGSERIAL PRIMARY KEY,
    uuid VARCHAR(64) UNIQUE NOT NULL,
    customer_id BIGINT NOT NULL,
    name VARCHAR(256) NOT NULL,
    description TEXT,

    -- 存储信息
    storage_path VARCHAR(512) NOT NULL,
    total_size BIGINT DEFAULT 0,
    file_count INT DEFAULT 0,

    -- 状态
    status VARCHAR(20) DEFAULT 'uploading',

    -- 权限
    visibility VARCHAR(20) DEFAULT 'private',

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    FOREIGN KEY (customer_id) REFERENCES customers(id)
);

CREATE TABLE dataset_versions (
    id BIGSERIAL PRIMARY KEY,
    dataset_id BIGINT NOT NULL,
    version VARCHAR(32) NOT NULL,
    description TEXT,
    size BIGINT,
    file_hash VARCHAR(128),
    created_at TIMESTAMP DEFAULT NOW(),

    FOREIGN KEY (dataset_id) REFERENCES datasets(id),
    UNIQUE(dataset_id, version)
);
```

---

## 4. API 接口

### 4.1 创建数据集

```go
POST /api/datasets
Body: {
  "name": "ImageNet-1K",
  "description": "图像分类数据集",
  "visibility": "private"
}

Response: {
  "dataset_id": "dataset-abc123",
  "upload_url": "https://storage.example.com/upload/...",
  "status": "uploading"
}
```

### 4.2 上传文件

```go
POST /api/datasets/:id/upload
Content-Type: multipart/form-data

Body: {
  "file": <binary data>,
  "chunk_index": 0,
  "total_chunks": 10
}
```

### 4.3 挂载数据集

```go
POST /api/environments/:id/mount-dataset
Body: {
  "dataset_id": "dataset-abc123",
  "mount_path": "/data/imagenet",
  "readonly": true
}
```

---

## 5. 前端界面

```vue
<template>
  <el-card>
    <h3>数据集管理</h3>

    <el-button type="primary" @click="showUploadDialog">
      上传数据集
    </el-button>

    <el-table :data="datasets" style="margin-top: 20px">
      <el-table-column prop="name" label="名称" />
      <el-table-column prop="size" label="大小">
        <template #default="{ row }">
          {{ formatSize(row.total_size) }}
        </template>
      </el-table-column>
      <el-table-column prop="status" label="状态">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.status)">
            {{ row.status }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button size="small" @click="mountDataset(row)">
            挂载
          </el-button>
          <el-button size="small" @click="deleteDataset(row)">
            删除
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </el-card>
</template>
```

---

## 6. 测试用例

| 用例 | 场景 | 预期结果 |
|------|------|---------|
| TC-01 | 上传小文件（< 100MB） | 上传成功 |
| TC-02 | 上传大文件（> 10GB） | 分片上传成功 |
| TC-03 | 挂载数据集到环境 | 挂载成功，可访问 |
| TC-04 | 删除数据集 | 删除成功 |

---

## 7. 实施计划

| 任务 | 工作量 |
|------|--------|
| 数据库设计 | 0.5 天 |
| 上传功能 | 3 天 |
| 版本管理 | 2 天 |
| 挂载功能 | 2 天 |
| 前端页面 | 2 天 |
| 测试 | 1.5 天 |

**总工作量：** 11 天

---

**文档版本：** v1.0
**创建日期：** 2026-01-26
