# 配额管理

> 所属模块：模块 2 - 用户与权限模块
>
> 功能编号：2.3
>
> 优先级：P1（重要）

---

## 1. 功能概述

### 1.1 功能描述

配额管理功能为用户和工作空间设置资源使用限制，包括 CPU、内存、GPU、存储等资源的配额控制，防止资源滥用，确保资源公平分配。

### 1.2 业务价值

- ✅ 防止资源滥用
- ✅ 确保资源公平分配
- ✅ 支持多租户隔离
- ✅ 灵活的配额策略

---

## 2. 配额类型

### 2.1 资源配额

```yaml
资源配额项:
  计算资源:
    - max_cpu: 最大 CPU 核心数
    - max_memory: 最大内存 (GB)
    - max_gpu: 最大 GPU 数量
    - max_environments: 最大环境数量

  存储资源:
    - max_storage: 最大存储空间 (GB)
    - max_datasets: 最大数据集数量
    - max_models: 最大模型数量

  网络资源:
    - max_bandwidth: 最大带宽 (Mbps)
```

### 2.2 配额级别

| 级别 | CPU | 内存 | GPU | 存储 | 价格 |
|------|-----|------|-----|------|------|
| Free | 2 | 4GB | 0 | 10GB | 免费 |
| Basic | 8 | 16GB | 1 | 100GB | ¥99/月 |
| Pro | 32 | 128GB | 4 | 500GB | ¥999/月 |
| Enterprise | 无限制 | 无限制 | 无限制 | 无限制 | 定制 |

---

## 3. 数据模型

```sql
CREATE TABLE quotas (
    id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT,
    workspace_id BIGINT,

    -- 计算资源配额
    max_cpu INT DEFAULT 2,
    max_memory BIGINT DEFAULT 4294967296,
    max_gpu INT DEFAULT 0,
    max_environments INT DEFAULT 1,

    -- 存储资源配额
    max_storage BIGINT DEFAULT 10737418240,
    max_datasets INT DEFAULT 5,
    max_models INT DEFAULT 5,

    -- 当前使用量
    used_cpu INT DEFAULT 0,
    used_memory BIGINT DEFAULT 0,
    used_gpu INT DEFAULT 0,
    used_environments INT DEFAULT 0,
    used_storage BIGINT DEFAULT 0,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

---

## 4. 配额检查

```go
// 配额检查器
type QuotaChecker struct {
    db *gorm.DB
}

// 检查配额
func (qc *QuotaChecker) CheckQuota(customerID int64, req ResourceRequest) error {
    var quota Quota
    if err := qc.db.Where("customer_id = ?", customerID).First(&quota).Error; err != nil {
        return err
    }

    // 检查 CPU 配额
    if quota.UsedCPU + req.CPU > quota.MaxCPU {
        return errors.New("CPU 配额不足")
    }

    // 检查内存配额
    if quota.UsedMemory + req.Memory > quota.MaxMemory {
        return errors.New("内存配额不足")
    }

    // 检查 GPU 配额
    if quota.UsedGPU + req.GPU > quota.MaxGPU {
        return errors.New("GPU 配额不足")
    }

    return nil
}
```

---

## 5. API 接口

```go
// 查询配额
GET /api/quotas/me

Response: {
  "max_cpu": 8,
  "used_cpu": 4,
  "max_memory": 17179869184,
  "used_memory": 8589934592,
  "max_gpu": 1,
  "used_gpu": 1
}
```

---

## 6. 前端界面

```vue
<template>
  <el-card>
    <h3>资源配额</h3>

    <el-descriptions :column="2" border>
      <el-descriptions-item label="CPU">
        {{ quota.used_cpu }} / {{ quota.max_cpu }} 核
        <el-progress
          :percentage="(quota.used_cpu / quota.max_cpu) * 100"
        />
      </el-descriptions-item>

      <el-descriptions-item label="内存">
        {{ formatSize(quota.used_memory) }} / {{ formatSize(quota.max_memory) }}
        <el-progress
          :percentage="(quota.used_memory / quota.max_memory) * 100"
        />
      </el-descriptions-item>

      <el-descriptions-item label="GPU">
        {{ quota.used_gpu }} / {{ quota.max_gpu }} 个
        <el-progress
          :percentage="(quota.used_gpu / quota.max_gpu) * 100"
        />
      </el-descriptions-item>
    </el-descriptions>

    <el-button type="primary" style="margin-top: 20px">
      升级配额
    </el-button>
  </el-card>
</template>
```

---

## 7. 测试用例

| 用例 | 场景 | 预期结果 |
|------|------|---------|
| TC-01 | 创建环境（配额充足） | 创建成功 |
| TC-02 | 创建环境（配额不足） | 返回配额不足错误 |
| TC-03 | 释放资源 | 配额使用量减少 |

---

**文档版本：** v1.0
**创建日期：** 2026-01-26
