# 开发环境部署场景分析与需求文档

## 一、场景分析

### 1.1 基础设施部署模式

#### 1.1.1 Kubernetes 集群模式
- **K8S Pod 部署** - 标准的容器化部署,使用 Deployment
- **K8S StatefulSet** - 需要持久化状态的环境(如 Jupyter Notebook、数据库)
- **K8S Job/CronJob** - 批处理训练任务,定时任务

**优势**:
- 自动调度和负载均衡
- 自动故障恢复
- 易于扩展
- 统一的资源管理

**劣势**:
- 需要 K8S 集群
- 配置相对复杂
- GPU 支持需要额外配置

#### 1.1.2 裸金属/虚拟机模式
- **Docker/Podman 容器** - 在物理机上运行容器
- **虚拟机(KVM/VMware)** - 完整的虚拟机环境
- **LXC/LXD 容器** - 系统级容器
- **直接安装** - 在操作系统上直接安装软件

**优势**:
- 更好的性能(特别是 GPU)
- 更灵活的配置
- 更好的隔离性(虚拟机)

**劣势**:
- 需要手动管理
- 资源利用率可能较低
- 扩展性较差

#### 1.1.3 混合模式
- K8S + 裸金属混合部署
- 容器 + 虚拟机混合

### 1.2 GPU 资源分配模式

#### 1.2.1 独占 GPU
- **整卡独占** - 适合深度学习训练
- **多卡独占** - 分布式训练

#### 1.2.2 GPU 虚拟化
- **vGPU** - NVIDIA vGPU 技术,需要特殊硬件和许可证
- **MIG(Multi-Instance GPU)** - A100/H100 的 GPU 分片
- **时间片共享** - 多个任务轮流使用

#### 1.2.3 无 GPU
- CPU 环境(开发、测试)

### 1.3 环境类型场景

#### 1.3.1 交互式开发环境
- **IDE 环境** - VSCode Server, JupyterLab, RStudio
- **命令行环境** - SSH 终端
- **桌面环境** - VNC, RDP, NoMachine

#### 1.3.2 训练环境
- **单机训练** - 单节点多卡
- **分布式训练** - 多节点多卡
- **批处理任务** - 定时训练任务

#### 1.3.3 推理/服务环境
- **模型推理服务** - TensorRT, ONNX Runtime
- **API 服务** - FastAPI, Flask
- **Web 应用** - Streamlit, Gradio

#### 1.3.4 数据处理环境
- **数据预处理** - Spark, Dask
- **ETL 任务** - Airflow, Prefect
- **数据分析** - Pandas, Polars

### 1.4 存储模式

#### 1.4.1 本地存储
- **临时存储** - 容器内存储,删除即消失
- **本地磁盘** - 挂载主机目录

#### 1.4.2 网络存储
- **NFS** - 共享文件系统
- **Ceph/GlusterFS** - 分布式存储
- **对象存储** - S3, MinIO, OSS

#### 1.4.3 持久化存储
- **PVC(Persistent Volume Claim)** - K8S 持久化卷
- **数据卷** - Docker Volume
- **快照/备份** - 定期备份环境

### 1.5 网络访问模式

#### 1.5.1 公网访问
- 需要公网 IP 和端口映射
- 需要域名和 SSL 证书
- 适合远程办公

#### 1.5.2 内网访问
- **VPN 访问** - 通过 VPN 连接
- **跳板机访问** - 通过堡垒机(Jumpserver)
- **专线访问** - 企业专线

#### 1.5.3 混合访问
- Web 服务公网访问
- SSH/开发环境内网访问

### 1.6 生命周期管理

#### 1.6.1 长期运行环境
- 持续运行的开发环境
- 需要保存状态和数据
- 定期备份

#### 1.6.2 临时环境
- 用完即删(Ephemeral)
- 无状态,可快速重建
- 适合测试和实验

#### 1.6.3 定时任务环境
- 定时启动/停止
- 按需启动(On-demand)
- 自动扩缩容

### 1.7 安全隔离级别

#### 1.7.1 完全隔离
- 独立虚拟机
- 独立网络(VLAN)
- 独立存储

#### 1.7.2 容器隔离
- Docker 容器隔离
- K8S Namespace 隔离
- Pod Security Policy

#### 1.7.3 进程隔离
- 用户级隔离
- Cgroup 资源限制
- Namespace 隔离

### 1.8 Jumpserver 集成考虑

#### 1.8.1 Jumpserver 功能
- 统一的访问入口
- 会话审计和录像
- 命令审计
- 权限管理
- 支持 SSH、RDP、VNC、Telnet 等多种协议

#### 1.8.2 集成方案
**方案一:完全集成**
- 所有连接都通过 Jumpserver
- 提供企业级安全审计
- 需要部署和维护 Jumpserver

**方案二:可选集成**
- 默认直接连接
- 可选择通过 Jumpserver 连接
- 灵活性更高

**方案三:不集成**
- 直接提供连接信息
- 简单快速
- 缺少审计功能

**建议**: 采用方案二(可选集成),在环境配置中增加 `use_jumpserver` 字段

## 二、数据模型设计

### 2.1 Environment 表扩展字段

```sql
ALTER TABLE environments ADD COLUMN IF NOT EXISTS deployment_mode VARCHAR(32) DEFAULT 'k8s_pod';
ALTER TABLE environments ADD COLUMN IF NOT EXISTS environment_type VARCHAR(32) DEFAULT 'ide';
ALTER TABLE environments ADD COLUMN IF NOT EXISTS gpu_mode VARCHAR(32) DEFAULT 'exclusive';
ALTER TABLE environments ADD COLUMN IF NOT EXISTS storage_type VARCHAR(32) DEFAULT 'local';
ALTER TABLE environments ADD COLUMN IF NOT EXISTS storage_config JSONB;
ALTER TABLE environments ADD COLUMN IF NOT EXISTS lifecycle_policy VARCHAR(32) DEFAULT 'persistent';
ALTER TABLE environments ADD COLUMN IF NOT EXISTS network_config JSONB;
ALTER TABLE environments ADD COLUMN IF NOT EXISTS use_jumpserver BOOLEAN DEFAULT false;
ALTER TABLE environments ADD COLUMN IF NOT EXISTS vnc_port INTEGER;
ALTER TABLE environments ADD COLUMN IF NOT EXISTS vnc_password VARCHAR(128);
```

### 2.2 枚举类型定义

```go
// DeploymentMode 部署模式
type DeploymentMode string

const (
    DeploymentK8sPod        DeploymentMode = "k8s_pod"        // K8S Pod
    DeploymentK8sStateful   DeploymentMode = "k8s_stateful"   // K8S StatefulSet
    DeploymentDockerLocal   DeploymentMode = "docker_local"   // 裸金属 Docker
    DeploymentVM            DeploymentMode = "vm"             // 虚拟机
    DeploymentBareMetal     DeploymentMode = "bare_metal"     // 裸金属直接安装
)

// EnvironmentType 环境类型
type EnvironmentType string

const (
    EnvTypeIDE          EnvironmentType = "ide"           // IDE 环境
    EnvTypeTerminal     EnvironmentType = "terminal"      // 命令行
    EnvTypeDesktop      EnvironmentType = "desktop"       // 桌面环境
    EnvTypeTraining     EnvironmentType = "training"      // 训练环境
    EnvTypeInference    EnvironmentType = "inference"     // 推理服务
    EnvTypeDataProcess  EnvironmentType = "data_process"  // 数据处理
)

// GPUMode GPU 分配模式
type GPUMode string

const (
    GPUModeExclusive    GPUMode = "exclusive"    // 独占
    GPUModeVGPU         GPUMode = "vgpu"         // vGPU
    GPUModeMIG          GPUMode = "mig"          // MIG
    GPUModeShared       GPUMode = "shared"       // 时间片共享
    GPUModeNone         GPUMode = "none"         // 无 GPU
)

// StorageType 存储类型
type StorageType string

const (
    StorageLocal        StorageType = "local"        // 本地存储
    StorageNFS          StorageType = "nfs"          // NFS
    StorageCeph         StorageType = "ceph"         // Ceph
    StorageS3           StorageType = "s3"           // 对象存储
    StoragePVC          StorageType = "pvc"          // K8S PVC
)

// LifecyclePolicy 生命周期策略
type LifecyclePolicy string

const (
    LifecyclePersistent LifecyclePolicy = "persistent" // 持久化
    LifecycleEphemeral  LifecyclePolicy = "ephemeral"  // 临时
    LifecycleScheduled  LifecyclePolicy = "scheduled"  // 定时
    LifecycleOnDemand   LifecyclePolicy = "on_demand"  // 按需
)
```

## 三、实施计划

### 第一阶段(MVP) - 基础功能

#### 任务 1.1: K8S Pod 部署支持
- [x] 已实现基础的 K8S Pod 创建
- [ ] 支持环境变量配置
- [ ] 支持资源限制(CPU/Memory/GPU)
- [ ] 支持镜像拉取策略

#### 任务 1.2: 裸金属 Docker 部署支持
- [ ] 实现 Docker 容器创建
- [ ] 实现 Docker 容器管理(启动/停止/删除)
- [ ] 实现端口映射
- [ ] 实现 GPU 设备映射

#### 任务 1.3: 独占 GPU 模式
- [x] 已实现 GPU 分配和释放
- [ ] 支持多卡分配
- [ ] 支持 GPU 型号选择

#### 任务 1.4: SSH/Jupyter 访问
- [x] 已实现 SSH 连接信息生成
- [x] 已实现 Jupyter 连接信息生成
- [ ] 实现 SSH 密钥管理
- [ ] 实现 Jupyter Token 管理

### 第二阶段 - 增强功能

#### 任务 2.1: 网络存储支持
- [ ] NFS 存储支持
  - [ ] NFS 服务器配置
  - [ ] 环境挂载 NFS
  - [ ] 数据持久化
- [ ] 对象存储支持
  - [ ] S3/MinIO 集成
  - [ ] 数据上传/下载
  - [ ] 数据集管理

#### 任务 2.2: 桌面环境支持
- [ ] VNC 支持
  - [ ] VNC 服务器安装
  - [ ] VNC 端口分配
  - [ ] VNC 密码生成
  - [ ] Web VNC 集成(noVNC)
- [ ] RDP 支持
  - [x] 已实现 RDP 连接信息生成
  - [ ] Windows 环境支持
  - [ ] RDP 端口分配

#### 任务 2.3: Jumpserver 可选集成
- [ ] Jumpserver 配置
- [ ] 环境注册到 Jumpserver
- [ ] 连接信息生成(通过 Jumpserver)
- [ ] 会话审计

### 第三阶段 - 高级功能

#### 任务 3.1: 虚拟机部署
- [ ] KVM 虚拟机创建
- [ ] 虚拟机模板管理
- [ ] 虚拟机快照

#### 任务 3.2: GPU 虚拟化
- [ ] vGPU 支持
- [ ] MIG 支持
- [ ] GPU 时间片共享

#### 任务 3.3: 分布式训练
- [ ] 多节点环境创建
- [ ] 网络配置(InfiniBand)
- [ ] MPI/Horovod 支持

## 四、技术选型

### 4.1 容器运行时
- **K8S**: 使用 Kubernetes API
- **Docker**: 使用 Docker SDK for Go
- **Podman**: 使用 Podman API

### 4.2 存储
- **NFS**: 使用 NFS 客户端挂载
- **Ceph**: 使用 Ceph RBD
- **S3**: 使用 AWS SDK 或 MinIO SDK

### 4.3 桌面环境
- **VNC**: TigerVNC, TurboVNC
- **noVNC**: Web VNC 客户端
- **RDP**: xrdp(Linux), 原生 RDP(Windows)

### 4.4 Jumpserver
- **版本**: Jumpserver v3.x
- **集成方式**: REST API
- **协议**: SSH, RDP, VNC

## 五、优先级排序

### P0 (必须完成)
1. K8S Pod 部署完善
2. 裸金属 Docker 部署
3. 独占 GPU 模式完善
4. SSH/Jupyter 访问完善

### P1 (重要)
1. NFS 存储支持
2. VNC 桌面环境
3. RDP 桌面环境(Windows)

### P2 (可选)
1. Jumpserver 集成
2. 对象存储支持
3. 虚拟机部署

### P3 (未来)
1. GPU 虚拟化
2. 分布式训练
3. 高级网络配置
