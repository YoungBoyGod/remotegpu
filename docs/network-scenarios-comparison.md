# 云服务器反向代理 - 网络场景方案对比

## 场景分类

根据本地网络环境，选择对应的连接方案。

---

## 场景1：有固定公网 IP + 无防火墙限制

**网络特征**：
- ✅ 有固定的公网 IP
- ✅ 可以开放端口
- ✅ 云服务器可以直接访问

**典型环境**：
- 企业专线
- IDC 机房
- 云服务器（如果 Backend 也在云上）

**解决方案**：直接连接
- 云服务器 nginx 直接代理到本地 IP
- 配置最简单
- 性能最好（无隧道开销）

**参考文档**：`scenario-1-direct-connection.md`

---

## 场景2：有出口 IP + 有防火墙

**网络特征**：
- ✅ 有出口 IP（固定或动态）
- ⚠️ 有防火墙阻止入站连接
- ❓ 可能有防火墙管理权限

**典型环境**：
- 企业内网
- 办公室网络
- 有安全策略的环境

### 方案2A：配置防火墙规则（推荐）

**前提**：有防火墙管理权限

**解决方案**：
- 在防火墙上开放特定端口（如 8080）
- 限制只允许云服务器 IP 访问
- 云服务器直接连接本地

**优点**：
- 配置简单
- 性能好（无隧道开销）
- 安全（限制访问 IP）

**参考文档**：`scenario-2a-firewall-rules.md`

### 方案2B：使用 frp 内网穿透

**前提**：无防火墙管理权限

**解决方案**：
- 本地主动连接云服务器（出站，防火墙通常允许）
- 通过 frp 隧道转发流量
- 绕过防火墙入站限制

**优点**：
- 无需修改防火墙
- 适用于受限环境

**缺点**：
- 有轻微性能损耗

**参考文档**：`scenario-2b-frp-tunnel.md`

---

## 场景3：NAT 后 + 无固定公网 IP

**网络特征**：
- ❌ 无固定公网 IP
- ❌ 在 NAT 后面
- ✅ 可以访问公网（出站）

**典型环境**：
- 家庭宽带
- 小型办公室
- 移动网络

**解决方案**：使用 frp 内网穿透
- 与场景2B 相同
- 本地主动连接云服务器
- 建立反向隧道

**参考文档**：`scenario-3-nat-frp.md`

---

## 场景4：完全内网 + 无公网访问

**网络特征**：
- ❌ 无公网 IP
- ❌ 无法访问公网（或严格限制）

**典型环境**：
- 高安全性内网
- 隔离网络

**解决方案**：
- VPN 专线（需要网络基础设施）
- 或部署独立的内网服务（不使用云服务器）

**参考文档**：`scenario-4-isolated-network.md`

---

## 快速决策

### 如何判断您的场景？

**测试1：是否有固定公网 IP？**
```bash
# 查看本地 IP
curl ifconfig.me

# 如果返回的 IP 与您的实际出口 IP 一致，说明有公网 IP
```

**测试2：防火墙是否阻止入站？**
```bash
# 在云服务器上测试
curl http://您的本地IP:8080/api/v1/health

# 如果无法访问，说明有防火墙或 NAT
```

**测试3：是否有防火墙管理权限？**
- 能否修改防火墙规则？
- 能否开放端口？

### 决策树

```
有固定公网 IP？
├─ 是 → 无防火墙？
│       ├─ 是 → 场景1（直接连接）
│       └─ 否 → 有防火墙权限？
│               ├─ 是 → 场景2A（配置防火墙）
│               └─ 否 → 场景2B（frp）
└─ 否 → 场景3（frp）或场景4（VPN/内网）
```

---

## 推荐方案

**根据您的情况选择**：

1. **企业专线/IDC** → 场景1（最优）
2. **企业内网（有权限）** → 场景2A
3. **企业内网（无权限）** → 场景2B
4. **家庭宽带/NAT** → 场景3
5. **隔离内网** → 场景4

---

## 性能对比

| 场景 | 延迟 | 带宽 | 稳定性 | 配置难度 |
|------|------|------|--------|----------|
| 场景1 | 最低 | 最高 | 最高 | 简单 |
| 场景2A | 低 | 高 | 高 | 简单 |
| 场景2B | 中 | 中 | 中 | 中等 |
| 场景3 | 中 | 中 | 中 | 中等 |
| 场景4 | 取决于VPN | 取决于VPN | 高 | 复杂 |

---

## 下一步

1. 确定您的网络场景
2. 阅读对应的详细文档
3. 按照文档步骤实施
