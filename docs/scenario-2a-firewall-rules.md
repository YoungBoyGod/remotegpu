# 场景2A：有出口 IP + 配置防火墙规则

## 适用环境

- ✅ 有出口 IP（固定或动态）
- ⚠️ 有防火墙阻止入站
- ✅ 有防火墙管理权限

**典型环境**：企业内网（有管理权限）

---

## 架构图

```
用户（全国）
  ↓
域名 → 云服务器（nginx）
  ↓
通过防火墙规则
  ↓
本地服务器（防火墙后）
  ↓
Backend + 200台 GPU
```

---

## 实施步骤

### 步骤1：确认出口 IP

**执行位置**：本地服务器

```bash
# 查看出口 IP
curl ifconfig.me

# 记录这个 IP
```

---

### 步骤2：配置防火墙规则

**执行位置**：防火墙管理界面或本地服务器

**规则配置**：
- 开放端口：8080
- 允许来源：云服务器 IP
- 目标：本地服务器 IP（192.168.10.210）

**示例（iptables）**：
```bash
# 允许云服务器访问 8080 端口
sudo iptables -A INPUT -s 云服务器IP -p tcp --dport 8080 -j ACCEPT

# 保存规则
sudo iptables-save > /etc/iptables/rules.v4
```

**示例（ufw）**：
```bash
sudo ufw allow from 云服务器IP to any port 8080
```

---

### 步骤3：测试连接

**执行位置**：云服务器

```bash
# 测试能否访问本地
curl http://本地出口IP:8080/api/v1/health
```

---

### 步骤4：配置 nginx

**执行位置**：云服务器

配置与场景1相同，将 `本地公网IP` 替换为 `本地出口IP`。

---

## 注意事项

- ⚠️ 如果出口 IP 是动态的，需要定期更新配置
- ⚠️ 确保防火墙规则正确，避免安全风险
- ✅ 建议使用 IP 白名单（只允许云服务器）
