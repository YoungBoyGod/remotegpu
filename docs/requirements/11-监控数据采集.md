# 监控数据采集

> 所属模块：模块 9 - 监控告警模块
>
> 功能编号：9.1
>
> 优先级：P0（必须）

---

## 1. 功能概述

### 1.1 功能描述

监控数据采集功能负责采集主机、GPU、环境的实时监控指标，包括 CPU、内存、磁盘、网络、GPU 使用率等，为监控告警和性能分析提供数据支持。

### 1.2 业务价值

- ✅ 实时监控系统资源使用情况
- ✅ 及时发现性能瓶颈和异常
- ✅ 为容量规划提供数据支持
- ✅ 支持历史数据查询和分析

---

## 2. 采集指标

### 2.1 主机指标

```yaml
主机监控指标:
  CPU:
    - cpu_usage_percent: CPU 使用率 (%)
    - cpu_load_1m: 1 分钟负载
    - cpu_load_5m: 5 分钟负载
    - cpu_load_15m: 15 分钟负载

  内存:
    - memory_used: 已用内存 (字节)
    - memory_available: 可用内存 (字节)
    - memory_usage_percent: 内存使用率 (%)

  磁盘:
    - disk_used: 已用磁盘 (字节)
    - disk_available: 可用磁盘 (字节)
    - disk_usage_percent: 磁盘使用率 (%)
    - disk_io_read_bytes: 磁盘读取 (字节/秒)
    - disk_io_write_bytes: 磁盘写入 (字节/秒)

  网络:
    - network_rx_bytes: 网络接收 (字节/秒)
    - network_tx_bytes: 网络发送 (字节/秒)
```

### 2.2 GPU 指标

```yaml
GPU 监控指标:
  使用率:
    - utilization_percent: GPU 使用率 (%)
    - memory_used: 显存使用 (字节)
    - memory_usage_percent: 显存使用率 (%)

  温度和功耗:
    - temperature: 温度 (℃)
    - power_draw: 功耗 (瓦)
    - fan_speed_percent: 风扇转速 (%)

  性能:
    - sm_clock: SM 时钟频率 (MHz)
    - memory_clock: 显存时钟频率 (MHz)
```

---

## 3. 采集实现

### 3.1 Agent 采集

```go
// 监控 Agent
type MonitorAgent struct {
    hostID   string
    interval time.Duration
}

// 启动采集
func (a *MonitorAgent) Start() {
    ticker := time.NewTicker(a.interval)
    go func() {
        for range ticker.C {
            // 采集主机指标
            hostMetrics := a.collectHostMetrics()
            a.sendMetrics(hostMetrics)

            // 采集 GPU 指标
            gpuMetrics := a.collectGPUMetrics()
            a.sendMetrics(gpuMetrics)
        }
    }()
}

// 采集主机指标
func (a *MonitorAgent) collectHostMetrics() *HostMetrics {
    metrics := &HostMetrics{
        HostID:      a.hostID,
        CollectedAt: time.Now(),
    }

    // CPU 使用率
    cpuPercent, _ := cpu.Percent(time.Second, false)
    metrics.CPUUsagePercent = cpuPercent[0]

    // 内存
    memInfo, _ := mem.VirtualMemory()
    metrics.MemoryUsed = memInfo.Used
    metrics.MemoryAvailable = memInfo.Available
    metrics.MemoryUsagePercent = memInfo.UsedPercent

    // 磁盘
    diskInfo, _ := disk.Usage("/")
    metrics.DiskUsed = diskInfo.Used
    metrics.DiskAvailable = diskInfo.Free
    metrics.DiskUsagePercent = diskInfo.UsedPercent

    return metrics
}
```

### 3.2 采集频率

| 指标类型 | 采集频率 | 保留时长 |
|---------|---------|---------|
| 主机指标 | 30 秒 | 7 天 |
| GPU 指标 | 30 秒 | 7 天 |
| 环境指标 | 1 分钟 | 7 天 |
| 聚合数据（小时） | 1 小时 | 90 天 |
| 聚合数据（天） | 1 天 | 1 年 |

---

## 4. 数据存储

### 4.1 时序数据库

**推荐方案：** Prometheus + Grafana

**数据模型：**
```yaml
# 主机 CPU 使用率
host_cpu_usage{host_id="host-abc123"} 45.5

# GPU 使用率
gpu_utilization{host_id="host-abc123",gpu_index="0"} 85.0
```

### 4.2 关系数据库

```sql
-- 主机监控数据表（用于查询和分析）
CREATE TABLE host_metrics (
    id BIGSERIAL PRIMARY KEY,
    host_id VARCHAR(64) NOT NULL,
    cpu_usage_percent FLOAT,
    memory_usage_percent FLOAT,
    disk_usage_percent FLOAT,
    collected_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_host_time (host_id, collected_at DESC)
);
```

---

## 5. API 接口

### 5.1 查询监控数据

```go
GET /api/metrics/hosts/:id
Query: start_time, end_time, metric

Response: {
  "metrics": [
    {
      "timestamp": "2026-01-26T10:00:00Z",
      "cpu_usage_percent": 45.5,
      "memory_usage_percent": 60.0
    }
  ]
}
```

---

## 6. 前端界面

```vue
<template>
  <el-card>
    <h3>监控数据</h3>

    <!-- 实时指标 -->
    <el-row :gutter="20">
      <el-col :span="6">
        <el-statistic title="CPU 使用率" :value="metrics.cpu" suffix="%" />
      </el-col>
      <el-col :span="6">
        <el-statistic title="内存使用率" :value="metrics.memory" suffix="%" />
      </el-col>
      <el-col :span="6">
        <el-statistic title="GPU 使用率" :value="metrics.gpu" suffix="%" />
      </el-col>
    </el-row>

    <!-- 历史趋势图 -->
    <div ref="chartRef" style="height: 400px; margin-top: 20px"></div>
  </el-card>
</template>
```

---

## 7. 测试用例

| 用例 | 场景 | 预期结果 |
|------|------|---------|
| TC-01 | Agent 采集数据 | 数据正常上报 |
| TC-02 | 查询历史数据 | 返回正确数据 |
| TC-03 | 采集失败 | 自动重试 |

---

**文档版本：** v1.0
**创建日期：** 2026-01-26
