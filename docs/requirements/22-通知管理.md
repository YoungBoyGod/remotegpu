# 通知管理

> 所属模块：模块 14 - 通知管理模块
>
> 功能编号：14.1
>
> 优先级：P1（重要）

---

## 1. 功能概述

### 1.1 功能描述

通知管理功能提供统一的消息通知服务，支持多种通知渠道（邮件、短信、钉钉、企业微信、Slack），用于系统告警、任务状态变更、审批流程等场景的消息推送。

### 1.2 业务价值

- ✅ 统一的通知管理平台
- ✅ 支持多种通知渠道
- ✅ 通知模板管理
- ✅ 通知历史记录和追溯

---

## 2. 通知渠道

### 2.1 支持的通知方式

| 渠道 | 说明 | 适用场景 |
|------|------|---------|
| 邮件 | SMTP 邮件通知 | 正式通知、报告 |
| 短信 | 阿里云/腾讯云短信 | 紧急告警 |
| 钉钉 | 钉钉机器人 | 团队协作 |
| 企业微信 | 企业微信机器人 | 企业内部通知 |
| Slack | Slack Webhook | 国际团队 |
| 站内信 | 系统内消息 | 普通通知 |

---

## 3. 数据模型

```sql
-- 通知模板表
CREATE TABLE notification_templates (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(128) NOT NULL,
    template_type VARCHAR(32) NOT NULL,
    channel VARCHAR(32) NOT NULL,
    subject VARCHAR(256),
    content TEXT NOT NULL,
    variables JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 通知记录表
CREATE TABLE notifications (
    id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL,
    template_id BIGINT,
    channel VARCHAR(32) NOT NULL,
    recipient VARCHAR(256) NOT NULL,
    subject VARCHAR(256),
    content TEXT NOT NULL,
    status VARCHAR(32) DEFAULT 'pending',
    sent_at TIMESTAMP,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (customer_id) REFERENCES customers(id)
);
```

---

## 4. 通知服务实现

### 4.1 通知发送器

```go
// 通知发送器
type NotificationSender struct {
    emailSender   *EmailSender
    smsSender     *SMSSender
    dingTalkSender *DingTalkSender
    wechatSender  *WeChatSender
}

// 发送通知
func (s *NotificationSender) Send(notification *Notification) error {
    switch notification.Channel {
    case "email":
        return s.emailSender.Send(notification)
    case "sms":
        return s.smsSender.Send(notification)
    case "dingtalk":
        return s.dingTalkSender.Send(notification)
    case "wechat":
        return s.wechatSender.Send(notification)
    default:
        return errors.New("不支持的通知渠道")
    }
}
```

---

## 5. API 接口

### 5.1 发送通知

```go
POST /api/notifications/send
Body: {
  "channel": "email",
  "recipient": "user@example.com",
  "subject": "任务完成通知",
  "content": "您的训练任务已完成"
}

Response: {
  "notification_id": 123,
  "status": "sent"
}
```

---

## 6. 测试用例

| 用例 | 场景 | 预期结果 |
|------|------|---------|
| TC-01 | 发送邮件通知 | 邮件发送成功 |
| TC-02 | 发送钉钉通知 | 钉钉消息推送成功 |

---

**文档版本：** v1.0
**创建日期：** 2026-01-26
