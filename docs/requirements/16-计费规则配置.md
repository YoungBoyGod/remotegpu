# 计费规则配置

> 所属模块：模块 10 - 计费管理模块
>
> 功能编号：10.1
>
> 优先级：P1（重要）

---

## 1. 功能概述

### 1.1 功能描述

计费规则配置功能提供灵活的计费策略管理，支持按资源类型、使用时长、流量等多维度计费，为平台运营提供收入管理能力。

### 1.2 业务价值

- ✅ 灵活的计费策略配置
- ✅ 支持多种计费模式
- ✅ 自动计费和账单生成
- ✅ 成本核算和利润分析

---

## 2. 计费模式

### 2.1 计费类型

| 计费类型 | 说明 | 适用场景 |
|---------|------|---------|
| 按量计费 | 按实际使用量计费 | 临时使用、测试环境 |
| 包年包月 | 固定周期固定价格 | 长期稳定使用 |
| 预付费 | 预先充值，按量扣费 | 企业用户 |
| 后付费 | 先使用后付费 | 信用良好的用户 |

### 2.2 计费维度

```yaml
计费维度:
  计算资源:
    - CPU: 按核心数 × 小时
    - 内存: 按 GB × 小时
    - GPU: 按卡数 × 小时（不同型号价格不同）

  存储资源:
    - 数据集存储: 按 GB × 天
    - 模型存储: 按 GB × 天
    - 快照存储: 按 GB × 天

  网络资源:
    - 公网流量: 按 GB
    - 带宽: 按 Mbps × 小时
```

---

## 3. 数据模型

```sql
-- 计费规则表
CREATE TABLE billing_rules (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(128) NOT NULL,
    description TEXT,

    -- 规则类型
    rule_type VARCHAR(32) NOT NULL, -- 'pay_as_you_go', 'subscription', 'prepaid'

    -- 资源类型
    resource_type VARCHAR(32) NOT NULL, -- 'cpu', 'memory', 'gpu', 'storage', 'network'
    resource_spec VARCHAR(64), -- GPU 型号等

    -- 价格配置
    unit_price DECIMAL(10, 4) NOT NULL, -- 单价
    unit VARCHAR(32) NOT NULL, -- 'core_hour', 'gb_hour', 'gb_day', 'gb'
    currency VARCHAR(8) DEFAULT 'CNY',

    -- 折扣配置
    discount_rate DECIMAL(5, 2) DEFAULT 0, -- 折扣率 (0-100)
    min_charge DECIMAL(10, 2) DEFAULT 0, -- 最低消费

    -- 状态
    status VARCHAR(20) DEFAULT 'active',
    effective_from TIMESTAMP,
    effective_to TIMESTAMP,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 用户账单表
CREATE TABLE billing_records (
    id BIGSERIAL PRIMARY KEY,
    customer_id BIGINT NOT NULL,
    workspace_id BIGINT,

    -- 计费信息
    resource_type VARCHAR(32) NOT NULL,
    resource_id VARCHAR(64),
    rule_id BIGINT,

    -- 用量信息
    quantity DECIMAL(12, 4) NOT NULL, -- 使用量
    unit_price DECIMAL(10, 4) NOT NULL,
    amount DECIMAL(12, 2) NOT NULL, -- 金额

    -- 时间范围
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,

    -- 状态
    status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'confirmed', 'paid'

    created_at TIMESTAMP DEFAULT NOW(),

    FOREIGN KEY (customer_id) REFERENCES customers(id),
    FOREIGN KEY (rule_id) REFERENCES billing_rules(id)
);
```

---

## 4. 计费引擎实现

### 4.1 计费引擎

```go
// 计费引擎
type BillingEngine struct {
    db *gorm.DB
}

// 计算资源费用
func (e *BillingEngine) CalculateCost(req BillingRequest) (*BillingRecord, error) {
    // 1. 查询适用的计费规则
    var rule BillingRule
    err := e.db.Where("resource_type = ? AND status = 'active'", req.ResourceType).
        Where("effective_from <= ? AND (effective_to IS NULL OR effective_to >= ?)",
            time.Now(), time.Now()).
        First(&rule).Error

    if err != nil {
        return nil, errors.New("未找到适用的计费规则")
    }

    // 2. 计算使用量
    quantity := e.calculateQuantity(req, rule.Unit)

    // 3. 计算金额
    amount := quantity * float64(rule.UnitPrice)

    // 4. 应用折扣
    if rule.DiscountRate > 0 {
        amount = amount * (1 - float64(rule.DiscountRate)/100)
    }

    // 5. 检查最低消费
    if amount < float64(rule.MinCharge) {
        amount = float64(rule.MinCharge)
    }

    // 6. 创建账单记录
    record := &BillingRecord{
        CustomerID:   req.CustomerID,
        WorkspaceID:  req.WorkspaceID,
        ResourceType: req.ResourceType,
        ResourceID:   req.ResourceID,
        RuleID:       rule.ID,
        Quantity:     quantity,
        UnitPrice:    rule.UnitPrice,
        Amount:       amount,
        StartTime:    req.StartTime,
        EndTime:      req.EndTime,
        Status:       "pending",
    }

    if err := e.db.Create(record).Error; err != nil {
        return nil, err
    }

    return record, nil
}

// 计算使用量
func (e *BillingEngine) calculateQuantity(req BillingRequest, unit string) float64 {
    duration := req.EndTime.Sub(req.StartTime).Hours()

    switch unit {
    case "core_hour":
        return float64(req.CPUCores) * duration
    case "gb_hour":
        return float64(req.MemoryGB) * duration
    case "gpu_hour":
        return float64(req.GPUCount) * duration
    case "gb_day":
        return float64(req.StorageGB) * (duration / 24)
    case "gb":
        return float64(req.TrafficGB)
    default:
        return 0
    }
}
```

---

## 5. API 接口

### 5.1 创建计费规则

```go
POST /api/billing/rules
Body: {
  "name": "GPU RTX 4090 按小时计费",
  "rule_type": "pay_as_you_go",
  "resource_type": "gpu",
  "resource_spec": "RTX 4090",
  "unit_price": 5.00,
  "unit": "gpu_hour",
  "currency": "CNY"
}

Response: {
  "rule_id": 1,
  "status": "active"
}
```

### 5.2 查询计费规则

```go
GET /api/billing/rules
Query: resource_type, status

Response: {
  "rules": [
    {
      "id": 1,
      "name": "GPU RTX 4090 按小时计费",
      "resource_type": "gpu",
      "unit_price": 5.00,
      "unit": "gpu_hour",
      "status": "active"
    }
  ]
}
```

### 5.3 查询账单记录

```go
GET /api/billing/records
Query: start_date, end_date, status

Response: {
  "records": [
    {
      "id": 1,
      "resource_type": "gpu",
      "quantity": 10.5,
      "amount": 52.50,
      "status": "pending",
      "created_at": "2026-01-26T10:00:00Z"
    }
  ],
  "total_amount": 52.50
}
```

---

## 6. 前端界面

```vue
<template>
  <el-card>
    <h3>计费规则管理</h3>

    <el-button type="primary" @click="showCreateDialog">
      创建计费规则
    </el-button>

    <el-table :data="rules" style="margin-top: 20px">
      <el-table-column prop="name" label="规则名称" />
      <el-table-column prop="resource_type" label="资源类型" />
      <el-table-column label="单价">
        <template #default="{ row }">
          ¥{{ row.unit_price }} / {{ row.unit }}
        </template>
      </el-table-column>
      <el-table-column prop="status" label="状态">
        <template #default="{ row }">
          <el-tag :type="row.status === 'active' ? 'success' : 'info'">
            {{ row.status }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button size="small" @click="editRule(row)">
            编辑
          </el-button>
          <el-button size="small" type="danger" @click="deleteRule(row)">
            删除
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </el-card>
</template>

<script setup>
import { ref, onMounted } from 'vue'

const rules = ref([])

const loadRules = async () => {
  const response = await fetch('/api/billing/rules')
  rules.value = await response.json()
}

onMounted(() => {
  loadRules()
})
</script>
```

---

## 7. 测试用例

| 用例 | 场景 | 预期结果 |
|------|------|---------|
| TC-01 | 创建计费规则 | 规则创建成功 |
| TC-02 | 计算 GPU 使用费用 | 费用计算正确 |
| TC-03 | 应用折扣 | 折扣计算正确 |
| TC-04 | 最低消费检查 | 低于最低消费时按最低消费计算 |
| TC-05 | 查询账单记录 | 返回正确的账单列表 |

---

**文档版本：** v1.0
**创建日期：** 2026-01-26
