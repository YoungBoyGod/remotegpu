# 主机注册与发现

> 所属模块：模块 1 - CMDB 设备管理模块
>
> 功能编号：1.1
>
> 优先级：P0（必须）

---

## 1. 功能概述

### 1.1 功能描述

主机注册与发现功能负责将物理服务器或虚拟机纳入 CMDB 管理系统，自动或手动采集主机的硬件配置信息、操作系统信息和部署模式，为后续的资源调度和环境管理提供基础数据。

### 1.2 业务价值

- ✅ 自动化设备接入，减少人工配置工作量
- ✅ 统一管理 Linux 和 Windows 主机
- ✅ 准确采集硬件信息，为资源调度提供依据
- ✅ 支持传统架构和 Kubernetes 架构

### 1.3 适用场景

- 新购服务器上线
- 虚拟机创建后自动注册
- 批量导入已有服务器
- Kubernetes 节点自动发现

---

## 2. 功能需求

### 2.1 自动发现主机

**需求描述：**
通过 Agent 心跳机制自动发现新主机，无需手动配置。

**实现方式：**
1. 在主机上部署 Worker Agent
2. Agent 启动后向 Master 发送注册请求
3. Master 接收请求并创建主机记录
4. Agent 定期发送心跳（30 秒间隔）

**接口定义：**
```go
// Agent 注册接口
POST /api/cmdb/hosts/register
Body: {
  "hostname": "gpu-server-01",
  "ip_address": "192.168.1.10",
  "os_type": "linux",
  "os_version": "Ubuntu 20.04",
  "agent_version": "1.0.0"
}
Response: {
  "host_id": "host-abc123",
  "status": "registered"
}
```

**验收标准：**
- [ ] Agent 启动后 10 秒内完成注册
- [ ] 注册失败时自动重试（最多 3 次）
- [ ] 重复注册时返回已有 host_id

### 2.2 手动注册主机

**需求描述：**
管理员通过 Web 界面手动添加主机，填写 IP 地址和 SSH 凭证。

**实现方式：**
1. 管理员在前端填写主机信息
2. 后端验证 SSH 连通性
3. 通过 SSH 采集主机信息
4. 创建主机记录

**接口定义：**
```go
// 手动注册接口
POST /api/cmdb/hosts
Body: {
  "name": "GPU-Server-01",
  "ip_address": "192.168.1.10",
  "ssh_port": 22,
  "ssh_username": "root",
  "ssh_password": "encrypted_password",
  "tags": ["production", "gpu-server"]
}
Response: {
  "host_id": "host-abc123",
  "status": "success"
}
```

**验收标准：**
- [ ] SSH 连通性验证（5 秒超时）
- [ ] 支持密码和密钥两种认证方式
- [ ] 密码加密存储
- [ ] 注册失败时返回明确错误信息

### 2.3 主机信息采集

**需求描述：**
自动采集主机的硬件配置信息，包括 CPU、内存、磁盘、网络等。

**采集项清单：**

| 采集项 | Linux 命令 | Windows 命令 |
|--------|-----------|-------------|
| CPU 核心数 | `nproc` | `(Get-WmiObject Win32_Processor).NumberOfLogicalProcessors` |
| 内存总量 | `free -b \| grep Mem \| awk '{print $2}'` | `(Get-WmiObject Win32_ComputerSystem).TotalPhysicalMemory` |
| 磁盘总量 | `df -B1 / \| tail -1 \| awk '{print $2}'` | `(Get-WmiObject Win32_LogicalDisk -Filter "DeviceID='C:'").Size` |
| 操作系统 | `cat /etc/os-release` | `(Get-WmiObject Win32_OperatingSystem).Caption` |
| 主机名 | `hostname` | `$env:COMPUTERNAME` |

**接口定义：**
```go
// 内部函数：采集主机信息
func CollectHostInfo(ipAddress string, sshClient *ssh.Client) (*HostInfo, error) {
    info := &HostInfo{}

    // 采集 CPU
    output, _ := sshClient.Run("nproc")
    info.CPUCores, _ = strconv.Atoi(strings.TrimSpace(output))

    // 采集内存
    output, _ = sshClient.Run("free -b | grep Mem | awk '{print $2}'")
    info.TotalMemory, _ = strconv.ParseInt(strings.TrimSpace(output), 10, 64)

    // ... 其他采集逻辑

    return info, nil
}
```

**验收标准：**
- [ ] 所有必需信息采集成功率 > 99%
- [ ] 采集耗时 < 10 秒
- [ ] 采集失败时记录详细错误日志
- [ ] 支持 Linux 和 Windows 双平台

### 2.4 操作系统识别

**需求描述：**
自动识别主机的操作系统类型和版本。

**支持的操作系统：**
- Linux: Ubuntu 18.04/20.04/22.04, CentOS 7/8, Debian 10/11
- Windows: Windows Server 2019/2022

**识别逻辑：**
```go
func DetectOSType(sshClient *ssh.Client) (string, string, error) {
    // 尝试 Linux 识别
    output, err := sshClient.Run("cat /etc/os-release")
    if err == nil {
        // 解析 os-release 文件
        osType := "linux"
        osVersion := parseOSRelease(output)
        return osType, osVersion, nil
    }

    // 尝试 Windows 识别
    output, err = sshClient.Run("systeminfo | findstr /B /C:\"OS Name\"")
    if err == nil {
        osType := "windows"
        osVersion := parseSystemInfo(output)
        return osType, osVersion, nil
    }

    return "", "", errors.New("unsupported OS")
}
```

**验收标准：**
- [ ] 支持所有列出的操作系统版本
- [ ] 识别准确率 100%
- [ ] 不支持的系统返回明确错误

### 2.5 部署模式识别

**需求描述：**
识别主机的部署模式（传统架构 Docker 或 Kubernetes）。

**识别规则：**
1. 检查是否安装 Docker: `docker --version`
2. 检查是否为 K8s 节点: `kubectl get nodes`
3. 检查 kubelet 进程: `systemctl status kubelet`

**识别逻辑：**
```go
func DetectDeploymentMode(sshClient *ssh.Client) string {
    // 检查 Kubernetes
    _, err := sshClient.Run("kubectl get nodes")
    if err == nil {
        return "kubernetes"
    }

    // 检查 Docker
    _, err = sshClient.Run("docker --version")
    if err == nil {
        return "traditional"
    }

    return "unknown"
}
```

**验收标准：**
- [ ] 正确识别 Kubernetes 节点
- [ ] 正确识别 Docker 主机
- [ ] 未安装容器运行时时标记为 unknown

---

## 3. 数据模型

### 3.1 主机表 (hosts)

```sql
CREATE TABLE hosts (
    id VARCHAR(64) PRIMARY KEY,
    name VARCHAR(128) NOT NULL,
    hostname VARCHAR(256),
    ip_address VARCHAR(64) NOT NULL,
    public_ip VARCHAR(64),

    -- 操作系统信息
    os_type VARCHAR(20) NOT NULL,           -- linux, windows
    os_version VARCHAR(64),                 -- Ubuntu 20.04, Windows Server 2022
    arch VARCHAR(20) DEFAULT 'x86_64',      -- x86_64, arm64

    -- 部署模式
    deployment_mode VARCHAR(20) NOT NULL,   -- traditional, kubernetes
    k8s_node_name VARCHAR(128),

    -- 状态
    status VARCHAR(20) DEFAULT 'offline',   -- online, offline, maintenance
    health_status VARCHAR(20) DEFAULT 'unknown',

    -- 资源信息
    total_cpu INT NOT NULL,
    total_memory BIGINT NOT NULL,
    total_disk BIGINT,
    total_gpu INT DEFAULT 0,

    -- 网络信息
    ssh_port INT DEFAULT 22,
    agent_port INT DEFAULT 8080,

    -- 标签
    tags TEXT[],
    labels JSONB,

    -- 时间戳
    last_heartbeat TIMESTAMP,
    registered_at TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    INDEX idx_os_type (os_type),
    INDEX idx_status (status),
    INDEX idx_deployment_mode (deployment_mode)
);
```

---

## 4. API 接口

### 4.1 Agent 自动注册

```go
// POST /api/cmdb/hosts/register
func RegisterHost(c *gin.Context) {
    var req struct {
        Hostname     string `json:"hostname"`
        IPAddress    string `json:"ip_address"`
        OSType       string `json:"os_type"`
        OSVersion    string `json:"os_version"`
        AgentVersion string `json:"agent_version"`
    }

    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(400, gin.H{"error": err.Error()})
        return
    }

    // 检查是否已注册
    var existingHost Host
    if db.Where("ip_address = ?", req.IPAddress).First(&existingHost).Error == nil {
        c.JSON(200, gin.H{
            "host_id": existingHost.ID,
            "status":  "already_registered",
        })
        return
    }

    // 创建新主机
    host := &Host{
        ID:             GenerateHostID(),
        Hostname:       req.Hostname,
        IPAddress:      req.IPAddress,
        OSType:         req.OSType,
        OSVersion:      req.OSVersion,
        Status:         "online",
        RegisteredAt:   time.Now(),
    }

    if err := db.Create(host).Error; err != nil {
        c.JSON(500, gin.H{"error": "注册失败"})
        return
    }

    c.JSON(200, gin.H{
        "host_id": host.ID,
        "status":  "registered",
    })
}
```

### 4.2 手动注册主机

```go
// POST /api/cmdb/hosts
func CreateHost(c *gin.Context) {
    var req struct {
        Name         string   `json:"name" binding:"required"`
        IPAddress    string   `json:"ip_address" binding:"required"`
        SSHPort      int      `json:"ssh_port"`
        SSHUsername  string   `json:"ssh_username"`
        SSHPassword  string   `json:"ssh_password"`
        Tags         []string `json:"tags"`
    }

    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(400, gin.H{"error": err.Error()})
        return
    }

    // 验证 SSH 连通性
    sshClient, err := ssh.Connect(req.IPAddress, req.SSHPort, req.SSHUsername, req.SSHPassword)
    if err != nil {
        c.JSON(400, gin.H{"error": "SSH 连接失败: " + err.Error()})
        return
    }
    defer sshClient.Close()

    // 采集主机信息
    hostInfo, err := CollectHostInfo(req.IPAddress, sshClient)
    if err != nil {
        c.JSON(500, gin.H{"error": "信息采集失败: " + err.Error()})
        return
    }

    // 创建主机记录
    host := &Host{
        ID:             GenerateHostID(),
        Name:           req.Name,
        IPAddress:      req.IPAddress,
        OSType:         hostInfo.OSType,
        OSVersion:      hostInfo.OSVersion,
        TotalCPU:       hostInfo.CPUCores,
        TotalMemory:    hostInfo.TotalMemory,
        TotalDisk:      hostInfo.TotalDisk,
        DeploymentMode: hostInfo.DeploymentMode,
        Tags:           req.Tags,
        Status:         "online",
    }

    if err := db.Create(host).Error; err != nil {
        c.JSON(500, gin.H{"error": "创建失败"})
        return
    }

    c.JSON(200, gin.H{
        "host_id": host.ID,
        "status":  "success",
    })
}
```

---

## 5. 前端界面

### 5.1 主机注册页面

**页面路径：** `/cmdb/hosts/register`

**页面组件：** `HostRegister.vue`

**功能要求：**
```vue
<template>
  <el-card>
    <h2>注册新主机</h2>

    <el-tabs v-model="registerMode">
      <!-- 自动注册说明 -->
      <el-tab-pane label="自动注册" name="auto">
        <el-alert type="info" :closable="false">
          <p>在目标主机上执行以下命令安装 Agent：</p>
          <el-code>
            curl -fsSL https://releases.example.com/install.sh | bash
          </el-code>
          <p>Agent 启动后将自动注册到系统</p>
        </el-alert>
      </el-tab-pane>

      <!-- 手动注册表单 -->
      <el-tab-pane label="手动注册" name="manual">
        <el-form :model="form" :rules="rules" ref="formRef">
          <el-form-item label="主机名称" prop="name">
            <el-input v-model="form.name" placeholder="GPU-Server-01" />
          </el-form-item>

          <el-form-item label="IP 地址" prop="ip_address">
            <el-input v-model="form.ip_address" placeholder="192.168.1.10" />
          </el-form-item>

          <el-form-item label="SSH 端口" prop="ssh_port">
            <el-input-number v-model="form.ssh_port" :min="1" :max="65535" />
          </el-form-item>

          <el-form-item label="SSH 用户名" prop="ssh_username">
            <el-input v-model="form.ssh_username" placeholder="root" />
          </el-form-item>

          <el-form-item label="SSH 密码" prop="ssh_password">
            <el-input v-model="form.ssh_password" type="password" show-password />
          </el-form-item>

          <el-form-item label="标签">
            <el-select v-model="form.tags" multiple placeholder="选择标签">
              <el-option label="生产环境" value="production" />
              <el-option label="测试环境" value="testing" />
              <el-option label="GPU 服务器" value="gpu-server" />
            </el-select>
          </el-form-item>

          <el-form-item>
            <el-button type="primary" @click="submitForm" :loading="loading">
              注册主机
            </el-button>
          </el-form-item>
        </el-form>
      </el-tab-pane>
    </el-tabs>
  </el-card>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { ElMessage } from 'element-plus';
import { createHost } from '@/api/cmdb';

const registerMode = ref('auto');
const loading = ref(false);
const formRef = ref();

const form = reactive({
  name: '',
  ip_address: '',
  ssh_port: 22,
  ssh_username: 'root',
  ssh_password: '',
  tags: []
});

const rules = {
  name: [{ required: true, message: '请输入主机名称' }],
  ip_address: [
    { required: true, message: '请输入 IP 地址' },
    { pattern: /^(\d{1,3}\.){3}\d{1,3}$/, message: 'IP 地址格式不正确' }
  ],
  ssh_username: [{ required: true, message: '请输入 SSH 用户名' }],
  ssh_password: [{ required: true, message: '请输入 SSH 密码' }]
};

const submitForm = async () => {
  await formRef.value.validate();

  loading.value = true;
  try {
    const res = await createHost(form);
    ElMessage.success('主机注册成功');
    // 跳转到主机详情页
    router.push(`/cmdb/hosts/${res.host_id}`);
  } catch (error) {
    ElMessage.error(error.message || '注册失败');
  } finally {
    loading.value = false;
  }
};
</script>
```

---

## 6. 测试用例

### 6.1 自动注册测试

| 用例编号 | 测试场景 | 预期结果 |
|---------|---------|---------|
| TC-01 | Agent 首次注册 | 返回新的 host_id，状态为 registered |
| TC-02 | Agent 重复注册 | 返回已有 host_id，状态为 already_registered |
| TC-03 | 注册请求缺少必填字段 | 返回 400 错误 |
| TC-04 | 并发注册同一主机 | 只创建一条记录 |

### 6.2 手动注册测试

| 用例编号 | 测试场景 | 预期结果 |
|---------|---------|---------|
| TC-05 | SSH 连接成功 | 成功采集信息并创建主机 |
| TC-06 | SSH 连接失败 | 返回明确错误信息 |
| TC-07 | SSH 密码错误 | 返回认证失败错误 |
| TC-08 | 主机信息采集失败 | 返回采集失败错误 |
| TC-09 | IP 地址已存在 | 返回重复注册错误 |

---

## 7. 实施计划

### 7.1 开发任务

| 任务 | 工作量 | 负责人 | 状态 |
|------|--------|--------|------|
| 数据库表设计 | 0.5 天 | 后端 | 待开始 |
| Agent 注册 API | 1 天 | 后端 | 待开始 |
| 手动注册 API | 2 天 | 后端 | 待开始 |
| 信息采集模块 | 2 天 | 后端 | 待开始 |
| 前端注册页面 | 2 天 | 前端 | 待开始 |
| 单元测试 | 1 天 | 后端 | 待开始 |
| 集成测试 | 1 天 | 测试 | 待开始 |

**总工作量：** 9.5 天

### 7.2 里程碑

- [ ] M1: 数据库表创建完成（第 1 天）
- [ ] M2: Agent 注册功能完成（第 2 天）
- [ ] M3: 手动注册功能完成（第 4 天）
- [ ] M4: 前端页面完成（第 6 天）
- [ ] M5: 测试完成，功能上线（第 10 天）

---

## 8. 风险与依赖

### 8.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| SSH 连接超时 | 注册失败 | 设置合理超时时间（5 秒），提供重试机制 |
| 不同 Linux 发行版命令差异 | 信息采集失败 | 针对主流发行版适配命令 |
| Windows SSH 支持问题 | Windows 主机无法注册 | 提供 WinRM 备选方案 |

### 8.2 依赖项

- 无外部模块依赖（基础功能）
- 需要数据库服务（PostgreSQL）
- 需要 SSH 客户端库（golang.org/x/crypto/ssh）

---

## 9. 验收标准

### 9.1 功能验收

- [ ] 支持 Agent 自动注册
- [ ] 支持手动注册主机
- [ ] 支持 Linux 和 Windows 双平台
- [ ] 信息采集准确率 > 99%
- [ ] 注册成功率 > 99%

### 9.2 性能验收

- [ ] Agent 注册响应时间 < 1 秒
- [ ] 手动注册响应时间 < 10 秒
- [ ] 支持并发注册 100 台主机

### 9.3 安全验收

- [ ] SSH 密码加密存储
- [ ] 注册接口有权限控制
- [ ] 防止 SQL 注入攻击

---

**文档版本：** v1.0
**创建日期：** 2026-01-26
**最后更新：** 2026-01-26
