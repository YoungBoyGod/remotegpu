# 远程客户支持平台 — 需求分析文档

> 版本：v1.0 | 日期：2026-02-06 | 作者：产品经理

## 1. 项目背景与目标

### 1.1 项目背景

RemoteGPU 是一个 GPU 远程管理平台，面向需要高性能计算资源的企业客户，提供 GPU 机器的远程租赁、管理和使用服务。平台的核心场景是：**客户通过 SSH/VNC/RDP 等协议远程访问内部 GPU 机器，执行 AI 训练、推理等计算任务**。

当前平台已完成基础功能闭环（登录鉴权、机器管理、客户管理、任务管理、监控告警），需要进一步完善远程访问能力、权限管理、会话管理和审计合规等核心功能。

### 1.2 项目目标

- 为客户提供安全、稳定、便捷的远程 GPU 资源访问体验
- 为交付团队提供高效的资源分配与管理工具
- 为运维团队提供完善的监控、告警和审计能力
- 满足企业级安全合规要求

### 1.3 项目范围

本文档覆盖以下核心模块的需求分析：
- 用户与权限管理
- 机器资源管理
- 远程访问服务（SSH/VNC/RDP）
- 任务管理
- 会话管理与审计
- 监控与告警
- 系统配置与运维

---

## 2. 目标用户与角色

### 2.1 角色定义

| 角色 | 标识 | 说明 |
|------|------|------|
| 平台管理员 | `admin` | 内部运维/交付人员，拥有全部管理权限 |
| 客户负责人 | `customer_owner` | 客户方主账号，管理本公司资源和子账号 |
| 客户成员 | `customer_member` | 客户方普通成员，使用分配的资源 |

### 2.2 用户画像

**平台管理员（交付团队 / 运维团队）**
- 负责机器上架、硬件信息采集、资源分配与回收
- 管理客户账号的创建、禁用、密码重置
- 配置远程访问策略（域名、端口、协议）
- 监控机器状态、GPU 利用率、告警处理
- 查看审计日志，排查安全事件

**客户负责人**
- 查看本公司分配的机器列表和使用情况
- 管理 SSH 密钥，配置远程连接
- 创建和管理训练/推理任务
- 管理数据集的上传和挂载
- 查看本公司的操作记录

**客户成员**
- 使用分配的机器执行计算任务
- 通过 SSH/VNC/RDP 远程连接机器
- 管理个人 SSH 密钥
- 查看自己的任务状态

---

## 3. 核心功能需求

### 3.1 用户与认证管理

#### 3.1.1 登录与鉴权

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 用户名密码登录 | P0 | 已完成 | 支持区分密码错误/账号不存在/账号禁用 |
| JWT Token 鉴权 | P0 | 已完成 | access_token + refresh_token 双令牌机制 |
| Token 刷新 | P0 | 已完成 | refresh_token 存储于 Redis，支持过期清理 |
| 登出与黑名单 | P0 | 已完成 | 登出后 token 立即失效，Redis 黑名单校验 |
| 首次登录强制改密 | P0 | 已完成 | `must_change_password` 标记，前端路由守卫拦截 |
| 账号状态统一校验 | P0 | 已完成 | 登录和中间件统一校验 `status=active` |

#### 3.1.2 权限管理

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 角色权限隔离 | P0 | 已完成 | Admin 与 Customer 路由严格隔离 |
| 管理员权限中间件 | P0 | 已完成 | `RequireAdmin()` 保护 `/admin/*` 路由 |
| 资源归属校验 | P1 | 已完成 | 客户只能访问自己分配的机器/任务/数据集 |
| 多租户数据隔离 | P1 | 已完成 | 通过 JWT 中的 userID 实现数据过滤 |

#### 3.1.3 客户账号管理

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 创建客户 | P1 | 已完成 | 必填：用户名、公司代号、邮箱；可选：密码、电话 |
| 客户列表 | P1 | 已完成 | 分页、搜索、全局序号、按创建时间排序 |
| 禁用/启用客户 | P1 | 已完成 | 防止禁用当前登录账号 |
| 默认密码机制 | P1 | 已完成 | 默认密码 `ChangeME_123`，触发强制改密 |

### 3.2 机器资源管理

#### 3.2.1 机器生命周期

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 添加机器 | P1 | 已完成 | 填写基础信息和 SSH 登录信息，自动采集硬件配置 |
| 批量导入 | P1 | 已完成 | JSON 格式批量导入 |
| 硬件信息采集 | P1 | 已完成 | 通过 Agent 采集 CPU/内存/磁盘/GPU 信息 |
| 补采硬件信息 | P1 | 已完成 | `needs_collect` 标记，管理员手动触发 |
| 机器列表与筛选 | P1 | 已完成 | 按状态/区域/GPU 型号筛选 |
| 机器详情 | P1 | 已完成 | 硬件信息、GPU 列表、分配记录、远程访问配置 |

#### 3.2.2 资源分配与回收

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 分配机器 | P1 | 已完成 | 选择客户 + 设置租期，状态检查 + 事务处理 |
| 回收机器 | P1 | 已完成 | 确认提示、审计日志记录 |
| 分配后异步动作 | P2 | 已完成 | 重置 SSH、清理环境 |
| 到期自动回收 | P2 | 待开发 | 租期到期后自动触发回收流程 |

#### 3.2.3 机器状态模型

```
online → allocated（分配给客户）
allocated → online（回收后恢复）
online/allocated → maintenance（维护模式）
maintenance → online（维护完成）
任意状态 → offline（心跳超时或手动下线）
```

### 3.3 远程访问服务

#### 3.3.1 SSH 远程访问

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| SSH 密钥管理 | P1 | 已完成 | 支持 rsa/ed25519/ecdsa，SHA256 指纹去重 |
| SSH 连接信息展示 | P1 | 已完成 | 客户端展示连接地址、端口、用户名 |
| SSH 密码重置 | P1 | 已完成 | 客户可触发 SSH 密码重置 |
| SSH 密钥自动注入 | P2 | 待开发 | 分配机器时自动注入客户的 SSH 公钥 |

#### 3.3.2 VNC/RDP 远程桌面访问

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| VNC 远程桌面 | P2 | 待开发 | 通过 Web 浏览器访问机器桌面环境 |
| RDP 远程桌面 | P2 | 待开发 | Windows 远程桌面协议支持 |
| Guacamole 集成 | P2 | 待开发 | 统一的 Web 远程访问网关 |
| 远程访问配置管理 | P2 | 部分完成 | 域名、端口、协议配置（前端已实现，后端待对接） |

#### 3.3.3 远程访问配置

已设计的配置字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| `enabled` | bool | 是否启用对外访问 |
| `protocol` | string | tcp/http/https/ssh |
| `public_domain` | string | 对外访问域名（自动生成格式：`<slug>.<base_domain>`） |
| `public_port` | int | 对外开放端口 |
| `target_port` | int | 目标服务端口（反向代理映射） |
| `extra_ports` | string | 额外开放端口列表（VNC/TensorBoard 等） |

默认端口映射规则：

| 服务 | 目标端口 | 公网端口 |
|------|----------|----------|
| SSH | 22 | 2222 |
| HTTP | 80 | 8080 |
| HTTPS | 443 | 8443 |
| RDP | 3389 | 13389 |
| VNC | 5900 | 15900 |
| TensorBoard | 6006 | 16006 |
| Jupyter | 8888 | 18888 |

#### 3.3.4 Nginx 反向代理对接

- 后端生成 Nginx 配置片段（server/location/upstream）
- 写入配置目录并触发 reload
- 域名唯一 + 端口唯一约束
- 支持 HTTPS 与证书管理

### 3.4 任务管理

#### 3.4.1 任务生命周期

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 创建任务 | P1 | 已完成 | 支持 shell/python/script 类型 |
| 任务列表与筛选 | P1 | 已完成 | 按状态/时间筛选 |
| 任务停止 | P1 | 已完成 | 通过 Agent API 终止进程（需 process_id） |
| 任务优先级调度 | P2 | 已完成 | 1-10 优先级 |
| 任务重试 | P2 | 已完成 | max_retries + retry_delay |
| 任务编排 | P3 | 待开发 | 依赖关系、串行/并行执行 |

#### 3.4.2 任务状态模型

```
pending → assigned（Agent 领取）
assigned → running（开始执行）
running → completed（正常完成）
running → failed（执行失败）
running → stopped（手动停止）
pending/assigned → cancelled（取消）
```

#### 3.4.3 Agent 任务队列

- Agent 部署在每台 GPU 机器上，通过轮询领取任务
- 支持 HTTP/gRPC 双协议通信
- 任务租约机制（`lease_expires_at`），防止 Agent 宕机导致任务卡死
- 本地 SQLite 存储任务状态，支持断线恢复

### 3.5 数据集管理

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 数据集列表 | P2 | 已完成 | 按用户隔离 |
| 分片上传 | P2 | 已完成 | 初始化上传、分片传输 |
| 挂载到机器 | P2 | 已完成 | 选择机器 + 挂载路径，校验机器归属 |

### 3.6 镜像管理

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 镜像列表 | P1 | 已完成 | category/framework/status 筛选 |
| Harbor 同步 | P2 | 部分完成 | 路由和 Service 已实现，具体同步逻辑待接入 |
| 官方/自定义镜像 | P2 | 已完成 | `is_official` 标记区分 |

### 3.7 监控与告警

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 实时监控快照 | P2 | 已完成 | 接入 MachineService 获取真实数据 |
| GPU 使用趋势 | P2 | 部分完成 | 待接入 Prometheus 真实监控数据 |
| 告警列表 | P2 | 已完成 | 分页、筛选（severity/acknowledged） |
| 告警确认 | P2 | 已完成 | 确认操作接口 |
| 机器心跳监控 | P2 | 已完成 | `last_heartbeat` 字段，超时判定离线 |

### 3.8 审计日志

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 操作审计记录 | P1 | 已完成 | 关键操作自动落库 |
| 审计日志查询 | P1 | 已完成 | 按操作类型/资源类型/用户名/时间范围筛选 |
| 审计日志字段 | P1 | 已完成 | 操作者、动作、资源类型、资源ID、详情 |

---

## 4. 业务流程

### 4.1 客户入驻流程

```
管理员创建客户账号（设置公司代号、邮箱）
  → 系统生成默认密码（ChangeME_123）
  → 客户首次登录
  → 系统检测 must_change_password=true
  → 强制跳转改密页面
  → 客户设置新密码
  → 改密成功，进入客户首页
```

### 4.2 机器上架与分配流程

```
管理员添加机器（填写 SSH 连接信息）
  → Agent 自动采集硬件信息（CPU/内存/GPU）
  → 采集成功，机器状态变为 online
  → 管理员选择客户，设置租期，执行分配
  → 系统校验机器状态和客户有效性
  → 分配成功，机器状态变为 allocated
  → 异步执行：重置 SSH 密码、清理环境
  → 客户在"我的机器"中看到新分配的机器
```

### 4.3 远程访问流程

```
客户查看机器连接信息
  → 获取 SSH 地址/端口/用户名
  → 方式一：使用 SSH 客户端直连
  → 方式二：通过 Web 终端（待开发）
  → 方式三：通过 VNC/RDP 远程桌面（待开发）

管理员配置远程访问（可选）：
  → 启用对外访问
  → 配置域名和端口映射
  → 系统生成 Nginx 反向代理配置
  → 触发 Nginx reload
  → 客户通过公网域名访问
```

### 4.4 任务执行流程

```
客户创建训练任务（命令、参数、环境变量、优先级）
  → 任务状态：pending
  → Agent 轮询领取任务（按优先级排序）
  → 任务状态：assigned，记录 agent_id 和 lease
  → Agent 启动进程执行任务
  → 任务状态：running，记录 process_id
  → 执行完成 → completed / failed
  → 客户可随时停止任务 → Agent 终止进程 → stopped
```

### 4.5 机器回收流程

```
管理员发起回收（填写回收原因）
  → 系统记录审计日志
  → 更新分配状态为 reclaimed
  → 机器状态恢复为 online
  → 异步执行：清理客户数据、重置环境（待完善）
  → 机器可重新分配给其他客户
```

---

## 5. 非功能性需求

### 5.1 安全性

| 需求项 | 说明 |
|--------|------|
| 传输加密 | 所有 API 通信使用 HTTPS |
| 密码安全 | 密码哈希存储（bcrypt），最小长度 6 位 |
| Token 安全 | JWT 签名验证，refresh_token 存储于 Redis，支持黑名单 |
| 权限隔离 | 角色权限严格隔离，资源归属校验 |
| SSH 密钥安全 | 公钥格式校验（标准库解析），指纹去重 |
| 审计追踪 | 关键操作全量记录，支持事后追溯 |
| 输入校验 | 所有用户输入进行格式和边界校验，防止注入攻击 |
| 域名/端口唯一性 | 远程访问配置的域名+端口组合唯一约束 |
| 首次登录改密 | 默认密码强制修改，降低弱密码风险 |

### 5.2 可用性

| 需求项 | 说明 |
|--------|------|
| Agent 心跳 | 机器心跳监控，超时自动标记离线 |
| 任务租约 | 任务领取后设置租约过期时间，防止 Agent 宕机导致任务卡死 |
| 断线恢复 | Agent 本地 SQLite 存储，支持断线后任务状态恢复 |
| Token 自动续期 | 前端 access_token 过期自动使用 refresh_token 续期 |
| 错误提示 | 统一错误码和提示信息，前端按 code + msg 处理 |
| 空状态与加载态 | 列表页面支持空状态、加载态展示 |

### 5.3 性能

| 需求项 | 说明 |
|--------|------|
| 监控缓存 | 监控快照数据通过 Redis 缓存，减少后端压力 |
| 分页查询 | 所有列表接口支持分页，避免全量加载 |
| 分片上传 | 大文件数据集支持分片上传 |
| 异步处理 | 机器采集、分配后动作等耗时操作异步执行 |

### 5.4 可维护性

| 需求项 | 说明 |
|--------|------|
| 数据库迁移 | SQL 迁移脚本按编号递增管理 |
| API 文档 | Swagger/OpenAPI 自动生成 |
| 分层架构 | Controller → Service → DAO 三层分离 |
| 配置管理 | 系统配置表支持动态配置（`system_configs`） |
| CLI 工具 | 管理员账号创建/重置命令行工具 |

### 5.5 合规性

| 需求项 | 说明 |
|--------|------|
| 操作审计 | 所有敏感操作记录审计日志（登录、分配、回收、重置等） |
| 数据隔离 | 多租户数据严格隔离，客户只能访问自己的资源 |
| 访问控制 | 基于角色的访问控制（RBAC） |
| 密码策略 | 默认密码强制修改，密码最小长度要求 |

---

## 6. 待开发功能清单

按优先级排列的待开发功能：

### P2 — 近期待开发

| 功能 | 说明 | 依赖 |
|------|------|------|
| VNC/RDP 远程桌面 | 通过 Guacamole 实现 Web 远程桌面 | Guacamole 部署 |
| 远程访问后端 API | 远程访问配置的持久化和 Nginx 对接 | Nginx 配置管理 |
| SSH 密钥自动注入 | 分配机器时自动注入客户 SSH 公钥 | Agent API |
| GPU 趋势真实数据 | 接入 Prometheus 获取 GPU 利用率趋势 | Prometheus 部署 |
| 监控缓存 Redis 化 | 监控快照数据缓存到 Redis | Redis |
| Harbor 镜像同步 | 接入 Harbor API 实现镜像同步 | Harbor 部署 |
| 到期自动回收 | 租期到期自动触发回收流程 | 定时任务框架 |

### P3 — 后续规划

| 功能 | 说明 | 依赖 |
|------|------|------|
| 任务编排 | 任务依赖关系、串行/并行执行 | 任务引擎 |
| DNS 管理 | 自动管理远程访问域名解析 | DNS API |
| 防火墙管理 | 自动管理端口开放规则 | 防火墙 API |
| Docker 容器管理 | 机器上的容器生命周期管理 | Agent Docker API |
| Agent 租约校验 | 任务恢复时校验租约有效性 | Agent 升级 |
| 机器回收清理进度 | 展示异步清理任务的执行进度 | 异步任务框架 |
| 镜像同步进度展示 | 展示 Harbor 同步的实时进度 | Harbor SDK |

---

## 7. 技术约束与依赖

### 7.1 技术栈

| 模块 | 技术选型 |
|------|----------|
| 后端 | Go + Gin + GORM + PostgreSQL + Redis |
| 前端 | Vue 3 + TypeScript + Element Plus + Vite |
| Agent | Go + SQLite + HTTP/gRPC |
| 监控 | Prometheus + InfluxDB（规划中） |
| 镜像仓库 | Harbor（规划中） |
| 远程访问网关 | Apache Guacamole（规划中） |
| 反向代理 | Nginx / OpenResty |

### 7.2 外部依赖

| 依赖 | 用途 | 状态 |
|------|------|------|
| PostgreSQL | 主数据库 | 已部署 |
| Redis | Token 存储、缓存、黑名单 | 已部署 |
| Prometheus | GPU/系统监控指标采集 | 规划中 |
| Harbor | Docker 镜像仓库 | 规划中 |
| Guacamole | Web 远程访问网关 | 规划中 |
| Nginx | 反向代理、SSL 终止 | 规划中 |

---

## 8. 术语表

| 术语 | 说明 |
|------|------|
| Agent | 部署在 GPU 机器上的客户端程序，负责硬件采集、任务执行、心跳上报 |
| Allocation | 资源分配记录，记录机器与客户的租赁关系 |
| Host | GPU 物理机或虚拟机节点 |
| Lease | 任务租约，Agent 领取任务后的有效期，防止任务卡死 |
| Enrollment | 机器添加任务，异步处理机器上架流程 |
| Reclaim | 机器回收，终止分配关系并清理环境 |
| Heartbeat | Agent 心跳，定期上报机器在线状态 |
