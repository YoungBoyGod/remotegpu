# 远程客户支持平台 — 业务需求文档

> 版本：v1.0 | 日期：2026-02-06 | 作者：需求分析师

## 1. 项目背景与目标

### 1.1 项目背景

RemoteGPU 是一个 GPU 远程管理平台，面向需要高性能计算资源的企业客户，提供 GPU 机器的远程租赁、管理和使用服务。平台涉及交付部门的大量日常工作，包括机器上架、资源分配、客户入驻、远程访问配置、故障排查等。

当前平台已完成基础功能闭环（登录鉴权、机器管理、客户管理、任务管理、监控告警），需要进一步完善**远程访问能力**、**会话管理**、**权限精细化**和**交付工作流自动化**等核心能力，以构建完整的远程客户支持体系。

### 1.2 项目目标

- 为客户提供安全、稳定、便捷的多协议远程 GPU 资源访问体验（SSH/VNC/RDP）
- 为交付团队提供高效的资源分配、环境准备与客户支持工具
- 建立完善的会话管理与审计追踪机制，满足企业安全合规要求
- 实现交付工作流的标准化与自动化，降低人工操作成本

### 1.3 文档范围

本文档聚焦以下核心领域的需求分析：
1. 业务场景分析
2. 远程访问方式需求（SSH、VNC、RDP）
3. 安全性要求
4. 权限管理需求
5. 会话管理需求
6. 审计和日志需求
7. 交付部门工作流程

---

## 2. 业务场景分析

### 2.1 核心业务场景

#### 场景一：AI 训练任务远程执行

- **用户**：客户（AI 工程师/研究员）
- **流程**：客户通过 SSH 连接到分配的 GPU 机器，配置训练环境（安装依赖、上传数据集），提交训练任务，监控训练进度，下载训练结果
- **关键需求**：SSH 连接稳定性、长时间会话保持、文件传输能力、GPU 资源独占

#### 场景二：远程桌面开发调试

- **用户**：客户（需要图形界面的开发者）
- **流程**：客户通过 VNC/RDP 连接到机器桌面环境，使用 IDE 进行开发调试，运行可视化工具（TensorBoard、Jupyter Notebook）
- **关键需求**：低延迟桌面体验、剪贴板共享、文件拖拽、多显示器支持

#### 场景三：交付团队机器准备

- **用户**：平台管理员（交付工程师）
- **流程**：管理员添加新机器 → 采集硬件信息 → 安装基础环境 → 配置远程访问 → 分配给客户 → 通知客户
- **关键需求**：批量操作能力、环境模板化、自动化配置、操作审计

#### 场景四：故障排查与技术支持

- **用户**：平台管理员（运维工程师）
- **流程**：收到告警/客户反馈 → 远程连接机器排查 → 修复问题 → 记录处理结果
- **关键需求**：快速接入能力、不影响客户会话、操作记录留痕

#### 场景五：客户入驻与环境交付

- **用户**：平台管理员 + 客户负责人
- **流程**：创建客户账号 → 分配机器资源 → 配置远程访问 → 发送连接信息 → 客户首次登录改密 → 验证连接
- **关键需求**：流程标准化、自动化通知、连接验证

### 2.2 用户角色与职责

| 角色 | 标识 | 核心职责 |
|------|------|----------|
| 平台管理员 | `admin` | 机器上架、资源分配、客户管理、远程访问配置、监控告警、审计日志 |
| 客户负责人 | `customer_owner` | 查看分配机器、管理 SSH 密钥、创建任务、管理子账号、查看操作记录 |
| 客户成员 | `customer_member` | 使用分配的机器、远程连接、执行任务、管理个人密钥 |

### 2.3 现有功能基线

以下功能已实现，作为远程客户支持平台的基础：

| 模块 | 已完成功能 | 状态 |
|------|-----------|------|
| 认证 | 用户名密码登录、JWT 双令牌、首次改密、登出黑名单 | 已上线 |
| 机器管理 | 添加/导入机器、硬件采集、状态管理、列表筛选 | 已上线 |
| 资源分配 | 分配/回收机器、租期管理、异步清理 | 已上线 |
| SSH 访问 | SSH 密钥管理、连接信息展示、密码重置 | 已上线 |
| 任务管理 | 创建/停止任务、优先级调度、Agent 租约 | 已上线 |
| 审计日志 | 操作记录、多维度查询 | 已上线 |
| 监控告警 | 实时快照、告警列表、心跳监控 | 已上线 |

---

## 3. 远程访问方式需求

### 3.1 SSH 远程访问

SSH 是平台最核心的远程访问方式，面向所有需要命令行操作的场景。

#### 3.1.1 已实现功能

| 功能 | 说明 |
|------|------|
| SSH 密钥管理 | 支持 rsa/ed25519/ecdsa 格式，SHA256 指纹去重 |
| 连接信息展示 | 客户端展示连接地址、端口、用户名 |
| SSH 密码重置 | 客户可触发密码重置，通过 Agent 执行 |

#### 3.1.2 待完善功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| SSH 密钥自动注入 | P1 | 分配机器时自动将客户公钥注入 `~/.ssh/authorized_keys` |
| SSH 连接验证 | P1 | 分配后自动验证 SSH 连接可用性 |
| Web SSH 终端 | P2 | 浏览器内嵌 SSH 终端（基于 xterm.js 或 Guacamole） |
| SSH 端口转发管理 | P2 | 管理 SSH 隧道，支持 Jupyter/TensorBoard 端口映射 |
| SSH 会话录制 | P3 | 记录 SSH 会话操作，支持回放审计 |

#### 3.1.3 SSH 连接配置模型

```
客户端 → [公网域名:公网端口] → Nginx/反向代理 → [内网IP:SSH端口] → GPU 机器
```

默认端口映射：SSH 22 → 公网 2222

### 3.2 VNC 远程桌面访问

VNC 面向需要图形界面的开发调试场景，如可视化工具、IDE 操作等。

#### 3.2.1 功能需求

| 功能 | 优先级 | 说明 |
|------|--------|------|
| Web VNC 客户端 | P2 | 基于 Guacamole 实现浏览器内 VNC 访问，无需安装客户端 |
| VNC 服务自动部署 | P2 | 分配机器时通过 Agent 自动安装并启动 VNC 服务（如 TigerVNC） |
| VNC 密码管理 | P2 | 平台统一管理 VNC 连接密码，支持重置 |
| 分辨率与色深配置 | P3 | 支持客户自定义桌面分辨率和色深 |
| 剪贴板共享 | P3 | 支持本地与远程桌面之间的文本剪贴板同步 |
| 文件传输 | P3 | 支持通过 VNC 会话进行文件上传/下载 |

#### 3.2.2 VNC 连接架构

```
浏览器 → [HTTPS] → Guacamole Web → [Guacamole 协议] → guacd → [VNC] → GPU 机器:5900
```

默认端口映射：VNC 5900 → 公网 15900

### 3.3 RDP 远程桌面访问

RDP 面向 Windows 环境的远程桌面场景，部分客户可能需要 Windows GPU 机器。

#### 3.3.1 功能需求

| 功能 | 优先级 | 说明 |
|------|--------|------|
| Web RDP 客户端 | P2 | 基于 Guacamole 实现浏览器内 RDP 访问 |
| RDP 服务配置 | P2 | 通过 Agent 配置 Windows 远程桌面服务 |
| RDP 凭据管理 | P2 | 平台统一管理 RDP 连接凭据 |
| 多显示器支持 | P3 | 支持多显示器远程桌面 |
| 音频重定向 | P3 | 支持远程音频输出到本地 |

#### 3.3.2 RDP 连接架构

```
浏览器 → [HTTPS] → Guacamole Web → [Guacamole 协议] → guacd → [RDP] → GPU 机器:3389
```

默认端口映射：RDP 3389 → 公网 13389

### 3.4 Guacamole 统一远程访问网关

Apache Guacamole 作为统一的 Web 远程访问网关，同时支持 SSH、VNC、RDP 三种协议。

#### 3.4.1 集成需求

| 功能 | 优先级 | 说明 |
|------|--------|------|
| Guacamole 部署与集成 | P2 | 部署 guacamole-server（guacd）+ guacamole-client |
| 连接管理 API 对接 | P2 | 通过 Guacamole REST API 动态创建/删除连接配置 |
| 单点登录集成 | P2 | 平台 JWT Token 与 Guacamole 认证打通，免二次登录 |
| 连接参数模板 | P2 | 预定义 SSH/VNC/RDP 连接参数模板，减少手动配置 |
| 连接状态监控 | P3 | 实时监控活跃连接数、连接时长、带宽使用 |

#### 3.4.2 Guacamole 架构

```
                    ┌─────────────────────┐
                    │   RemoteGPU 前端     │
                    │  （Vue 3 + iframe）  │
                    └─────────┬───────────┘
                              │ HTTPS
                    ┌─────────▼───────────┐
                    │  Guacamole Client    │
                    │  （Web 应用）         │
                    └─────────┬───────────┘
                              │ Guacamole 协议
                    ┌─────────▼───────────┐
                    │      guacd          │
                    │  （代理守护进程）     │
                    └──┬──────┬──────┬────┘
                       │      │      │
                  SSH  │ VNC  │ RDP  │
                       ▼      ▼      ▼
                    GPU 机器集群
```

### 3.5 远程访问配置管理

#### 3.5.1 配置需求

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 远程访问启用/禁用 | P1 | 管理员可按机器粒度启用或禁用对外访问 |
| 域名自动生成 | P2 | 格式：`<machine_slug>.<base_domain>`，支持手动覆盖 |
| 端口映射管理 | P2 | 默认映射表 + 自定义映射，域名+端口唯一约束 |
| Nginx 配置自动生成 | P2 | 后端生成 Nginx 配置片段，触发 reload |
| HTTPS 证书管理 | P2 | 支持 Let's Encrypt 自动签发或手动上传证书 |
| 额外端口开放 | P2 | 支持 TensorBoard(6006)、Jupyter(8888) 等额外端口 |

#### 3.5.2 已设计的配置字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `enabled` | bool | 是否启用对外访问 |
| `protocol` | string | tcp/http/https/ssh |
| `public_domain` | string | 对外访问域名 |
| `public_port` | int | 对外开放端口 |
| `target_port` | int | 目标服务端口（反向代理映射） |
| `extra_ports` | string | 额外开放端口列表 |

---

## 4. 安全性要求

### 4.1 传输安全

| 需求项 | 优先级 | 说明 |
|--------|--------|------|
| HTTPS 强制 | P0 | 所有 Web 通信（API、Guacamole）强制使用 HTTPS |
| SSH 加密传输 | P0 | SSH 连接使用加密通道，禁用不安全的加密算法 |
| VNC 加密隧道 | P1 | VNC 连接通过 Guacamole 的 HTTPS 隧道传输，不直接暴露 VNC 端口 |
| RDP TLS 加密 | P1 | RDP 连接启用 TLS/NLA 认证 |

### 4.2 认证安全

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| JWT 双令牌机制 | P0 | 已完成 | access_token(短期) + refresh_token(长期) |
| 首次登录强制改密 | P0 | 已完成 | 默认密码必须修改后才能使用平台 |
| 密码强度校验 | P1 | 待完善 | 当前改密接口未调用 `ValidateStrength()` |
| 登录失败锁定 | P1 | 待开发 | 连续 N 次登录失败后临时锁定账号 |
| Agent API 认证加固 | P1 | 待完善 | **当前 Agent API 认证机制不完善**，需实现双向 mTLS 或 API Key + HMAC 签名认证，防止未授权 Agent 接入 |
| 多因素认证（MFA） | P3 | 待规划 | TOTP 或短信验证码二次认证 |

### 4.3 访问控制安全

| 需求项 | 优先级 | 状态 | 说明 |
|--------|--------|------|------|
| 角色权限隔离 | P0 | 已完成 | Admin 与 Customer 路由严格隔离 |
| 资源归属校验 | P0 | 已完成 | 客户只能访问自己分配的机器 |
| IP 白名单 | P2 | 待开发 | 限制客户只能从指定 IP/CIDR 范围访问 |
| 访问时间窗口 | P3 | 待规划 | 限制客户只能在指定时间段内访问 |

### 4.4 数据安全

| 需求项 | 优先级 | 说明 |
|--------|--------|------|
| 多租户数据隔离 | P0 | 客户之间数据严格隔离，通过 JWT userID 过滤 |
| 机器回收数据清理 | P1 | 回收机器时彻底清理前客户的数据和环境 |
| SSH 密钥安全存储 | P1 | 公钥格式校验，私钥不在平台存储 |
| SSH 凭据加密存储 | P0 | **当前 SSH 密码以明文存储在数据库中，存在严重安全风险**，必须使用加密存储（如 AES-256-GCM）并配合密钥管理 |
| 敏感信息脱敏 | P1 | API 响应中密码等敏感字段不返回明文 |

### 4.5 网络安全

| 需求项 | 优先级 | 说明 |
|--------|--------|------|
| 端口最小化暴露 | P1 | 仅开放必要端口，默认关闭对外访问 |
| 反向代理隔离 | P1 | 客户不直接访问内网 IP，通过 Nginx 反向代理 |
| DDoS 防护 | P2 | Nginx 层面配置连接速率限制 |
| 端口扫描防护 | P2 | 非标准端口映射，减少被扫描风险 |

---

## 5. 权限管理需求

### 5.1 角色权限矩阵

#### 5.1.1 平台管理员（admin）

| 权限域 | 具体权限 |
|--------|----------|
| 客户管理 | 创建/禁用/启用客户账号，重置密码 |
| 机器管理 | 添加/删除/导入机器，采集硬件信息，设置维护模式 |
| 资源分配 | 分配/回收机器，设置租期 |
| 远程访问配置 | 启用/禁用对外访问，配置域名和端口映射 |
| 监控告警 | 查看实时监控，处理告警 |
| 审计日志 | 查看所有操作审计记录 |
| 系统配置 | 管理平台全局配置 |
| 镜像管理 | 管理镜像列表，触发 Harbor 同步 |

#### 5.1.2 客户负责人（customer_owner）

| 权限域 | 具体权限 |
|--------|----------|
| 机器查看 | 查看本公司分配的所有机器及连接信息 |
| SSH 密钥管理 | 管理本公司的 SSH 公钥（增删查） |
| SSH 密码重置 | 重置本公司机器的 SSH 密码 |
| 远程连接 | 通过 SSH/VNC/RDP 连接本公司的机器 |
| 任务管理 | 创建/停止/查看本公司的所有任务 |
| 数据集管理 | 上传/挂载/查看本公司的数据集 |
| 成员管理 | 查看本公司成员列表（待开发） |
| 操作记录 | 查看本公司的操作记录（待开发） |

#### 5.1.3 客户成员（customer_member）

| 权限域 | 具体权限 |
|--------|----------|
| 机器查看 | 查看分配给自己的机器及连接信息 |
| SSH 密钥管理 | 管理个人 SSH 公钥（增删查） |
| 远程连接 | 通过 SSH/VNC/RDP 连接分配给自己的机器 |
| 任务管理 | 创建/停止/查看自己的任务 |
| 数据集管理 | 上传/挂载/查看自己的数据集 |

### 5.2 权限管理待完善项

| 问题 | 优先级 | 说明 |
|------|--------|------|
| owner/member 权限未区分 | P1 | 当前路由层只有 `RequireAdmin()` 中间件，Customer 路由未区分 owner 和 member |
| 缺少资源级权限控制 | P1 | member 应只能访问分配给自己的机器，owner 可访问公司所有机器 |
| JWT Claims 缺少租户标识 | P2 | Claims 中无 `company_code`，多租户隔离依赖 userID 关联查询 |
| 缺少权限变更审计 | P2 | 角色变更、权限调整未记录审计日志 |

### 5.3 权限实现建议

1. **中间件层**：新增 `RequireOwner()` 中间件，区分 owner 和 member 的路由访问
2. **数据层**：member 查询时增加 `customer_id = current_user_id` 过滤条件
3. **JWT 扩展**：在 Claims 中加入 `company_code` 字段，支持中间件层直接过滤

---

## 6. 会话管理需求

### 6.1 会话生命周期

#### 6.1.1 会话状态模型

```
创建连接请求 → 认证验证 → 建立会话(active)
  → 正常使用中(active)
  → 空闲超时(idle) → 自动断开(terminated)
  → 用户主动断开(closed)
  → 管理员强制断开(force_terminated)
  → 网络异常断开(disconnected) → 重连(active) / 超时清理(terminated)
```

#### 6.1.2 会话管理功能需求

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 活跃会话列表 | P2 | 管理员可查看所有活跃的远程连接会话 |
| 会话详情 | P2 | 展示会话类型、用户、机器、开始时间、持续时长 |
| 强制断开会话 | P2 | 管理员可强制断开指定会话 |
| 空闲超时断开 | P2 | 会话空闲超过配置时间后自动断开（默认 30 分钟） |
| 最大会话时长 | P3 | 单次会话最大持续时长限制（可配置） |
| 并发会话限制 | P3 | 限制单用户同时活跃的会话数量 |

### 6.2 会话数据模型

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | UUID | 会话唯一标识 |
| `customer_id` | UUID | 用户 ID |
| `host_id` | VARCHAR | 机器 ID |
| `protocol` | ENUM | 连接协议（ssh/vnc/rdp） |
| `source_ip` | VARCHAR | 客户端 IP 地址 |
| `status` | ENUM | 会话状态（active/idle/closed/terminated） |
| `started_at` | TIMESTAMP | 会话开始时间 |
| `last_activity_at` | TIMESTAMP | 最后活动时间 |
| `ended_at` | TIMESTAMP | 会话结束时间 |
| `end_reason` | VARCHAR | 结束原因（user_close/idle_timeout/admin_force/error） |
| `bytes_sent` | BIGINT | 发送字节数 |
| `bytes_received` | BIGINT | 接收字节数 |

### 6.3 会话监控与统计

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 实时会话仪表板 | P2 | 展示当前活跃会话数、按协议/机器/用户分布 |
| 会话历史查询 | P2 | 按用户/机器/协议/时间范围查询历史会话 |
| 会话时长统计 | P3 | 按用户/机器维度统计会话使用时长 |
| 带宽使用统计 | P3 | 统计各会话的网络流量消耗 |

---

## 7. 审计和日志需求

### 7.1 审计日志现状

平台已实现基础审计日志功能，通过 Gin 中间件自动记录 Admin 路由的操作。

已有审计字段：
- 操作者（customer_id, username）
- 请求信息（ip_address, method, path）
- 操作分类（action, resource_type, resource_id）
- 操作详情（detail, status_code）
- 时间戳（created_at）

### 7.2 审计日志待完善需求

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 远程连接审计 | P1 | 记录每次远程连接的建立和断开（协议、来源IP、时长） |
| 客户端操作审计 | P2 | Customer 路由的关键操作也需记录审计日志 |
| SSH 会话录制 | P3 | 记录 SSH 终端的输入输出，支持回放 |
| VNC/RDP 会话录像 | P3 | 录制远程桌面会话视频，支持回放审计 |
| 审计日志导出 | P2 | 支持按时间范围导出审计日志（CSV/JSON） |
| 审计日志保留策略 | P2 | 配置日志保留期限，过期自动归档或清理 |

### 7.3 审计事件分类

| 事件类别 | 具体事件 | 当前状态 |
|----------|----------|----------|
| 认证事件 | 登录成功/失败、登出、Token 刷新、密码修改 | 部分已实现 |
| 资源管理 | 机器添加/删除、分配/回收、状态变更 | 已实现 |
| 远程连接 | SSH/VNC/RDP 连接建立/断开、连接失败 | 待开发 |
| 客户管理 | 创建/禁用/启用客户、角色变更 | 已实现 |
| 配置变更 | 远程访问配置修改、系统配置修改 | 部分已实现 |
| 安全事件 | 异常登录、暴力破解检测、越权访问尝试 | 待开发 |

### 7.4 安全告警触发规则

| 告警规则 | 优先级 | 说明 |
|----------|--------|------|
| 登录失败超限 | P1 | 同一账号连续 5 次登录失败，触发告警并临时锁定 |
| 异常 IP 登录 | P2 | 检测到非常用 IP 地址登录，触发告警通知 |
| 非工作时间访问 | P3 | 非工作时间段的远程连接，记录并可选告警 |
| 大量数据传输 | P3 | 单次会话数据传输量超过阈值，触发告警 |

---

## 8. 交付部门工作流程

### 8.1 交付团队职责概述

交付部门是平台运营的核心团队，负责从机器上架到客户交付的全流程管理。主要职责包括：

- **资源准备**：机器上架、硬件采集、环境安装、远程访问配置
- **客户入驻**：创建账号、分配资源、发送连接信息、验证连通性
- **日常运维**：监控告警处理、故障排查、资源调度
- **客户支持**：技术问题解答、环境配置协助、性能调优建议
- **资源回收**：租期管理、数据清理、环境重置

### 8.2 核心工作流程

#### 8.2.1 机器上架流程

```
1. 交付工程师获取新机器信息（IP、SSH 凭据、机房位置）
2. 在平台添加机器（填写基础信息 + SSH 连接信息）
3. 系统通过 Agent 自动采集硬件信息（CPU/内存/磁盘/GPU）
4. 交付工程师验证采集结果，确认 GPU 型号和数量
5. 安装基础运行环境（CUDA、cuDNN、Docker 等）
6. 配置远程访问（启用对外访问、设置域名和端口映射）
7. 验证远程连接可用性（SSH/VNC 连通性测试）
8. 机器状态变为 online，可供分配
```

**当前痛点**：
- 步骤 5（环境安装）需要手动 SSH 到机器操作，缺少自动化
- 步骤 6-7 需要手动配置和验证，流程繁琐

**自动化改进建议**：
- 提供环境模板（CUDA 版本 + 框架组合），一键安装
- 远程访问配置自动生成并验证连通性
- 批量上架支持（JSON 导入 + 批量采集）

#### 8.2.2 客户入驻流程

```
1. 商务确认合作，提供客户信息（公司名称、联系人、邮箱）
2. 交付工程师在平台创建客户账号（设置公司代号、邮箱）
3. 系统生成默认密码（ChangeME_123），标记 must_change_password
4. 交付工程师根据需求分配 GPU 机器（选择机器 + 设置租期）
5. 系统执行分配后动作（重置 SSH 密码、清理前客户环境）
6. 交付工程师将连接信息发送给客户（账号、密码、SSH 地址）
7. 客户首次登录，强制修改密码
8. 客户上传 SSH 公钥，验证远程连接
9. 交付工程师确认客户可正常使用
```

**当前痛点**：
- 步骤 6 需要手动整理连接信息并通过邮件/IM 发送
- 步骤 8-9 缺少自动化验证机制

**自动化改进建议**：
- 分配完成后自动生成连接信息摘要，支持一键复制或邮件发送
- SSH 密钥注入自动化，分配时自动将客户公钥注入机器
- 提供连接验证工具，自动检测 SSH/VNC/RDP 连通性

#### 8.2.3 日常运维流程

```
1. 监控系统检测到异常（心跳超时、GPU 故障、磁盘满等）
2. 系统触发告警，通知交付工程师
3. 交付工程师查看告警详情，判断严重程度
4. 远程连接机器排查问题（不影响客户会话）
5. 执行修复操作（重启服务、清理磁盘、更换硬件等）
6. 确认问题解决，关闭告警
7. 记录处理结果到审计日志
```

**当前痛点**：
- 告警通知仅在平台内，缺少外部通知渠道（邮件/钉钉/企微）
- 管理员排查时需要单独 SSH 连接，无法在平台内直接操作

**自动化改进建议**：
- 集成外部通知渠道（邮件、钉钉、企业微信 Webhook）
- 平台内嵌 Web 终端，管理员可直接在浏览器内排查问题
- 常见问题自动修复脚本（磁盘清理、服务重启等）

#### 8.2.4 资源回收流程

```
1. 租期到期或客户主动退还
2. 交付工程师通知客户备份数据（设置缓冲期）
3. 缓冲期结束，交付工程师发起回收
4. 系统检查机器上是否有运行中的任务
5. 如有运行中任务，提示先停止任务
6. 执行回收：更新分配状态为 reclaimed
7. 异步清理：删除客户数据、重置 SSH 密码、清理环境
8. 机器状态恢复为 online，可重新分配
```

**当前痛点**：
- 回收前未检查运行中的任务（已在审查报告中标记为 P0）
- 缺少到期自动提醒和缓冲期机制
- 异步清理缺少进度展示和完成确认

**自动化改进建议**：
- 租期到期前自动发送提醒通知（7天/3天/1天）
- 回收前自动检查并停止运行中的任务
- 清理进度可视化，支持查看每个清理步骤的状态

### 8.3 交付工具需求汇总

| 工具/功能 | 优先级 | 说明 |
|-----------|--------|------|
| 连接信息一键复制 | P1 | 分配完成后自动生成连接摘要，支持复制 |
| SSH 连通性检测 | P1 | 分配后自动验证 SSH 连接可用性 |
| 环境模板管理 | P2 | 预定义 CUDA/框架环境模板，一键安装 |
| 批量操作面板 | P2 | 支持批量上架、批量采集、批量分配 |
| 外部通知集成 | P2 | 告警和关键事件推送到钉钉/企微/邮件 |
| Web 终端 | P2 | 管理员在浏览器内直接 SSH 到机器排查问题 |
| 租期到期提醒 | P2 | 自动发送到期提醒通知（7天/3天/1天） |
| 清理进度面板 | P3 | 展示回收后异步清理任务的执行进度 |
| 自动修复脚本 | P3 | 常见问题一键修复（磁盘清理、服务重启等） |

---

## 9. 需求优先级总结

### 9.1 P0 — 必须立即修复

| 需求 | 模块 | 说明 |
|------|------|------|
| 分配机器加行级锁 | 资源分配 | 防止同一机器被并发分配给两个客户 |
| 回收前检查运行中任务 | 资源回收 | 防止回收后任务仍在执行导致数据不一致 |
| HTTPS 强制 | 传输安全 | 所有 Web 通信强制 HTTPS |
| SSH 凭据加密存储 | 数据安全 | 当前 SSH 密码明文存储在数据库中，必须加密存储 |

### 9.2 P1 — 近期重点

| 需求 | 模块 | 说明 |
|------|------|------|
| SSH 密钥自动注入 | 远程访问 | 分配机器时自动注入客户公钥 |
| SSH 连接验证 | 远程访问 | 分配后自动验证连接可用性 |
| owner/member 权限区分 | 权限管理 | 新增 RequireOwner 中间件 |
| 密码强度校验 | 认证安全 | 改密接口调用 ValidateStrength |
| 登录失败锁定 | 认证安全 | 连续失败后临时锁定 |
| 远程连接审计 | 审计日志 | 记录连接建立和断开事件 |
| 连接信息一键复制 | 交付工具 | 分配后生成连接摘要 |
| 任务停止加超时 | 任务管理 | Agent 调用增加超时控制 |
| Agent API 认证加固 | 认证安全 | 实现 mTLS 或 API Key + HMAC 签名认证 |

### 9.3 P2 — 中期规划

| 需求 | 模块 | 说明 |
|------|------|------|
| VNC/RDP 远程桌面 | 远程访问 | 基于 Guacamole 实现 Web 远程桌面 |
| Guacamole 集成 | 远程访问 | 统一远程访问网关部署与对接 |
| 会话管理 | 会话管理 | 活跃会话列表、强制断开、空闲超时 |
| Nginx 配置自动生成 | 远程访问配置 | 后端生成配置片段并触发 reload |
| 环境模板管理 | 交付工具 | 预定义环境模板一键安装 |
| 外部通知集成 | 交付工具 | 告警推送到钉钉/企微/邮件 |
| 审计日志导出 | 审计日志 | 按时间范围导出 CSV/JSON |
| IP 白名单 | 访问控制 | 限制客户访问来源 IP |
| 租期到期提醒 | 交付工具 | 自动发送到期提醒通知 |

### 9.4 P3 — 长期规划

| 需求 | 模块 | 说明 |
|------|------|------|
| SSH 会话录制 | 审计日志 | 记录终端输入输出，支持回放 |
| VNC/RDP 会话录像 | 审计日志 | 录制远程桌面视频 |
| 多因素认证（MFA） | 认证安全 | TOTP 或短信二次认证 |
| 并发会话限制 | 会话管理 | 限制单用户同时活跃会话数 |
| 访问时间窗口 | 访问控制 | 限制访问时间段 |
| 自动修复脚本 | 交付工具 | 常见问题一键修复 |
| 任务编排 | 任务管理 | 依赖关系、串行/并行执行 |

---

## 10. 技术依赖与约束

### 10.1 技术栈

| 模块 | 技术选型 |
|------|----------|
| 后端 | Go + Gin + GORM + PostgreSQL + Redis |
| 前端 | Vue 3 + TypeScript + Element Plus + Vite |
| Agent | Go + SQLite + HTTP/gRPC |
| 远程访问网关 | Apache Guacamole（guacd + guacamole-client） |
| 反向代理 | Nginx / OpenResty |
| 监控 | Prometheus + Grafana |

### 10.2 外部依赖

| 依赖 | 用途 | 状态 |
|------|------|------|
| PostgreSQL | 主数据库 | 已部署 |
| Redis | Token 存储、缓存、黑名单 | 已部署 |
| Apache Guacamole | Web 远程访问网关（SSH/VNC/RDP） | 待部署 |
| Nginx | 反向代理、SSL 终止、端口映射 | 待部署 |
| Prometheus | GPU/系统监控指标采集 | 规划中 |
| Harbor | Docker 镜像仓库 | 规划中 |

---

## 11. 术语表

| 术语 | 说明 |
|------|------|
| Agent | 部署在 GPU 机器上的客户端程序，负责硬件采集、任务执行、心跳上报 |
| Allocation | 资源分配记录，记录机器与客户的租赁关系 |
| Guacamole | Apache 开源项目，提供无客户端的 Web 远程访问网关 |
| guacd | Guacamole 的代理守护进程，负责协议转换（SSH/VNC/RDP） |
| Host | GPU 物理机或虚拟机节点 |
| Lease | 任务租约，Agent 领取任务后的有效期，防止任务卡死 |
| Enrollment | 机器添加任务，异步处理机器上架流程 |
| Reclaim | 机器回收，终止分配关系并清理环境 |
| Session | 远程连接会话，记录用户与机器之间的连接生命周期 |
| NLA | Network Level Authentication，RDP 网络级别认证 |
