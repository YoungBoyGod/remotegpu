# 2026-02-07 团队审查报告汇总

## 📊 任务完成情况

### ✅ 已完成任务（9个）
- #1 - 架构师：分析项目架构和代码质量
- #2 - 后端：修复重复的 main 函数声明
- #3 - 运维：清理未跟踪文件和备份
- #4 - 前端：审查前端代码结构
- #5 - 运维：检查部署配置
- #6 - 后端：审查后端 API 设计
- #8 - 架构师：阅读数据库和架构文档
- #9 - 前端：阅读需求和 API 文档

### 🔄 进行中任务（1个）
- #12 - 前端：实现登录页面和认证流程

### ⏳ 待处理任务（5个）
- #7 - 后端：阅读后端核心设计文档
- #10 - 后端：实现监控服务 Redis 缓存
- #11 - 后端：实现机器 IP 唯一性校验
- #13 - 前端：实现机器列表页面
- #14 - 运维：部署基础设施

---

## 🚨 P0 级别问题（必须立即修复）

### 1. Agent API 无认证（严重安全漏洞）
**发现者**: 架构师 + 后端开发

**位置**: `backend/internal/router/router.go:246-253`

**问题描述**:
- Agent 路由组 `/api/v1/agent/` 完全没有认证机制
- 任何人都可以伪造心跳、认领任务、上报虚假结果
- Agent 客户端虽然支持 Bearer Token，但后端未校验

**影响**: 攻击者可以完全控制任务调度系统

**建议**: 添加 Agent Token 认证中间件或 mTLS

---

### 2. SSH 凭据明文存储（严重安全漏洞）
**发现者**: 架构师

**位置**: `backend/sql/14_machine_enrollments.sql:22-23`

**问题描述**:
```sql
ADD COLUMN IF NOT EXISTS ssh_password TEXT,
ADD COLUMN IF NOT EXISTS ssh_key TEXT,
```
SSH 密码和私钥以明文存储在数据库中

**影响**: 数据库泄露将导致所有机器的 SSH 凭据泄露

**建议**: 在 DAO 层对 ssh_password 和 ssh_key 字段做 AES-256 加密存储

---

### 3. 敏感配置文件已提交到 Git（严重安全漏洞）
**发现者**: 运维

**位置**: `backend/config/config.yaml` 和多个 `.env` 文件

**问题描述**:
- `config.yaml` 包含明文数据库密码、JWT 密钥、AES 密钥等
- 多个 `.env` 文件包含明文密码且已提交到 git

**泄露的凭据**:
- 数据库密码: `remotegpu_password`
- JWT 密钥: `remotegpu-jwt-secret-key-change-in-production-32chars-min`
- AES 密钥: `Rik2hu2McwTnRTLOELE9NCLvPmCPVjrz`
- Harbor 密码: `Harbor12345`
- Guacamole 密码: `guacadmin`

**建议**:
1. 创建 `config.yaml.example`（脱敏模板）
2. 删除 `config.yaml` 并加入 `.gitignore`
3. 使用 `git filter-branch` 或 BFG 清理 git 历史
4. 生产环境使用环境变量覆盖敏感配置

---

### 4. host_metrics 表重复定义（数据库冲突）
**发现者**: 架构师

**位置**: `backend/sql/07_monitoring.sql` vs `backend/sql/18_add_host_metrics.sql`

**问题描述**:
- 两个迁移脚本都定义了 `host_metrics` 表，但字段结构不同
- `07` 版本：FLOAT 类型、无外键、包含 GPU 指标
- `18` 版本：DECIMAL 类型、有外键约束、缺少 GPU 指标

**影响**: 迁移脚本执行冲突，数据结构不一致

**建议**: 统一为一个版本，删除冲突脚本

---

### 5. 机器分配缺少行级锁（并发安全问题）
**发现者**: 架构师（来自 implementation-review.md）

**问题描述**: 机器分配时未使用行级锁，高并发场景下可能导致同一台机器被分配给多个客户

**建议**: 使用 `SELECT ... FOR UPDATE` 行级锁

---

### 6. 机器回收未检查运行中任务
**发现者**: 架构师（来自 implementation-review.md）

**问题描述**: 回收机器前未检查是否有运行中的任务，可能导致任务异常中断

**建议**: 回收前查询 `tasks` 表，确保无 running 状态任务

---

## 🟡 P1 级别问题（短期内应修复）

### 前端问题

#### 1. 两套独立的 Axios 实例（严重）
**发现者**: 前端开发

**位置**: `src/api/common/request.ts` vs `src/utils/request.ts`

**问题**: 两个实例功能不一致，行为混乱
- `common/request.ts`: 401 时直接清除 token，无刷新机制
- `utils/request.ts`: 有 token 刷新重试逻辑

**建议**: 统一为一个 axios 实例，保留 token 刷新逻辑

---

#### 2. TypeScript 类型字段命名混乱（严重）
**发现者**: 前端开发

**问题**: 同一接口内混用 snake_case 和 camelCase
- `customer.ts`: 同时存在 `created_at` 和 `createdAt`
- `machine.ts`: `host_id` 与 `gpuModel` 混用

**建议**: 统一使用 snake_case 与后端保持一致

---

#### 3. 大量重复的 API 函数定义（严重）
**发现者**: 前端开发

**问题**:
- Task 相关操作在 `admin.ts` 和 `customer.ts` 中重复定义
- 认证 API 在 `auth.ts` 和 `auth/index.ts` 中重复定义

**建议**: 提取公共 API 函数，按功能模块统一组织

---

#### 4. Token 刷新机制不完善
**发现者**: 前端开发

**问题**:
- `common/request.ts` 完全没有 token 刷新逻辑
- `utils/request.ts` 有刷新但缺少并发控制

**建议**: 添加并发控制，防止多个请求同时触发刷新

---

### 后端问题

#### 5. Customer 获取连接信息缺少权限校验（高优先级）
**发现者**: 后端开发

**位置**: `my_machine_controller.go:75-83` (GetConnection)

**问题**: 只需认证，不校验机器是否属于当前用户，任何已认证用户可以获取任意机器的连接信息

**建议**: 添加 `ValidateHostOwnership` 校验

---

#### 6. 路由重复注册
**发现者**: 后端开发 + 架构师

**位置**: `router.go:220` 和 `router.go:240`

**问题**: `POST /customer/machines` 和 `POST /customer/machines/enroll` 都指向同一个 handler

**建议**: 删除其中一个

---

#### 7. CORS 配置过于宽松
**发现者**: 架构师

**位置**: `backend/internal/middleware/cors.go:10`

**问题**: `Access-Control-Allow-Origin: *` 允许所有来源跨域访问

**建议**: 生产环境限制为具体域名

---

#### 8. 默认密码硬编码
**发现者**: 后端开发

**位置**: `customer_controller.go:50-53`

**问题**: 创建客户时默认密码为 `"ChangeME_123"`，硬编码在代码中

**建议**: 从配置文件读取或使用随机生成

---

### 部署问题

#### 9. docker-compose-infrastructure.yml 与独立配置重复
**发现者**: 运维

**问题**:
- 根目录的 `docker-compose-infrastructure.yml` 定义了 Redis + Prometheus + Grafana
- 但 `docker-compose/` 下各自也有独立的 compose 文件
- 独立版本配置更完善，根目录版本使用 `latest` 标签且硬编码密码

**建议**: 删除根目录的 `docker-compose-infrastructure.yml`，统一使用 `docker-compose/` 下的配置

---

#### 10. Docker Compose 版本不一致
**发现者**: 运维

**问题**: 大部分使用 `version: '3.8'`，但有的使用 `3.9`

**建议**: 统一为 `3.8` 或移除 version 字段

---

#### 11. 网络隔离不足
**发现者**: 运维

**问题**: 所有服务都使用同一个 `remotegpu-network` bridge 网络

**建议**: 分为 `frontend-net`、`backend-net`、`monitoring-net`

---

### 数据库问题

#### 12. 文档与实际 Schema 不一致
**发现者**: 架构师

**问题**:
- 文档中 `customers` 表有 `balance` 和 `role` 字段，实际没有
- 文档中 `hosts.total_memory_gb`，实际是 `total_memory`（BIGINT）

**建议**: 同步更新文档或迁移脚本

---

#### 13. 主键策略不统一
**发现者**: 架构师

**问题**: 混用 BIGSERIAL、VARCHAR(64)、UUID

**建议**: 统一主键策略（建议全部使用 UUID）

---

#### 14. 缺少外键约束
**发现者**: 架构师

**问题**: 大部分表之间没有外键约束

**建议**: 明确策略：应用层保证或 DB 层约束

---

## 🟢 P2 级别问题（可延后优化）

### 前端问题
1. 多个页面使用模拟数据，API 未对接
2. `formatDate` 等函数在多个组件中重复实现
3. 客户任务路由重复（5 个路由指向同一个组件）
4. Pinia 状态持久化不规范
5. Machine 接口过大（超过 100 行）
6. AdminSidebar 和 CustomerSidebar 代码重复
7. 配置文件不完善（缺少 `.env.production`）
8. ESLint 缺少自定义规则

### 后端问题
1. HTTP 轮询效率低（考虑 WebSocket 或 gRPC）
2. 心跳不携带系统指标
3. 进度上报固定为 0%
4. 时序数据无分区策略
5. 全局配置变量（应改为依赖注入）
6. 错误码不一致（混用 HTTP 状态码和业务错误码）
7. 部分 Controller 未使用 `HandleError`

### Agent 问题
1. 任务调度器的进度上报无实际数据
2. 心跳缺少系统指标（CPU/内存/GPU）

---

## 📈 项目成熟度评估

| 维度 | 评分 | 说明 |
|------|------|------|
| 架构设计 | 8/10 | 分层清晰，文档完善，技术选型合理 |
| 数据库设计 | 6/10 | 覆盖全面但有重复定义和文档不同步 |
| API 设计 | 7/10 | 基本符合 RESTful，OpenAPI 文档需补全 |
| 安全性 | 3/10 | **严重问题**：Agent 无认证、SSH 明文、配置泄露 |
| 代码质量 | 7/10 | 分层规范良好，有并发安全和状态校验缺陷 |
| 前端质量 | 6/10 | 组件质量好，但类型混乱、API 重复 |
| 部署配置 | 6/10 | 服务拆分合理，但配置重复、安全问题严重 |

**整体评估**: 项目约 70% 完成，架构设计优秀，但存在严重的安全问题需要立即修复。

---

## 🎯 建议的修复顺序

### 第一阶段：安全加固（1-2天，必须立即执行）
1. ✅ 清理 git 中的敏感配置（运维）
2. ✅ 创建 config.yaml.example，删除 config.yaml
3. ✅ 为 Agent API 添加认证中间件（后端）
4. ✅ 实现 SSH 凭据加密存储（后端）
5. ✅ 修复 host_metrics 表重复定义（后端）
6. ✅ 添加机器分配行级锁（后端）
7. ✅ 回收前检查运行中任务（后端）

### 第二阶段：核心功能完善（3-5天）
1. 统一前端 axios 实例（前端）
2. 统一 TypeScript 类型命名（前端）
3. 清理重复的 API 函数（前端）
4. 修复 Customer 权限校验（后端）
5. 实现 Redis 缓存接入（后端，任务 #10）
6. 实现 IP 唯一性校验（后端，任务 #11）
7. 完成前端登录页面（前端，任务 #12）
8. 完成前端机器列表（前端，任务 #13）
9. 部署基础设施（运维，任务 #14）

### 第三阶段：功能增强（1-2周）
1. Agent 服务开发（任务进程管理、SSH 重置、机器清理）
2. GPU 监控集成（Prometheus + nvidia_gpu_exporter）
3. Harbor 镜像同步
4. 前端核心页面开发（仪表板、机器管理、任务管理等）

### 第四阶段：高级功能（2-3周，可选）
1. 远程访问服务（VNC/RDP/Guacamole）
2. DNS 管理
3. 防火墙管理
4. Docker 容器管理

---

## 📝 团队成员贡献

### 🏗️ 架构师
- 完成了全面的架构分析和数据库设计审查
- 识别了 5 个 P0 级安全问题
- 提供了详细的优化建议和实施路线图

### 💻 后端开发
- 修复了编译错误（重复的 main 函数）
- 完成了后端 API 审查，识别了安全和代码质量问题
- 提供了 RESTful 设计改进建议

### 🎨 前端开发
- 完成了前端代码全面审查
- 识别了类型混乱、API 重复等严重问题
- 提供了详细的改进优先级建议

### 🔧 运维
- 清理了 6 个备份 SQL 文件和 5 个测试脚本
- 完成了部署配置审查，发现了严重的安全配置问题
- 更新了 .gitignore 防止敏感文件再次提交

---

**报告生成时间**: 2026-02-07
**团队**: remotegpu-dev-team
**下一步**: 立即执行第一阶段安全加固任务
