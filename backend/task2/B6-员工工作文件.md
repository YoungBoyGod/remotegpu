# B6 - Environment 核心逻辑任务

## 👤 员工信息

**员工编号**: B6
**负责模块**: Environment 核心业务逻辑
**优先级**: P0（最终交付）
**预估工时**: 40 小时
**开始日期**: 2026-02-04（等待 B1-B5 全部完成）
**预计完成**: 2026-02-11

---

## 📋 任务背景

### 当前状态
- ✅ `service/environment.go` 已存在
- ❌ 环境创建逻辑缺失（主机选择、GPU分配、配额检查、K8s集成）
- ❌ 生命周期管理缺失（启动、停止、重启、删除）
- ❌ Controller 层缺失
- ❌ 完整的集成测试缺失

### 依赖关系
**依赖所有前置任务**:
- **B1**: Workspace 模型和权限检查
- **B2**: ResourceQuota 配额检查
- **B3**: K8s Pod 管理
- **B4**: K8s Service 管理
- **B5**: Environment 和 PortMapping 模型

**这是最终交付任务，完成后整个环境管理功能链路打通！**

---

## 🎯 交付目标

### 必须交付
- [ ] 环境创建完整流程（主机选择、GPU分配、配额检查、K8s集成）
- [ ] 环境生命周期管理（启动、停止、重启、删除）
- [ ] EnvironmentService 完整实现
- [ ] EnvironmentController 完整实现
- [ ] API 路由配置
- [ ] 事务处理和回滚机制
- [ ] 完整的单元测试和集成测试

---

## 📝 详细任务清单

### Task B6.1: 环境创建逻辑 (16h)

#### 子任务

**B6.1.1 主机选择算法** (3h)
- [ ] 检查 `internal/service/environment.go`
- [ ] 实现 `selectHost(cpu, memory, gpuCount int) (*entity.Host, error)`
- [ ] 查询可用主机（状态为 active）
- [ ] 过滤资源不足的主机
- [ ] 按资源使用率排序（负载均衡）
- [ ] 编写单元测试

**B6.1.2 GPU 分配逻辑** (3h)
- [ ] 实现 `allocateGPUs(hostID uint, count int) ([]uint, error)`
- [ ] 查询主机上可用的 GPU
- [ ] 使用事务和行锁防止并发冲突
- [ ] 更新 GPU 状态为 allocated
- [ ] 实现 `releaseGPUs(gpuIDs []uint) error`
- [ ] 编写并发测试

**B6.1.3 配额检查集成** (2h)
- [ ] 集成 ResourceQuotaService
- [ ] 在创建前检查配额
- [ ] 配额不足时返回详细错误
- [ ] 编写测试

**B6.1.4 K8s Pod 创建集成** (5h)
- [ ] 集成 K8s 客户端
- [ ] 构建 Pod 配置（镜像、命令、参数、资源限制、GPU、环境变量、卷挂载）
- [ ] 创建 PVC（如果需要）
- [ ] 创建 Pod
- [ ] 创建 Service（端口映射）
- [ ] 等待 Pod 启动
- [ ] 记录访问信息
- [ ] 编写测试

**B6.1.5 事务处理和回滚** (3h)
- [ ] 实现完整的事务流程
- [ ] 实现回滚逻辑（释放 GPU、删除 K8s 资源、删除记录）
- [ ] 添加错误处理
- [ ] 编写错误场景测试

---

### Task B6.2: 生命周期管理 (12h)

#### 子任务

**B6.2.1 StartEnvironment** (3h)
- [ ] 实现 `StartEnvironment(id uint) error`
- [ ] 检查环境状态
- [ ] 调用 K8s API 启动 Pod
- [ ] 更新环境状态
- [ ] 编写测试

**B6.2.2 StopEnvironment** (3h)
- [ ] 实现 `StopEnvironment(id uint) error`
- [ ] 检查环境状态
- [ ] 调用 K8s API 停止 Pod
- [ ] 更新环境状态
- [ ] 编写测试

**B6.2.3 RestartEnvironment** (2h)
- [ ] 实现 `RestartEnvironment(id uint) error`
- [ ] 调用 Stop 然后 Start
- [ ] 编写测试

**B6.2.4 DeleteEnvironment** (4h)
- [ ] 实现 `DeleteEnvironment(id uint) error`
- [ ] 删除 K8s 资源（Pod、Service、PVC）
- [ ] 释放 GPU
- [ ] 释放端口
- [ ] 删除记录
- [ ] 使用事务确保一致性
- [ ] 编写测试

---

### Task B6.3: Service 层完善 (4h)

#### 子任务
- [ ] 实现 `GetEnvironment(id uint) (*entity.Environment, error)`
- [ ] 实现 `ListEnvironments(customerID uint, filters map[string]interface{}) ([]*entity.Environment, error)`
- [ ] 实现 `GetAccessInfo(id uint) (map[string]interface{}, error)`
- [ ] 实现 `GetLogs(id uint, opts *LogOptions) (string, error)`
- [ ] 实现 `GetStatus(id uint) (string, error)`
- [ ] 添加权限检查
- [ ] 编写测试

---

### Task B6.4: Controller 层 (4h)

#### 子任务
- [ ] 创建 `internal/controller/v1/environment.go`
- [ ] 实现 CRUD 接口（Create, GetByID, List, Delete）
- [ ] 实现操作接口（Start, Stop, Restart）
- [ ] 实现信息接口（GetAccessInfo, GetLogs）
- [ ] 添加参数验证
- [ ] 编写 Controller 测试

#### API 接口
```
POST   /api/v1/environments              - 创建环境
GET    /api/v1/environments/:id          - 获取环境
GET    /api/v1/environments              - 环境列表
DELETE /api/v1/environments/:id          - 删除环境
POST   /api/v1/environments/:id/start    - 启动
POST   /api/v1/environments/:id/stop     - 停止
POST   /api/v1/environments/:id/restart  - 重启
GET    /api/v1/environments/:id/access   - 访问信息
GET    /api/v1/environments/:id/logs     - 日志
```

---

### Task B6.5: 路由配置 (1h)

#### 子任务
- [ ] 在 `internal/router/router.go` 中添加路由
- [ ] 配置认证和权限中间件
- [ ] 测试路由

---

### Task B6.6: 集成测试 (3h)

#### 子任务
- [ ] 测试完整创建流程
- [ ] 测试生命周期管理
- [ ] 测试配额检查
- [ ] 测试 GPU 分配
- [ ] 测试错误场景和回滚
- [ ] 端到端测试

---

## 🧪 测试策略

### 单元测试
- 主机选择算法
- GPU 分配逻辑
- 配额检查
- 生命周期管理
- 错误处理
- 回滚逻辑

### 集成测试
- 完整创建流程
- 生命周期管理
- 并发创建
- 错误场景

### 测试环境
- 测试数据库
- K8s 测试集群
- 测试数据准备

---

## ⚠️ 注意事项

### 事务处理

**创建环境事务**:
```
开始事务
→ 检查配额
→ 选择主机
→ 分配 GPU
→ 分配端口
→ 创建 Environment 记录
→ 创建 K8s Pod
→ 提交事务

如果失败 → 回滚所有操作
```

**删除环境事务**:
```
开始事务
→ 删除 K8s 资源
→ 释放 GPU
→ 释放端口
→ 删除记录
→ 提交事务
```

### 常见问题

**Q: 如何处理 K8s 创建失败？**
A: 回滚所有已分配的资源（GPU、端口、数据库记录）。

**Q: 如何处理并发创建？**
A: 使用数据库事务和行锁，确保资源分配的原子性。

---

## ✅ 完成检查清单

### 代码质量
- [ ] 所有代码通过 `go fmt` 和 `go vet`
- [ ] 所有公开方法有注释
- [ ] 错误处理完善
- [ ] 事务处理正确

### 测试质量
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 集成测试通过
- [ ] 错误场景测试充分

### 文档
- [ ] 代码注释完整
- [ ] API 文档完整
- [ ] 使用文档

### 提交
- [ ] 所有代码已提交
- [ ] 代码审查通过
- [ ] 已更新进度文档

### 通知
- [ ] 已通知团队完成
- [ ] 已更新项目文档

---

**文档版本**: v1.0
**创建时间**: 2026-01-30
