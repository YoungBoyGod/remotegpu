# B5 - Environment æ¨¡åž‹å®Œæˆä»»åŠ¡

## ðŸ‘¤ å‘˜å·¥ä¿¡æ¯

**å‘˜å·¥ç¼–å·**: B5
**è´Ÿè´£æ¨¡å—**: Environment å’Œ PortMapping æ¨¡åž‹
**ä¼˜å…ˆçº§**: P0
**é¢„ä¼°å·¥æ—¶**: 10 å°æ—¶
**å¼€å§‹æ—¥æœŸ**: 2026-02-01ï¼ˆç­‰å¾… B1 å®Œæˆï¼‰
**é¢„è®¡å®Œæˆ**: 2026-02-02

---

## ðŸ“‹ ä»»åŠ¡èƒŒæ™¯

### å½“å‰çŠ¶æ€
- âœ… `entity/environment_test.go` å·²å­˜åœ¨
- âŒ Environment Entity å®žçŽ°å¾…ç¡®è®¤
- âŒ PortMapping Entity ç¼ºå¤±
- âŒ EnvironmentDao ç¼ºå¤±
- âŒ PortMappingDao ç¼ºå¤±ï¼ˆç«¯å£åˆ†é…é€»è¾‘ï¼‰

### ä¾èµ–å…³ç³»
- **ä¾èµ– B1**: éœ€è¦ Workspace å®žä½“å®Œæˆ
- **é˜»å¡ž B6**: çŽ¯å¢ƒåˆ›å»ºéœ€è¦ Environment æ¨¡åž‹

---

## ðŸŽ¯ äº¤ä»˜ç›®æ ‡

### å¿…é¡»äº¤ä»˜
- [ ] Environment å®žä½“æ¨¡åž‹ï¼ˆå®Œæ•´ï¼‰
- [ ] PortMapping å®žä½“æ¨¡åž‹
- [ ] EnvironmentDaoï¼ˆå®Œæ•´ CRUDï¼‰
- [ ] PortMappingDaoï¼ˆç«¯å£åˆ†é…é€»è¾‘ï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–çŽ‡ > 80%

---

## ðŸ“ è¯¦ç»†ä»»åŠ¡æ¸…å•

### Task B5.1: Environment å®žä½“ (3h)

#### å­ä»»åŠ¡
- [ ] æ£€æŸ¥ `internal/model/entity/environment.go`
- [ ] å®žçŽ°æˆ–è¡¥å…… Environment ç»“æž„ä½“ï¼š
  - åŸºç¡€å­—æ®µï¼ˆID, UUID, Name, Statusï¼‰
  - å…³è”å­—æ®µï¼ˆCustomerID, WorkspaceID, HostIDï¼‰
  - é…ç½®å­—æ®µï¼ˆImage, Command, Args, Envï¼‰
  - èµ„æºå­—æ®µï¼ˆCPU, Memory, GPUIDs, Storageï¼‰
  - JSONB å­—æ®µé…ç½®ï¼ˆCommand, Args, Env, GPUIDs, AccessInfoï¼‰
- [ ] æ·»åŠ å…³è”å…³ç³»ï¼ˆCustomer, Workspace, Host, PortMappingsï¼‰
- [ ] ç¼–å†™æˆ–è¡¥å……å•å…ƒæµ‹è¯•

---

### Task B5.2: PortMapping å®žä½“ (2h)

#### å­ä»»åŠ¡
- [ ] åœ¨ `environment.go` ä¸­æ·»åŠ  PortMapping ç»“æž„ä½“
- [ ] å®šä¹‰å­—æ®µï¼ˆEnvironmentID, HostID, ContainerPort, HostPort, Protocolï¼‰
- [ ] æ·»åŠ å”¯ä¸€çº¦æŸï¼ˆHostID, HostPort, Protocolï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

---

### Task B5.3: EnvironmentDao (2h)

#### å­ä»»åŠ¡
- [ ] åˆ›å»º `internal/dao/environment.go`
- [ ] å®žçŽ° CRUD æ–¹æ³•ï¼ˆCreate, GetByID, GetByUUID, Update, Deleteï¼‰
- [ ] å®žçŽ°æŸ¥è¯¢æ–¹æ³•ï¼ˆGetByCustomerID, GetByWorkspaceID, GetByHostID, GetByStatus, Listï¼‰
- [ ] æ”¯æŒå…³è”æ•°æ®åŠ è½½ï¼ˆPreloadï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

---

### Task B5.4: PortMappingDao å’Œç«¯å£åˆ†é… (3h)

#### å­ä»»åŠ¡
- [ ] åœ¨ `environment.go` ä¸­å®žçŽ° PortMappingDao
- [ ] å®žçŽ°ç«¯å£åˆ†é…é€»è¾‘ï¼š
  - `AllocatePort(hostID uint, containerPort int, protocol string) (*entity.PortMapping, error)`
  - æŸ¥è¯¢å·²ä½¿ç”¨ç«¯å£
  - ä»Žç«¯å£èŒƒå›´åˆ†é…ï¼ˆ30000-32767ï¼‰
  - ä½¿ç”¨äº‹åŠ¡å’Œè¡Œé”é˜²æ­¢å¹¶å‘å†²çª
- [ ] å®žçŽ° `ReleasePort(id uint) error`
- [ ] å®žçŽ°æŸ¥è¯¢æ–¹æ³•ï¼ˆGetByEnvironmentID, GetByHostIDï¼‰
- [ ] ç¼–å†™å¹¶å‘æµ‹è¯•

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] Environment å®žä½“å®Œæˆ
- [ ] PortMapping å®žä½“å®Œæˆ
- [ ] EnvironmentDao å®Œæˆ
- [ ] PortMappingDao å®Œæˆ
- [ ] ç«¯å£åˆ†é…é€»è¾‘æ­£ç¡®
- [ ] å¹¶å‘å®‰å…¨
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–çŽ‡ > 80%
- [ ] å·²é€šçŸ¥ B6

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2026-01-30
