# B1 - Workspace 模块完成任务

## 👤 员工信息

**员工编号**: B1
**负责模块**: Workspace 管理模块完成
**优先级**: P0（最高优先级）
**预估工时**: 12 小时
**开始日期**: 2026-01-31
**预计完成**: 2026-02-01

---

## 📋 任务背景

### 当前状态
- ✅ `service/workspace.go` 和 `service/workspace_test.go` 已存在
- ❌ Entity 层缺失或不完整
- ❌ DAO 层缺失或不完整
- ❌ Controller 层缺失
- ❌ 路由配置缺失

### 为什么重要
Workspace 是其他模块的基础依赖：
- **B2 (ResourceQuota)** 需要 WorkspaceID 外键
- **B5 (Environment)** 需要 WorkspaceID 外键
- **B6 (Environment 逻辑)** 需要 Workspace 权限检查

**这是关键路径上的第一个任务，必须优先完成！**

---

## 🎯 交付目标

### 必须交付
- [ ] Workspace 实体模型（完整）
- [ ] WorkspaceMember 实体模型
- [ ] WorkspaceDao（完整 CRUD + 测试）
- [ ] WorkspaceMemberDao（完整 CRUD + 测试）
- [ ] WorkspaceService（补充缺失部分）
- [ ] WorkspaceController（完整实现）
- [ ] API 路由配置
- [ ] 单元测试覆盖率 > 80%

### 质量标准
- 所有代码通过 `go fmt` 和 `go vet`
- 所有公开方法有完整注释
- 错误处理完善
- 测试覆盖所有主要功能

---

## 📝 详细任务清单

### Task B1.1: 检查和完善 Entity 层 (3h)

**优先级**: P0
**依赖**: 无

#### 子任务

**B1.1.1 检查现有实现** (0.5h)
- [ ] 检查 `internal/model/entity/workspace.go` 是否存在
- [ ] 如果存在，检查字段完整性
- [ ] 检查 GORM 标签是否正确
- [ ] 检查关联关系是否完整

**B1.1.2 实现或补充 Workspace 实体** (1.5h)
- [ ] 创建或更新 `internal/model/entity/workspace.go`
- [ ] 定义 Workspace 结构体：
  ```go
  type Workspace struct {
      ID          uint           `gorm:"primaryKey" json:"id"`
      UUID        string         `gorm:"uniqueIndex;size:36" json:"uuid"`
      Name        string         `gorm:"size:100;not null" json:"name"`
      OwnerID     uint           `gorm:"not null;index" json:"owner_id"`
      Description string         `gorm:"type:text" json:"description"`
      Status      string         `gorm:"size:20;default:'active'" json:"status"`
      CreatedAt   time.Time      `json:"created_at"`
      UpdatedAt   time.Time      `json:"updated_at"`
      DeletedAt   gorm.DeletedAt `gorm:"index" json:"-"`

      // 关联
      Owner   *Customer          `gorm:"foreignKey:OwnerID" json:"owner,omitempty"`
      Members []WorkspaceMember  `gorm:"foreignKey:WorkspaceID" json:"members,omitempty"`
  }
  ```
- [ ] 实现 `TableName()` 方法返回 "workspaces"
- [ ] 添加字段注释

**B1.1.3 实现 WorkspaceMember 实体** (1h)
- [ ] 在同一文件中定义 WorkspaceMember：
  ```go
  type WorkspaceMember struct {
      ID          uint      `gorm:"primaryKey" json:"id"`
      WorkspaceID uint      `gorm:"not null;uniqueIndex:idx_workspace_customer" json:"workspace_id"`
      CustomerID  uint      `gorm:"not null;uniqueIndex:idx_workspace_customer" json:"customer_id"`
      Role        string    `gorm:"size:20;not null" json:"role"`
      JoinedAt    time.Time `gorm:"not null" json:"joined_at"`

      // 关联
      Workspace *Workspace `gorm:"foreignKey:WorkspaceID" json:"workspace,omitempty"`
      Customer  *Customer  `gorm:"foreignKey:CustomerID" json:"customer,omitempty"`
  }
  ```
- [ ] 实现 `TableName()` 方法返回 "workspace_members"

#### 验收标准
- [ ] 文件创建或更新成功
- [ ] 所有字段定义正确
- [ ] GORM 标签完整
- [ ] 关联关系正确
- [ ] 代码通过 `go fmt` 和 `go vet`

#### Git 提交
```bash
git add internal/model/entity/workspace.go
git commit -m "[Workspace] 完善 Workspace 和 WorkspaceMember 实体模型

- 实现完整的 Workspace 结构体
- 实现 WorkspaceMember 结构体
- 添加所有必需字段和 GORM 标签
- 添加关联关系
"
```

---

### Task B1.2: 实现 DAO 层 (4h)

**优先级**: P0
**依赖**: Task B1.1

#### 子任务

**B1.2.1 实现 WorkspaceDao** (2h)
- [ ] 创建 `internal/dao/workspace.go`
- [ ] 实现基础 CRUD：
  - `Create(workspace *entity.Workspace) error`
  - `GetByID(id uint) (*entity.Workspace, error)`
  - `GetByUUID(uuid string) (*entity.Workspace, error)`
  - `Update(workspace *entity.Workspace) error`
  - `Delete(id uint) error`
- [ ] 实现查询方法：
  - `GetByOwnerID(ownerID uint) ([]*entity.Workspace, error)`
  - `List(page, pageSize int) ([]*entity.Workspace, int64, error)`
  - `GetByStatus(status string) ([]*entity.Workspace, error)`

**B1.2.2 实现 WorkspaceMemberDao** (1h)
- [ ] 在同一文件中实现 WorkspaceMemberDao
- [ ] 实现基础 CRUD：
  - `CreateMember(member *entity.WorkspaceMember) error`
  - `GetMemberByID(id uint) (*entity.WorkspaceMember, error)`
  - `DeleteMember(id uint) error`
- [ ] 实现查询方法：
  - `GetMembersByWorkspaceID(workspaceID uint) ([]*entity.WorkspaceMember, error)`
  - `GetMembersByCustomerID(customerID uint) ([]*entity.WorkspaceMember, error)`
  - `GetMember(workspaceID, customerID uint) (*entity.WorkspaceMember, error)`

**B1.2.3 编写 DAO 测试** (1h)
- [ ] 创建 `internal/dao/workspace_test.go`
- [ ] 测试所有 CRUD 方法
- [ ] 测试查询方法
- [ ] 测试唯一约束
- [ ] 测试错误处理

#### 验收标准
- [ ] 所有方法实现正确
- [ ] 错误处理完善
- [ ] 测试通过
- [ ] 测试覆盖率 > 80%

#### Git 提交
```bash
git add internal/dao/workspace.go internal/dao/workspace_test.go
git commit -m "[Workspace] 实现 WorkspaceDao 和 WorkspaceMemberDao

- 实现完整的 CRUD 方法
- 实现查询方法
- 添加单元测试
- 测试覆盖率: XX%
"
```

---

### Task B1.3: 检查和完善 Service 层 (2h)

**优先级**: P0
**依赖**: Task B1.2

#### 子任务

**B1.3.1 检查现有实现** (0.5h)
- [ ] 检查 `internal/service/workspace.go` 的完整性
- [ ] 检查是否有缺失的方法
- [ ] 检查错误处理是否完善

**B1.3.2 补充缺失功能** (1h)
- [ ] 确保以下方法存在：
  - `CreateWorkspace(workspace *entity.Workspace) error`
  - `GetWorkspace(id uint) (*entity.Workspace, error)`
  - `UpdateWorkspace(workspace *entity.Workspace) error`
  - `DeleteWorkspace(id uint) error`
  - `ListWorkspaces(ownerID uint, page, pageSize int) ([]*entity.Workspace, int64, error)`
  - `AddMember(workspaceID, customerID uint, role string) error`
  - `RemoveMember(workspaceID, customerID uint) error`
  - `ListMembers(workspaceID uint) ([]*entity.WorkspaceMember, error)`
  - `CheckPermission(workspaceID, customerID uint) (bool, error)`

**B1.3.3 完善测试** (0.5h)
- [ ] 检查 `internal/service/workspace_test.go`
- [ ] 补充缺失的测试用例
- [ ] 确保测试覆盖率 > 80%

#### Git 提交
```bash
git add internal/service/workspace.go internal/service/workspace_test.go
git commit -m "[Workspace] 完善 WorkspaceService

- 补充缺失的方法
- 完善错误处理
- 补充测试用例
"
```

---

### Task B1.4: 实现 Controller 层 (2h)

**优先级**: P0
**依赖**: Task B1.3

#### 子任务

**B1.4.1 实现 WorkspaceController** (1.5h)
- [ ] 创建 `internal/controller/v1/workspace.go`
- [ ] 实现接口：
  - `Create(c *gin.Context)` - 创建工作空间
  - `GetByID(c *gin.Context)` - 获取工作空间详情
  - `List(c *gin.Context)` - 工作空间列表
  - `Update(c *gin.Context)` - 更新工作空间
  - `Delete(c *gin.Context)` - 删除工作空间
  - `AddMember(c *gin.Context)` - 添加成员
  - `RemoveMember(c *gin.Context)` - 移除成员
  - `ListMembers(c *gin.Context)` - 成员列表

**B1.4.2 编写 Controller 测试** (0.5h)
- [ ] 创建 `internal/controller/v1/workspace_test.go`
- [ ] 测试所有接口
- [ ] 测试参数验证
- [ ] 测试错误处理

#### Git 提交
```bash
git add internal/controller/v1/workspace.go internal/controller/v1/workspace_test.go
git commit -m "[Workspace] 实现 WorkspaceController

- 实现所有 REST API 接口
- 添加参数验证
- 添加单元测试
"
```

---

### Task B1.5: 配置路由 (1h)

**优先级**: P0
**依赖**: Task B1.4

#### 子任务

**B1.5.1 添加路由配置** (1h)
- [ ] 编辑 `internal/router/router.go`
- [ ] 添加 Workspace 路由组
- [ ] 配置路由：
  ```
  POST   /api/v1/workspaces              - 创建工作空间
  GET    /api/v1/workspaces/:id          - 获取工作空间
  GET    /api/v1/workspaces              - 工作空间列表
  PUT    /api/v1/workspaces/:id          - 更新工作空间
  DELETE /api/v1/workspaces/:id          - 删除工作空间
  POST   /api/v1/workspaces/:id/members  - 添加成员
  DELETE /api/v1/workspaces/:id/members/:customer_id - 移除成员
  GET    /api/v1/workspaces/:id/members  - 成员列表
  ```
- [ ] 配置认证中间件
- [ ] 测试路由是否正常工作

#### Git 提交
```bash
git add internal/router/router.go
git commit -m "[Workspace] 配置 Workspace 路由

- 添加所有 Workspace API 路由
- 配置认证中间件
"
```

---

## 🧪 测试策略

### 单元测试
- **Entity 层**: 测试结构体创建、GORM 标签
- **DAO 层**: 测试所有 CRUD 和查询方法
- **Service 层**: 测试业务逻辑、权限检查
- **Controller 层**: 测试 HTTP 接口、参数验证

### 运行测试
```bash
# 运行所有测试
go test -v ./internal/model/entity/... ./internal/dao/... ./internal/service/... ./internal/controller/v1/...

# 检查覆盖率
go test -cover ./internal/...

# 生成覆盖率报告
go test -coverprofile=coverage.out ./internal/...
go tool cover -html=coverage.out
```

---

## 📦 依赖和阻塞

### 输入依赖
- ✅ Customer 模型（已完成）
- ✅ 数据库连接（已完成）

### 输出依赖（阻塞其他任务）
- → **B2**: ResourceQuota 需要 WorkspaceID 外键
- → **B5**: Environment 需要 WorkspaceID 外键
- → **B6**: 环境创建需要 Workspace 权限检查

**完成后立即通知 B2 和 B5！**

---

## ⚠️ 注意事项

### 开发规范
1. 遵循 Go 官方代码规范
2. 所有公开方法必须有注释
3. 使用 `go fmt` 格式化代码
4. 使用 `go vet` 检查代码

### 常见问题

**Q: Workspace 的 UUID 如何生成？**
A: 使用 `github.com/google/uuid` 包生成 UUID v4。

**Q: 如何处理软删除？**
A: 使用 GORM 的 `gorm.DeletedAt` 字段，GORM 会自动处理。

**Q: 成员角色有哪些？**
A: owner（所有者）、admin（管理员）、member（成员）、viewer（查看者）

---

## ✅ 完成检查清单

### 代码质量
- [ ] 所有代码通过 `go fmt`
- [ ] 所有代码通过 `go vet`
- [ ] 所有公开方法有注释
- [ ] 错误处理完善

### 测试质量
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 边界条件测试

### 提交
- [ ] 所有代码已提交
- [ ] 提交信息规范
- [ ] 代码已推送到远程

### 通知
- [ ] 已通知 B2（ResourceQuota）
- [ ] 已通知 B5（Environment）
- [ ] 已更新进度文档

---

**文档版本**: v1.0
**创建时间**: 2026-01-30
