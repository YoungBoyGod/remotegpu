# 功能实现任务清单（建议顺序）

按优先级拆分为可执行任务，方便直接转成 issue。

## P0 - 登录与鉴权闭环

- [x] 完成刷新令牌 `/api/v1/auth/refresh`
  - 注意点：refresh token 存储到 DB/Redis，需支持过期清理。
- [x] 鉴权中间件校验 token 黑名单
  - 注意点：登出后 token 立刻失效。
  - 完成：`internal/middleware/auth.go` 已实现 Redis 黑名单校验
- [x] 登录失败原因细化
  - 注意点：区分密码错误/账号不存在/账号禁用，避免泄露过多信息。
- [x] 统一账号状态校验（login + middleware）
  - 注意点：`status != active` 直接拒绝访问。

## P1 - 权限与管理端基础

- [x] 增加 `RequireRole("admin")` 中间件
  - 注意点：对 `/admin/*` 全量保护。
  - 完成：`internal/middleware/role.go` 中的 `RequireAdmin()`
- [x] 管理端仪表盘补齐数据源
  - 路由：`/admin/dashboard/gpu-trend`、`/admin/allocations/recent`
  - 注意点：时间维度、分页与缓存。
  - 完成：已接入真实数据源，GPU趋势待接入监控系统(TODO)
- [x] 镜像管理 `/admin/images`
  - 注意点：字段设计（名称/标签/大小/来源/状态），避免重复导入。
  - 完成：列表接口已实现
- [x] 镜像同步 `/admin/images/sync`
  - 注意点：Harbor/本地仓库同步策略、失败重试。
  - 完成：已添加路由和Service方法，具体同步逻辑待接入Harbor SDK
- [x] 系统审计 `/admin/audit/logs`
  - 注意点：关键操作落库、索引与检索条件。
  - 完成：支持按操作类型、资源类型、用户名筛选

## P1 - 机器管理闭环

- [x] 机器导入 `/admin/machines/import`
  - 注意点：模板字段、校验失败回报、幂等导入。
  - 完成：已实现 JSON 批量导入接口
- [x] 分配机器 `/admin/machines/:id/allocate`
  - 注意点：状态合法性、租期校验、事务一致性。
  - 完成：已实现分配逻辑，包含状态检查和事务处理
- [x] 回收机器 `/admin/machines/:id/reclaim`
  - 注意点：审计记录、异步回收流程。
  - 完成：已实现回收逻辑和审计日志记录，异步清理待实现

## P2 - 客户端功能闭环

- [x] SSH 公钥管理 `/customer/keys`
  - 注意点：公钥格式校验、fingerprint 去重、权限隔离。
  - 完成：支持 ssh-rsa/ed25519/ecdsa，SHA256 指纹去重
- [x] 按用户过滤 `/customer/machines`
  - 注意点：从 JWT 读取用户/租户信息。
  - 完成：从JWT获取userID，通过AllocationService查询用户分配的机器
- [x] 任务创建/停止绑定用户
  - 路由：`/customer/tasks/*`
  - 注意点：权限校验与状态机。
  - 完成：List/CreateTraining/Stop均从JWT获取userID，Stop添加权限校验
- [x] 数据集隔离与挂载
  - 路由：`/customer/datasets/*`
  - 注意点：权限隔离、挂载路径合法性。
  - 完成：List/Mount均从JWT获取userID，Mount添加数据集所有权校验

## P2 - 监控与告警

- [x] 监控快照 `/admin/monitoring/realtime`
  - 注意点：采样频率与缓存。
  - 完成：MonitorService接入MachineService获取真实数据，缓存待接入Redis
- [x] 告警列表 `/admin/alerts`
  - 注意点：告警来源、去重与确认机制。
  - 完成：支持分页、筛选（severity/acknowledged），新增确认接口

## P3 - 运维与体验

- [ ] Swagger/OpenAPI 文档完善
  - 注意点：补齐鉴权、错误码、分页模型。
