# RemoteGPU 模块化架构设计文档

## 1. 概述

本文档描述 RemoteGPU 项目的模块化架构设计,将各种功能抽象为独立的包,通过统一的接口进行集成。

### 1.1 设计目标

- **模块化**: 每个功能模块独立封装
- **可扩展**: 易于添加新的实现
- **统一接口**: 提供一致的使用方式
- **松耦合**: 模块之间低依赖
- **易测试**: 每个模块可独立测试

### 1.2 核心模块

```
pkg/
├── volume/          # 存储卷配置管理
├── remote/          # 远程访问管理
├── network/         # 网络配置管理
├── security/        # 安全认证管理
└── deployment/      # 部署配置管理
```

---

## 2. 存储卷配置模块 (pkg/volume)

### 2.1 模块职责

管理环境部署时的存储挂载配置,支持多种存储类型。

### 2.2 支持的存储类型

- **NFS**: 网络文件系统
- **S3**: 对象存储 (AWS S3, MinIO, OSS, COS)
- **JuiceFS**: 分布式文件系统
- **Ceph**: 分布式存储
- **PVC**: Kubernetes 持久卷
- **Local**: 本地存储

### 2.3 核心接口

```go
type VolumeConfig interface {
    GetType() VolumeType
    Validate() error
    GetMountPoint() string
    GetK8sVolume(envID string) *K8sVolume
    GetDockerVolume(envID string) *DockerVolume
}
```

### 2.4 实现状态

- ✅ 基础接口定义
- ✅ NFS 配置实现
- ✅ S3 配置实现
- ✅ JuiceFS 配置实现
- ✅ 配置管理器
- ⏳ Ceph 配置实现
- ⏳ PVC 配置实现
- ⏳ Local 配置实现

---

## 3. 远程访问模块 (pkg/remote)

### 3.1 模块职责

管理环境的远程访问配置,支持多种访问协议和方式。

### 3.2 支持的访问类型

#### 3.2.1 协议类型
- **SSH**: 终端访问
- **RDP**: Windows 远程桌面
- **VNC**: 跨平台远程桌面
- **HTTP/HTTPS**: Web 服务访问
- **WebSocket**: 实时通信

#### 3.2.2 访问方式
- **Direct**: 直接访问 (IP:Port)
- **Jumpserver**: 堡垒机访问
- **Guacamole**: Web 远程访问
- **Proxy**: 代理访问
- **VPN**: VPN 访问

### 3.3 核心接口设计

```go
// AccessConfig 访问配置接口
type AccessConfig interface {
    GetProtocol() Protocol
    GetAccessType() AccessType
    Validate() error
    GenerateAccessInfo(env *Environment, host *Host) *AccessInfo
}

// AccessInfo 访问信息
type AccessInfo struct {
    Protocol      Protocol
    InternalURL   string
    PublicURL     string
    Credentials   *Credentials
    WebURL        string  // Jumpserver/Guacamole URL
}
```

### 3.4 模块结构

```
pkg/remote/
├── types.go           # 基础类型定义
├── ssh.go             # SSH 访问配置
├── rdp.go             # RDP 访问配置
├── vnc.go             # VNC 访问配置
├── web.go             # Web 访问配置
├── jumpserver.go      # Jumpserver 集成
├── guacamole.go       # Guacamole 集成
└── manager.go         # 访问配置管理器
```

---

## 4. 网络配置模块 (pkg/network)

### 4.1 模块职责

管理环境的网络配置,包括端口映射、防火墙、DNS 等。

### 4.2 功能组件

#### 4.2.1 端口管理
- 端口池管理
- 端口分配/释放
- 端口冲突检测

#### 4.2.2 防火墙集成
- iptables 规则管理
- firewalld 集成
- 云厂商防火墙 API

#### 4.2.3 DNS 管理
- 域名自动配置
- 多 DNS 提供商支持
- 子域名生成

### 4.3 核心接口设计

```go
// PortConfig 端口配置接口
type PortConfig interface {
    AllocatePort(serviceType string) (*PortMapping, error)
    ReleasePort(portID int) error
}

// FirewallConfig 防火墙配置接口
type FirewallConfig interface {
    CreateRule(rule *FirewallRule) error
    DeleteRule(ruleID string) error
}

// DNSConfig DNS 配置接口
type DNSConfig interface {
    CreateRecord(record *DNSRecord) error
    DeleteRecord(recordID string) error
}
```

### 4.4 模块结构

```
pkg/network/
├── types.go           # 基础类型定义
├── port.go            # 端口管理
├── firewall.go        # 防火墙管理
├── dns.go             # DNS 管理
└── manager.go         # 网络配置管理器
```

---

## 5. 安全认证模块 (pkg/security)

### 5.1 模块职责

管理环境的安全认证,包括密码生成、密钥管理、证书管理等。

### 5.2 功能组件

- **密码生成**: 安全的随机密码生成
- **SSH 密钥**: SSH 密钥对生成和管理
- **TLS 证书**: 证书生成和管理
- **Token 管理**: 访问令牌生成和验证

### 5.3 核心接口设计

```go
// CredentialGenerator 凭证生成器接口
type CredentialGenerator interface {
    GeneratePassword(length int, complexity PasswordComplexity) string
    GenerateSSHKey() (*SSHKeyPair, error)
    GenerateTLSCert(domain string) (*TLSCertificate, error)
}
```

### 5.4 模块结构

```
pkg/security/
├── types.go           # 基础类型定义
├── password.go        # 密码生成
├── sshkey.go          # SSH 密钥管理
├── certificate.go     # 证书管理
└── token.go           # Token 管理
```

---

## 6. 部署配置模块 (pkg/deployment)

### 6.1 模块职责

管理环境的部署配置,支持多种部署平台。

### 6.2 支持的部署平台

- **Kubernetes**: Pod/StatefulSet/Deployment
- **Docker**: 容器部署
- **VM**: 虚拟机部署
- **Bare Metal**: 裸金属部署

### 6.3 核心接口设计

```go
// DeploymentConfig 部署配置接口
type DeploymentConfig interface {
    GetPlatform() Platform
    Validate() error
    GenerateManifest() ([]byte, error)
    Deploy(ctx context.Context) error
}
```

### 6.4 模块结构

```
pkg/deployment/
├── types.go           # 基础类型定义
├── kubernetes.go      # K8S 部署配置
├── docker.go          # Docker 部署配置
├── vm.go              # VM 部署配置
└── manager.go         # 部署配置管理器
```

---

## 7. 模块集成架构

### 7.1 Service 层集成

```go
// EnvironmentService 环境服务
type EnvironmentService struct {
    // 模块化组件
    volumeManager     *volume.ConfigManager
    remoteManager     *remote.AccessManager
    networkManager    *network.NetworkManager
    securityManager   *security.CredentialManager
    deploymentManager *deployment.DeploymentManager

    // 原有组件
    envDao            EnvironmentDaoInterface
    // ...
}
```

### 7.2 创建环境流程

```
1. 验证请求参数
2. 检查资源配额
3. 选择部署主机
   ↓
4. 配置存储卷 (volume.ConfigManager)
   ↓
5. 配置网络 (network.NetworkManager)
   - 分配端口
   - 配置防火墙
   - 配置 DNS
   ↓
6. 生成安全凭证 (security.CredentialManager)
   - 生成密码
   - 生成 SSH 密钥
   ↓
7. 配置远程访问 (remote.AccessManager)
   - SSH/RDP/VNC 配置
   - Jumpserver/Guacamole 集成
   ↓
8. 执行部署 (deployment.DeploymentManager)
   - K8S/Docker/VM 部署
   ↓
9. 生成访问信息
10. 保存环境记录
```

---

## 8. 实现计划

### 8.1 Phase 1: 核心模块 (已完成)
- ✅ pkg/volume - 存储卷配置

### 8.2 Phase 2: 远程访问模块 (计划中)
- ⏳ pkg/remote - 远程访问配置
- ⏳ SSH/RDP/VNC 配置实现
- ⏳ Jumpserver/Guacamole 集成

### 8.3 Phase 3: 网络配置模块 (计划中)
- ⏳ pkg/network - 网络配置
- ⏳ 端口管理实现
- ⏳ 防火墙集成
- ⏳ DNS 管理

### 8.4 Phase 4: 安全认证模块 (计划中)
- ⏳ pkg/security - 安全认证
- ⏳ 密码生成
- ⏳ SSH 密钥管理
- ⏳ 证书管理

### 8.5 Phase 5: 部署配置模块 (计划中)
- ⏳ pkg/deployment - 部署配置
- ⏳ K8S 部署实现
- ⏳ Docker 部署实现

### 8.6 Phase 6: Service 层集成 (计划中)
- ⏳ 重构 EnvironmentService
- ⏳ 集成所有模块
- ⏳ 编写集成测试

---

## 9. 优势分析

### 9.1 架构优势

**模块化**
- 每个模块职责单一
- 易于理解和维护

**可扩展性**
- 添加新功能只需实现接口
- 不影响现有代码

**可测试性**
- 每个模块可独立测试
- Mock 接口简单

**可复用性**
- 模块可在其他项目中复用
- 降低开发成本

### 9.2 开发优势

**并行开发**
- 不同模块可并行开发
- 提高开发效率

**团队协作**
- 清晰的模块边界
- 减少代码冲突

**代码质量**
- 统一的接口规范
- 强类型检查

---

## 10. 下一步行动

### 10.1 立即执行
1. 创建 pkg/remote 包
2. 实现远程访问配置
3. 集成到 Service 层

### 10.2 后续计划
1. 创建 pkg/network 包
2. 创建 pkg/security 包
3. 创建 pkg/deployment 包
4. 重构 Service 层

---

## 附录 A: 接口定义示例

详见各模块的具体实现文档。

## 附录 B: 配置示例

详见各模块的配置示例文档。

---

**文档版本**: v1.0
**创建日期**: 2026-01-31
**最后更新**: 2026-01-31
**作者**: Claude Sonnet 4.5
