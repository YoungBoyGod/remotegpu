# CodeX 用户机器添加采集 Review（2026-02-04）

> 审计范围：`internal/service/machine/enrollment_service.go`

## 发现的问题

1. Agent 采集返回即直接使用，未校验 CPU/内存/磁盘是否完整。
2. 采集的 hostname 为空时没有回退到提交地址或用户输入。
3. 用户提交的 SSH 密码/密钥未写入 Host，导致后续运维无法复用。
4. 采集规格为 0 时仍创建机器，后续调度与监控易出现脏数据。

## 为什么不好

- 不完整的资源数据会导致监控图表、分配策略出现错误判断。
- Hostname 为空时，ID 生成与搜索会变得不可预测。
- SSH 凭据丢失意味着后续无法自动化登录或重置，增加人工成本。

## 改进措施（CodeX）

- 仅在 Agent 完整采集成功时采用数据，否则回退到 SSH 采集。
- 增加采集结果校验，规格不完整直接标记任务失败。
- 补充 hostname 回退逻辑（用户输入/连接地址）。
- 将 SSH 密码与密钥写入 Host 记录，保持一致性。

## 为什么更好

- 保证机器资源数据完整，避免无效资源影响分配与展示。
- 统一 Host 的标识规则，减少后续检索与排错成本。
- 保留认证信息便于后续运维任务自动化执行。
