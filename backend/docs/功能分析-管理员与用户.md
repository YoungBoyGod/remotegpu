# RemoteGPU 功能分析：管理员与用户视角

## 一、管理员视角功能分析

管理员是平台的运维和管理者，主要负责系统的稳定运行、资源调度和用户管理。

### 1.1 系统监控和运维（核心职责）

**功能需求**：
- **健康检查**（已实现）
  - 查看所有基础设施服务状态（PostgreSQL, Redis, K8s, Harbor等）
  - 查看单个服务的详细健康信息
  - API: `GET /api/v1/admin/health/all`, `GET /api/v1/admin/health/:service`

- **系统监控Dashboard**
  - 查看系统总体资源使用情况（CPU、内存、GPU、存储）
  - 查看主机列表和状态
  - 查看GPU资源分配情况
  - 查看当前运行的环境数量和状态分布
  - API: `GET /api/v1/admin/dashboard/overview`

- **告警管理**
  - 查看系统告警列表
  - 配置告警规则
  - 处理和确认告警
  - API: `GET /api/v1/admin/alerts`, `POST /api/v1/admin/alerts/rules`

- **系统日志**
  - 查看系统操作日志
  - 查看用户操作审计日志
  - 日志搜索和筛选
  - API: `GET /api/v1/admin/logs`

### 1.2 用户管理

**功能需求**：
- **用户列表和查询**
  - 查看所有用户列表（分页）
  - 按用户类型筛选（admin/internal/external）
  - 按账户类型筛选（individual/enterprise）
  - 按状态筛选（active/suspended/deleted）
  - 搜索用户（用户名、邮箱）
  - API: `GET /api/v1/admin/users?page=1&type=external&status=active`

- **用户详情和管理**
  - 查看用户详细信息
  - 查看用户的工作空间列表
  - 查看用户的环境列表
  - 查看用户的资源配额
  - 修改用户状态（激活、暂停、删除）
  - 修改用户资源配额
  - API: `GET /api/v1/admin/users/:id`, `PUT /api/v1/admin/users/:id/status`, `PUT /api/v1/admin/users/:id/quota`

- **用户使用统计**
  - 查看用户的资源使用情况
  - 查看用户的计费统计
  - 查看用户的活跃度
  - API: `GET /api/v1/admin/users/:id/statistics`

### 1.3 资源管理

**功能需求**：
- **主机管理**
  - 注册新主机到平台
  - 查看主机列表和状态
  - 查看主机详细信息（CPU、内存、GPU、磁盘）
  - 查看主机上运行的环境
  - 修改主机状态（上线、下线、维护）
  - 删除主机
  - API: `POST /api/v1/admin/hosts`, `GET /api/v1/admin/hosts`, `GET /api/v1/admin/hosts/:id`, `PUT /api/v1/admin/hosts/:id/status`, `DELETE /api/v1/admin/hosts/:id`

- **GPU管理**
  - 查看所有GPU设备列表
  - 查看GPU详细信息（型号、显存、使用状态）
  - 查看GPU分配情况
  - 手动分配/释放GPU
  - 修改GPU状态（可用、维护、故障）
  - API: `GET /api/v1/admin/gpus`, `GET /api/v1/admin/gpus/:id`, `PUT /api/v1/admin/gpus/:id/allocate`, `PUT /api/v1/admin/gpus/:id/status`

- **资源统计**
  - 查看资源总览（总量、已用、可用）
  - 查看资源使用趋势
  - 查看资源利用率
  - API: `GET /api/v1/admin/resources/overview`, `GET /api/v1/admin/resources/trends`

### 1.4 环境管理（监控和干预）

**功能需求**：
- **环境监控**
  - 查看所有环境列表（所有用户）
  - 按状态筛选（running/stopped/error）
  - 按用户筛选
  - 查看环境详细信息
  - 查看环境资源使用情况（CPU、内存、GPU使用率）
  - API: `GET /api/v1/admin/environments`, `GET /api/v1/admin/environments/:id`

- **环境干预**
  - 强制停止环境
  - 强制删除环境
  - 重启环境
  - API: `PUT /api/v1/admin/environments/:id/force-stop`, `DELETE /api/v1/admin/environments/:id/force-delete`

### 1.5 镜像管理

**功能需求**：
- **镜像管理**
  - 查看所有镜像列表
  - 创建官方镜像
  - 审核用户上传的镜像
  - 发布/下架镜像
  - 删除镜像
  - 查看镜像使用统计
  - API: `GET /api/v1/admin/images`, `POST /api/v1/admin/images`, `PUT /api/v1/admin/images/:id/approve`, `PUT /api/v1/admin/images/:id/publish`, `DELETE /api/v1/admin/images/:id`

### 1.6 计费管理

**功能需求**：
- **定价配置**
  - 配置资源定价（CPU、内存、GPU、存储）
  - 配置不同GPU型号的价格
  - 配置套餐价格
  - API: `GET /api/v1/admin/pricing`, `PUT /api/v1/admin/pricing`

- **账单管理**
  - 查看所有用户的账单
  - 查看账单详情
  - 手动生成账单
  - 导出账单数据
  - API: `GET /api/v1/admin/invoices`, `GET /api/v1/admin/invoices/:id`, `POST /api/v1/admin/invoices/generate`

- **计费统计**
  - 查看平台总收入
  - 查看收入趋势
  - 查看用户消费排行
  - API: `GET /api/v1/admin/billing/statistics`

### 1.7 系统配置

**功能需求**：
- **系统参数配置**
  - 配置系统基本参数
  - 配置资源配额默认值
  - 配置环境超时时间
  - API: `GET /api/v1/admin/config`, `PUT /api/v1/admin/config`

- **通知配置**
  - 配置邮件通知
  - 配置Webhook
  - 配置告警规则
  - API: `GET /api/v1/admin/notifications/config`, `PUT /api/v1/admin/notifications/config`

### 1.8 数据统计和报表

**功能需求**：
- **平台统计**
  - 用户总数、活跃用户数
  - 环境总数、运行中环境数
  - 资源利用率
  - 收入统计
  - API: `GET /api/v1/admin/statistics/overview`

- **趋势分析**
  - 用户增长趋势
  - 资源使用趋势
  - 收入趋势
  - API: `GET /api/v1/admin/statistics/trends`

---

## 二、普通用户视角功能分析

普通用户是平台的使用者，主要使用GPU资源进行开发、训练、推理等工作。

### 2.1 账户管理

**功能需求**：
- **账户注册和登录**（已实现）
  - 用户注册
  - 用户登录
  - 密码找回
  - API: `POST /api/v1/user/register`, `POST /api/v1/user/login`

- **个人信息管理**（已实现）
  - 查看个人信息
  - 修改个人信息（昵称、头像）
  - 修改密码
  - API: `GET /api/v1/user/info`, `PUT /api/v1/user/info`, `PUT /api/v1/user/password`

- **资源配额查看**
  - 查看自己的资源配额
  - 查看已使用的资源
  - API: `GET /api/v1/user/quota`

### 2.2 工作空间管理

**功能需求**：
- **工作空间CRUD**
  - 创建工作空间（个人/团队）
  - 查看自己的工作空间列表
  - 查看工作空间详情
  - 修改工作空间信息
  - 删除工作空间
  - API: `POST /api/v1/workspaces`, `GET /api/v1/workspaces`, `GET /api/v1/workspaces/:id`, `PUT /api/v1/workspaces/:id`, `DELETE /api/v1/workspaces/:id`

- **成员管理**（仅工作空间所有者/管理员）
  - 邀请成员
  - 移除成员
  - 修改成员角色
  - 查看成员列表
  - API: `POST /api/v1/workspaces/:id/members`, `DELETE /api/v1/workspaces/:id/members/:userId`, `PUT /api/v1/workspaces/:id/members/:userId/role`, `GET /api/v1/workspaces/:id/members`

- **工作空间资源**
  - 查看工作空间资源配额
  - 查看工作空间资源使用情况
  - 查看工作空间下的所有环境
  - API: `GET /api/v1/workspaces/:id/quota`, `GET /api/v1/workspaces/:id/usage`, `GET /api/v1/workspaces/:id/environments`

### 2.3 环境管理（核心功能）

**功能需求**：
- **环境创建**
  - 选择镜像
  - 配置资源（CPU、内存、GPU、存储）
  - 选择工作空间
  - 设置环境名称和描述
  - API: `POST /api/v1/environments`

- **环境列表和查询**
  - 查看自己的环境列表
  - 按工作空间筛选
  - 按状态筛选
  - 搜索环境
  - API: `GET /api/v1/environments?workspace_id=1&status=running`

- **环境详情**
  - 查看环境基本信息
  - 查看环境资源配置
  - 查看环境状态
  - 查看环境访问信息（SSH端口、RDP端口、Jupyter URL等）
  - API: `GET /api/v1/environments/:id`

- **环境生命周期管理**
  - 启动环境
  - 停止环境
  - 重启环境
  - 删除环境
  - API: `PUT /api/v1/environments/:id/start`, `PUT /api/v1/environments/:id/stop`, `PUT /api/v1/environments/:id/restart`, `DELETE /api/v1/environments/:id`

- **环境监控**
  - 查看环境资源使用情况（CPU、内存、GPU使用率）
  - 查看环境运行时长
  - 查看环境日志
  - API: `GET /api/v1/environments/:id/metrics`, `GET /api/v1/environments/:id/logs`

- **环境访问**
  - 获取SSH连接信息
  - 获取RDP连接信息
  - 获取Jupyter访问URL
  - 获取Web终端访问URL（Guacamole）
  - API: `GET /api/v1/environments/:id/access`

### 2.4 镜像管理

**功能需求**：
- **镜像浏览**
  - 查看可用镜像列表
  - 按类型筛选（官方/社区/私有）
  - 搜索镜像
  - 查看镜像详情（描述、版本、包含的软件）
  - API: `GET /api/v1/images`, `GET /api/v1/images/:id`

- **私有镜像管理**（可选功能）
  - 上传自定义镜像
  - 查看自己的私有镜像
  - 删除私有镜像
  - API: `POST /api/v1/images`, `GET /api/v1/images?type=private`, `DELETE /api/v1/images/:id`

### 2.5 数据管理

**功能需求**：
- **数据集管理**
  - 上传数据集
  - 查看数据集列表
  - 删除数据集
  - 挂载数据集到环境
  - API: `POST /api/v1/datasets`, `GET /api/v1/datasets`, `DELETE /api/v1/datasets/:id`, `POST /api/v1/environments/:id/mount-dataset`

- **数据卷管理**
  - 创建数据卷
  - 查看数据卷列表
  - 删除数据卷
  - 挂载数据卷到环境
  - API: `POST /api/v1/volumes`, `GET /api/v1/volumes`, `DELETE /api/v1/volumes/:id`

### 2.6 计费查询

**功能需求**：
- **费用查询**
  - 查看当前余额
  - 查看实时费用
  - 查看历史计费记录
  - 按时间范围筛选
  - 按环境筛选
  - API: `GET /api/v1/billing/balance`, `GET /api/v1/billing/current`, `GET /api/v1/billing/records?start_date=2024-01-01&end_date=2024-01-31`

- **账单管理**
  - 查看账单列表
  - 查看账单详情
  - 下载账单
  - API: `GET /api/v1/billing/invoices`, `GET /api/v1/billing/invoices/:id`, `GET /api/v1/billing/invoices/:id/download`

- **充值和支付**（可选功能）
  - 充值
  - 查看充值记录
  - 支付账单
  - API: `POST /api/v1/billing/recharge`, `GET /api/v1/billing/recharge-records`, `POST /api/v1/billing/invoices/:id/pay`

### 2.7 通知管理

**功能需求**：
- **通知查看**
  - 查看通知列表
  - 查看未读通知数量
  - 查看通知详情
  - 标记通知为已读
  - 删除通知
  - API: `GET /api/v1/notifications`, `GET /api/v1/notifications/unread-count`, `GET /api/v1/notifications/:id`, `PUT /api/v1/notifications/:id/read`, `DELETE /api/v1/notifications/:id`

- **通知设置**
  - 配置通知偏好（邮件、站内信）
  - 配置通知类型（系统通知、账单通知、环境通知）
  - API: `GET /api/v1/notifications/settings`, `PUT /api/v1/notifications/settings`

### 2.8 使用统计

**功能需求**：
- **个人统计**
  - 查看资源使用统计
  - 查看费用统计
  - 查看环境使用时长统计
  - API: `GET /api/v1/user/statistics`

---

## 三、功能权限对比表

| 功能模块 | 管理员权限 | 普通用户权限 | 权限差异 |
|---------|-----------|------------|---------|
| **系统监控** | ✅ 查看所有系统健康状态<br>✅ 查看系统资源总览<br>✅ 查看告警信息 | ❌ 无权限 | 管理员独有 |
| **用户管理** | ✅ 查看所有用户<br>✅ 修改用户状态<br>✅ 修改用户配额<br>✅ 查看用户统计 | ✅ 查看/修改自己的信息<br>✅ 查看自己的配额 | 管理员可管理所有用户 |
| **主机管理** | ✅ 注册/删除主机<br>✅ 查看所有主机<br>✅ 修改主机状态 | ❌ 无权限 | 管理员独有 |
| **GPU管理** | ✅ 查看所有GPU<br>✅ 手动分配/释放GPU<br>✅ 修改GPU状态 | ✅ 查看可用GPU列表 | 管理员可管理，用户只读 |
| **工作空间** | ✅ 查看所有工作空间 | ✅ 管理自己的工作空间<br>✅ 管理成员（所有者） | 管理员可查看所有 |
| **环境管理** | ✅ 查看所有环境<br>✅ 强制停止/删除环境 | ✅ 管理自己的环境<br>✅ 启动/停止/删除 | 管理员可干预所有环境 |
| **镜像管理** | ✅ 创建官方镜像<br>✅ 审核用户镜像<br>✅ 发布/下架镜像 | ✅ 查看可用镜像<br>✅ 上传私有镜像 | 管理员可审核和发布 |
| **计费管理** | ✅ 配置定价<br>✅ 查看所有账单<br>✅ 查看收入统计 | ✅ 查看自己的账单<br>✅ 查看自己的费用 | 管理员可配置和查看所有 |
| **通知管理** | ✅ 配置系统通知<br>✅ 发送系统公告 | ✅ 查看自己的通知<br>✅ 配置通知偏好 | 管理员可发送系统通知 |
| **数据管理** | ✅ 查看所有数据集 | ✅ 管理自己的数据集 | 管理员可查看所有 |

---

## 四、API路由设计

### 4.1 公开路由（无需认证）
```
POST   /api/v1/user/register
POST   /api/v1/user/login
GET    /api/v1/health
```

### 4.2 用户路由（需要认证）
```
# 用户账户
GET    /api/v1/user/info
PUT    /api/v1/user/info
PUT    /api/v1/user/password
GET    /api/v1/user/quota
GET    /api/v1/user/statistics

# 工作空间
GET    /api/v1/workspaces
POST   /api/v1/workspaces
GET    /api/v1/workspaces/:id
PUT    /api/v1/workspaces/:id
DELETE /api/v1/workspaces/:id
GET    /api/v1/workspaces/:id/members
POST   /api/v1/workspaces/:id/members
DELETE /api/v1/workspaces/:id/members/:userId
PUT    /api/v1/workspaces/:id/members/:userId/role

# 环境管理
GET    /api/v1/environments
POST   /api/v1/environments
GET    /api/v1/environments/:id
PUT    /api/v1/environments/:id/start
PUT    /api/v1/environments/:id/stop
PUT    /api/v1/environments/:id/restart
DELETE /api/v1/environments/:id
GET    /api/v1/environments/:id/metrics
GET    /api/v1/environments/:id/logs
GET    /api/v1/environments/:id/access

# 镜像
GET    /api/v1/images
GET    /api/v1/images/:id
POST   /api/v1/images
DELETE /api/v1/images/:id

# 数据集
GET    /api/v1/datasets
POST   /api/v1/datasets
DELETE /api/v1/datasets/:id

# 计费
GET    /api/v1/billing/balance
GET    /api/v1/billing/current
GET    /api/v1/billing/records
GET    /api/v1/billing/invoices
GET    /api/v1/billing/invoices/:id

# 通知
GET    /api/v1/notifications
GET    /api/v1/notifications/unread-count
GET    /api/v1/notifications/:id
PUT    /api/v1/notifications/:id/read
DELETE /api/v1/notifications/:id
GET    /api/v1/notifications/settings
PUT    /api/v1/notifications/settings
```

### 4.3 管理员路由（需要管理员权限）
```
# 系统监控
GET    /api/v1/admin/health/all
GET    /api/v1/admin/health/:service
GET    /api/v1/admin/dashboard/overview
GET    /api/v1/admin/alerts
POST   /api/v1/admin/alerts/rules
GET    /api/v1/admin/logs

# 用户管理
GET    /api/v1/admin/users
GET    /api/v1/admin/users/:id
PUT    /api/v1/admin/users/:id/status
PUT    /api/v1/admin/users/:id/quota
GET    /api/v1/admin/users/:id/statistics

# 主机管理
GET    /api/v1/admin/hosts
POST   /api/v1/admin/hosts
GET    /api/v1/admin/hosts/:id
PUT    /api/v1/admin/hosts/:id/status
DELETE /api/v1/admin/hosts/:id

# GPU管理
GET    /api/v1/admin/gpus
GET    /api/v1/admin/gpus/:id
PUT    /api/v1/admin/gpus/:id/allocate
PUT    /api/v1/admin/gpus/:id/status

# 资源统计
GET    /api/v1/admin/resources/overview
GET    /api/v1/admin/resources/trends

# 环境管理
GET    /api/v1/admin/environments
GET    /api/v1/admin/environments/:id
PUT    /api/v1/admin/environments/:id/force-stop
DELETE /api/v1/admin/environments/:id/force-delete

# 镜像管理
GET    /api/v1/admin/images
POST   /api/v1/admin/images
PUT    /api/v1/admin/images/:id/approve
PUT    /api/v1/admin/images/:id/publish
DELETE /api/v1/admin/images/:id

# 计费管理
GET    /api/v1/admin/pricing
PUT    /api/v1/admin/pricing
GET    /api/v1/admin/invoices
GET    /api/v1/admin/invoices/:id
POST   /api/v1/admin/invoices/generate
GET    /api/v1/admin/billing/statistics

# 系统配置
GET    /api/v1/admin/config
PUT    /api/v1/admin/config
GET    /api/v1/admin/notifications/config
PUT    /api/v1/admin/notifications/config

# 统计分析
GET    /api/v1/admin/statistics/overview
GET    /api/v1/admin/statistics/trends
```

---

## 五、核心业务流程

### 5.1 用户使用流程
1. 注册账户 → 登录
2. 创建工作空间（可选）
3. 选择镜像 → 配置资源 → 创建环境
4. 启动环境 → 获取访问信息 → 使用环境
5. 停止环境 → 查看计费
6. 删除环境

### 5.2 管理员运维流程
1. 监控系统健康状态
2. 注册主机和GPU资源
3. 审核用户和镜像
4. 配置定价和配额
5. 处理告警和异常
6. 查看统计和报表

---

## 六、优先级建议

### P0（必须实现）
- 用户注册、登录、信息管理
- 环境创建、启动、停止、删除
- 镜像浏览和选择
- 基础计费查询
- 管理员用户管理
- 管理员资源管理

### P1（重要功能）
- 工作空间管理
- 环境监控和日志
- 计费记录和账单
- 管理员系统监控
- 通知系统

### P2（增强功能）
- 数据集管理
- 私有镜像上传
- 告警系统
- 统计报表
- 系统配置

### P3（优化功能）
- 充值和支付
- Webhook
- 高级统计分析
