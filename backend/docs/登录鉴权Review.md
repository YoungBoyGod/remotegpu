# CodeX 登录鉴权 Review（2026-02-04）

## Reviewed Files

- `internal/service/auth/auth_service.go`
- `internal/controller/v1/auth/auth_controller.go`
- `internal/middleware/auth.go`

## 发现的问题（原实现）

1. **刷新令牌强依赖 Redis**
   - 原实现只从 Redis 读取 refresh token，Redis 未启用或暂时不可用时，刷新会直接失败。
   - 影响：开发环境或故障场景下登录链路断裂，无法稳定复现和排查问题。

2. **错误处理依赖字符串判断**
   - 原实现通过 `err.Error()` 字符串匹配来区分权限错误。
   - 影响：错误信息调整后容易失效，且控制器无法统一返回规范的状态码。

3. **登录未校验账号状态**
   - 原实现仅校验用户名/密码，不校验 `status`。
   - 影响：被禁用账号仍可登录，违反权限管理预期。

4. **登出结果不可信**
   - 原实现忽略登出失败（比如缓存写入失败）。
   - 影响：前端以为已登出，但旧 token 仍有效。

5. **鉴权状态校验不稳定**
   - 原实现对账号状态检查方式不统一，且缺乏明确的错误分类。
   - 影响：认证失败场景的返回不一致，难以定位具体问题。

## 优化与改进（当前实现）

1. **刷新令牌支持缓存缺失兜底**
   - 通过内存 `refreshMap` 作为 fallback，确保开发环境无 Redis 也可完成刷新。
   - 同时对 refresh token 进行轮换，减少重放风险。

2. **错误类型标准化**
   - 用 `ErrInvalidCredentials / ErrAccountDisabled / ErrPermissionDenied` 明确分类。
   - 控制器统一映射 HTTP 状态码，避免字符串判断带来的不稳定。

3. **登录与鉴权统一校验账号状态**
   - 登录阶段直接拒绝 `status != active` 的用户。
   - 鉴权中间件统一返回 `403`，保证行为一致。

4. **登出失败可见**
   - 登出写黑名单失败时返回 `500`，避免假登出。

## 为什么这样更好

- **更稳定**：缓存不可用时仍能跑通基本流程，适合开发与联调。
- **更安全**：禁用账号无法登录/访问；refresh token 轮换降低重放。
- **更易维护**：错误类型可测试、可追踪，控制器不依赖字符串逻辑。
- **更可排查**：返回码一致，排错路径清晰。

## 备注

- 已在代码中添加修改时间注释（`2026-02-04`），用于追踪关键改动。
