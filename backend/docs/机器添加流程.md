# 机器添加 - 完整调用链条

本文档描述管理员添加机器功能从前端到后端的完整调用流程。

## 流程概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端 (Vue3)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 路由层                                                                   │
│     src/router/index.ts:60-63                                               │
│     path: '/admin/machines/add' → MachineAddView.vue                        │
│                         │                                                   │
│                         ▼                                                   │
│  2. 视图层                                                                   │
│     src/views/admin/MachineAddView.vue                                      │
│     - 表单收集: name, hostname, region, ip_address, ssh凭证等               │
│     - handleSubmit() 调用 addMachine()                                      │
│                         │                                                   │
│                         ▼                                                   │
│  3. API 层                                                                   │
│     src/api/admin.ts:31-33                                                  │
│     addMachine(data: CreateMachinePayload)                                  │
│                         │                                                   │
│                         ▼                                                   │
│  4. HTTP 请求封装                                                            │
│     src/utils/request.ts                                                    │
│     - 请求拦截器: 添加 Authorization Bearer Token                            │
│     - 响应拦截器: 处理错误、401 自动刷新 Token                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                          │
                          │ POST /api/v1/admin/machines
                          │ Content-Type: application/json
                          │ Authorization: Bearer <token>
                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              后端 (Go + Gin)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  5. 路由层                                                                   │
│     internal/router/router.go:152                                           │
│     adminGroup.POST("/machines", machineController.Create)                  │
│     中间件: Auth → RequireAdmin → AuditMiddleware                           │
│                         │                                                   │
│                         ▼                                                   │
│  6. 请求 DTO                                                                 │
│     api/v1/machine.go:18-28                                                 │
│     CreateMachineRequest 结构体定义                                          │
│                         │                                                   │
│                         ▼                                                   │
│  7. 控制器层                                                                 │
│     internal/controller/v1/machine/machine_controller.go:87-140             │
│     MachineController.Create()                                              │
│     - 参数绑定与校验                                                         │
│     - 构建 entity.Host 对象                                                  │
│     - 可选: 调用 AgentService 获取系统信息                                   │
│                         │                                                   │
│                         ▼                                                   │
│  8. 服务层                                                                   │
│     internal/service/machine/machine_service.go:34-54                       │
│     MachineService.CreateMachine()                                          │
│     - 生成 Host ID                                                          │
│     - 校验 IP/Hostname 唯一性                                                │
│                         │                                                   │
│                         ▼                                                   │
│  9. 数据访问层 (DAO)                                                         │
│     internal/dao/machine_repo.go:18-20                                      │
│     MachineDao.Create()                                                     │
│     - GORM: db.Create(host)                                                 │
│                         │                                                   │
│                         ▼                                                   │
│  10. 数据库                                                                  │
│      INSERT INTO hosts(...) VALUES (...)                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 文件清单

| 层级 | 文件路径 | 关键函数/结构 |
|------|----------|---------------|
| **前端路由** | `frontend/src/router/index.ts:60-63` | 路由定义 |
| **前端视图** | `frontend/src/views/admin/MachineAddView.vue` | `handleSubmit()` |
| **前端API** | `frontend/src/api/admin.ts:31-33` | `addMachine()` |
| **HTTP封装** | `frontend/src/utils/request.ts` | axios拦截器 |
| **后端路由** | `backend/internal/router/router.go:152` | `POST /machines` |
| **请求DTO** | `backend/api/v1/machine.go:18-28` | `CreateMachineRequest` |
| **控制器** | `backend/internal/controller/v1/machine/machine_controller.go:87-140` | `Create()` |
| **服务层** | `backend/internal/service/machine/machine_service.go:34-54` | `CreateMachine()` |
| **DAO层** | `backend/internal/dao/machine_repo.go:18-20` | `Create()` |
| **实体** | `backend/internal/model/entity/host.go` | `Host` 结构体 |

## 数据流转

```
前端表单数据 (CreateMachinePayload)
    ↓
JSON 序列化 → HTTP POST
    ↓
Gin 路由匹配 + 中间件鉴权
    ↓
ShouldBindJSON → CreateMachineRequest
    ↓
构建 entity.Host 对象
    ↓
MachineService 校验唯一性
    ↓
MachineDao.Create → GORM INSERT
    ↓
返回 Host 对象 → JSON 响应
    ↓
前端 router.push('/admin/machines/list')
```

## 请求/响应示例

### 请求

```http
POST /api/v1/admin/machines HTTP/1.1
Host: localhost:8080
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...

{
  "name": "GPU-Server-01",
  "hostname": "gpu01.example.com",
  "region": "北京",
  "ip_address": "192.168.1.100",
  "public_ip": "203.0.113.50",
  "ssh_port": 22,
  "ssh_username": "root",
  "ssh_password": "xxx",
  "ssh_key": "-----BEGIN OPENSSH PRIVATE KEY-----..."
}
```

### 响应

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "gpu01.example.com",
    "name": "GPU-Server-01",
    "hostname": "gpu01.example.com",
    "region": "北京",
    "ip_address": "192.168.1.100",
    "public_ip": "203.0.113.50",
    "ssh_port": 22,
    "status": "idle",
    "health_status": "healthy",
    "created_at": "2026-02-05T10:30:00Z"
  }
}
```

## 中间件处理

请求经过以下中间件链:

1. **Auth** - JWT 令牌验证，提取用户信息
2. **RequireAdmin** - 检查用户角色是否为管理员
3. **AuditMiddleware** - 记录操作审计日志

## 错误处理

| HTTP 状态码 | 场景 | 前端处理 |
|-------------|------|----------|
| 400 | 参数校验失败 | 显示错误消息 |
| 401 | Token 过期 | 自动刷新或跳转登录 |
| 403 | 权限不足 | 显示权限错误 |
| 409 | IP/Hostname 重复 | 提示已存在 |
| 500 | 服务器错误 | 显示通用错误 |
