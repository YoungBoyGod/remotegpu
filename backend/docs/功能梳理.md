# 功能梳理（从登录开始）

下面按实现优先级列出模块与关键注意点，便于从登录逐步打通主流程。

## 1. 登录与鉴权

- 登录 `/api/v1/auth/login`
  - 校验用户名/密码（已实现）。
  - 失败原因应区分账号不存在、密码错误、账号禁用。
- 刷新 `/api/v1/auth/refresh`
  - 当前为 TODO，需要实现刷新令牌的签发与存储。
  - 建议把 refresh token 存储到 DB/Redis，并做过期清理。
- 登出 `/api/v1/auth/logout`
  - 已有内存黑名单实现，但需要在鉴权中间件里校验黑名单。
- 获取资料 `/api/v1/auth/profile`
  - 依赖鉴权中间件设置 `userID`。

## 2. 鉴权中间件与权限

- `middleware.Auth()` 要解析 JWT 并注入 `userID` / `role`。
- 管理端路由需增加 `RequireRole("admin")`。
- 账号状态 `status=active` 校验应在登录与鉴权时统一处理。

## 3. 管理端（Admin）

- 仪表板
  - `/admin/dashboard/stats` 已实现聚合统计。
  - `/admin/dashboard/gpu-trend`、`/admin/allocations/recent` 目前返回空数组，需要接入指标/分配数据源。
- 机器管理
  - `/admin/machines` 支持筛选 `status/region/gpu_model`。
  - `/admin/machines/import` 目前是 TODO，需定义导入模板与校验。
  - `/admin/machines/:id/allocate` 需校验机器状态、客户存在、租期合法。
  - `/admin/machines/:id/reclaim` 需要补充回收原因记录/审计。
- 客户管理
  - `/admin/customers` 支持分页。
  - `/admin/customers` 创建时需要校验唯一性、密码强度。
  - `/admin/customers/:id/disable` 需要防止禁用当前登录账号。

- 镜像管理（新增）
  - `/admin/images` 管理基础镜像列表（如 Ubuntu+CUDA, DeepSeek-V3 等）。
  - `/admin/images/sync` 同步/扫描 Harbor 或本地镜像仓库。
- 系统审计（新增）
  - `/admin/audit/logs` 查看关键操作日志（登录、重启、重装、分配）。

## 4. 客户端（Customer）

- SSH 密钥（新增）
  - `/customer/keys` 管理公钥，用于创建机器时自动注入。
- 机器
  - `/customer/machines` 当前未按租户过滤，需要接入租户/用户过滤。
  - `/customer/machines/:id/connection` 依赖连接信息生成。
  - `/customer/machines/:id/ssh-reset` 注意权限与审计。
- 任务
  - `/customer/tasks`、`/customer/tasks/training`、`/customer/tasks/:id/stop`
  - 目前 `userID` 使用 mock，需要改为 token 里的真实用户。
- 数据集
  - `/customer/datasets`、`/datasets/init-multipart`、`/datasets/:id/mount`
  - `userID` 目前使用 mock，需要按用户隔离。
  - 上传分片大小固定，需考虑动态配置与校验。

## 5. 运维与监控

- `/admin/monitoring/realtime` 调用监控快照。
- `/admin/alerts` 返回当前告警列表。
- 需要定义告警规则来源与告警存储策略。

## 6. 辅助与工具

- CLI: `admin create/reset` 便于运维初始化账号。
- Swagger/OpenAPI 路径可配置，避免路由冲突。
