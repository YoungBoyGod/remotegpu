# 端口映射和访问管理框架

## 概述

本文档描述了端口映射和访问管理的完整代码框架,支持内网/外网访问、防火墙集成、DNS 自动配置、Jumpserver 和 Guacamole 集成。

## 已完成的功能

### 1. 端口池管理服务 (`internal/service/port_pool.go`)

**功能:**
- 自动分配和管理端口
- 支持多种服务类型(SSH、RDP、Jupyter、VNC、TensorBoard 等)
- 线程安全的端口分配机制
- 端口释放和查询

**端口范围配置:**
```go
SSHPortRange      = PortRange{Start: 22000, End: 22999}
RDPPortRange      = PortRange{Start: 33890, End: 34889}
JupyterPortRange  = PortRange{Start: 8888, End: 9887}
VNCPortRange      = PortRange{Start: 5900, End: 6899}
NoVNCPortRange    = PortRange{Start: 6080, End: 7079}
CustomPortRange   = PortRange{Start: 10000, End: 19999}
```

**核心方法:**
- `AllocatePort()` - 分配单个端口
- `AllocatePorts()` - 批量分配端口
- `ReleasePort()` - 释放单个端口
- `ReleasePortsByEnvID()` - 释放环境的所有端口
- `GetAllocatedPorts()` - 获取环境的所有端口
- `GetPortByServiceType()` - 获取指定服务类型的端口

### 2. 防火墙集成服务 (`internal/service/firewall.go`)

**功能:**
- 配置防火墙端口映射
- 将主机端口映射到公网端口
- 支持多种防火墙类型(iptables、firewalld、云厂商防火墙)

**核心方法:**
- `CreatePortMapping()` - 创建端口映射 ⚠️ TODO
- `DeletePortMapping()` - 删除端口映射 ⚠️ TODO
- `ConfigureEnvironmentFirewall()` - 为环境配置防火墙 ⚠️ TODO
- `CleanupEnvironmentFirewall()` - 清理环境的防火墙规则 ⚠️ TODO

**支持的防火墙类型:**
- iptables
- firewalld
- 云厂商防火墙(阿里云、腾讯云、AWS)

**TODO 实现:**
```go
// 示例: iptables 端口映射
iptables -t nat -A PREROUTING -p tcp --dport <public_port> -j DNAT --to-destination <host_ip>:<internal_port>
iptables -t nat -A POSTROUTING -p tcp -d <host_ip> --dport <internal_port> -j MASQUERADE
```

### 3. DNS 自动配置服务 (`internal/service/dns.go`)

**功能:**
- 自动配置域名解析
- 为环境服务生成子域名
- 支持多种 DNS 提供商

**核心方法:**
- `CreateDNSRecord()` - 创建 DNS 记录 ⚠️ TODO
- `DeleteDNSRecord()` - 删除 DNS 记录 ⚠️ TODO
- `ConfigureEnvironmentDNS()` - 为环境配置 DNS ⚠️ TODO
- `GenerateSubdomain()` - 生成子域名
- `BuildAccessURL()` - 构建访问 URL

**支持的 DNS 提供商:**
- Cloudflare
- 阿里云 DNS
- 腾讯云 DNS
- AWS Route53

**子域名生成规则:**
```
ssh-env123.example.com
rdp-env123.example.com
jupyter-env123.example.com
```

### 4. Jumpserver 集成服务 (`internal/service/jumpserver.go`)

**功能:**
- 自动创建和管理 Jumpserver 资产
- 配置账号和授权
- 生成 Jumpserver 访问地址

**核心方法:**
- `CreateAsset()` - 创建资产 ⚠️ TODO
- `DeleteAsset()` - 删除资产 ⚠️ TODO
- `CreateAccount()` - 创建账号 ⚠️ TODO
- `ConfigureEnvironmentJumpserver()` - 为环境配置 Jumpserver ⚠️ TODO
- `GetJumpserverAccessURL()` - 获取访问地址 ⚠️ TODO

**API 文档:**
https://docs.jumpserver.org/zh/master/dev/rest_api/

### 5. Guacamole 集成服务 (`internal/service/guacamole.go`)

**功能:**
- 自动创建和管理 Guacamole 连接配置
- 支持 SSH、RDP、VNC 协议
- 生成 Guacamole 访问地址

**核心方法:**
- `CreateConnection()` - 创建连接 ⚠️ TODO
- `DeleteConnection()` - 删除连接 ⚠️ TODO
- `ConfigureEnvironmentGuacamole()` - 为环境配置 Guacamole ⚠️ TODO
- `GetGuacamoleAccessURL()` - 获取访问地址 ⚠️ TODO

**协议参数配置:**
- `buildSSHParameters()` - SSH 连接参数
- `buildRDPParameters()` - RDP 连接参数
- `buildVNCParameters()` - VNC 连接参数

### 6. 访问信息生成服务 (`internal/service/access_info.go`)

**功能:**
- 生成环境的完整访问信息
- 支持内网和公网访问
- 集成 Jumpserver 和 Guacamole

**访问信息结构:**
```json
{
  "access_type": "internal|public|jumpserver|guacamole",
  "ssh": {
    "internal_host": "192.168.1.100",
    "internal_port": 22001,
    "internal_url": "ssh://192.168.1.100:22001",
    "public_host": "1.2.3.4",
    "public_port": 22001,
    "public_domain": "ssh-env123.example.com",
    "public_url": "ssh://ssh-env123.example.com:22001",
    "username": "root",
    "password": "Pass_12345678"
  },
  "jumpserver": {
    "url": "https://jumpserver.example.com/luna/?asset=xxx",
    "asset_ids": ["asset-123"],
    "available": true
  },
  "guacamole": {
    "url": "https://guacamole.example.com/#/client/conn-123",
    "connection_ids": ["conn-123"],
    "available": true
  }
}
```

## 数据模型扩展

### PortMapping 表新增字段

```sql
-- 公网端口
ALTER TABLE port_mappings ADD COLUMN public_port INT;

-- 内网访问地址
ALTER TABLE port_mappings ADD COLUMN internal_access_url VARCHAR(512);

-- 公网访问地址
ALTER TABLE port_mappings ADD COLUMN public_access_url VARCHAR(512);

-- 公网域名
ALTER TABLE port_mappings ADD COLUMN public_domain VARCHAR(256);
```

### Environment 表新增字段

```sql
-- 部署模式
ALTER TABLE environments ADD COLUMN deployment_mode VARCHAR(32) DEFAULT 'k8s_pod';

-- 环境类型
ALTER TABLE environments ADD COLUMN environment_type VARCHAR(32) DEFAULT 'ide';

-- GPU 模式
ALTER TABLE environments ADD COLUMN gpu_mode VARCHAR(32) DEFAULT 'exclusive';

-- 存储类型
ALTER TABLE environments ADD COLUMN storage_type VARCHAR(32) DEFAULT 'local';

-- 生命周期策略
ALTER TABLE environments ADD COLUMN lifecycle_policy VARCHAR(32) DEFAULT 'persistent';

-- Jumpserver 集成
ALTER TABLE environments ADD COLUMN use_jumpserver BOOLEAN DEFAULT false;

-- Guacamole 集成
ALTER TABLE environments ADD COLUMN use_guacamole BOOLEAN DEFAULT false;
ALTER TABLE environments ADD COLUMN guacamole_conn_id VARCHAR(64);
```

## 使用流程

### 1. 创建环境时自动分配端口

```go
// 在 CreateEnvironment 中
portRequests := s.buildPortRequests(req)
portMappings, err := s.portPoolService.AllocatePorts(envID, portRequests)

// 更新环境的端口字段
for _, pm := range portMappings {
    switch pm.ServiceType {
    case "ssh":
        env.SSHPort = &pm.ExternalPort
    case "rdp":
        env.RDPPort = &pm.ExternalPort
    // ...
    }
}
```

### 2. 配置防火墙和 DNS (TODO)

```go
// 配置防火墙端口映射
err := s.firewallService.ConfigureEnvironmentFirewall(env, portMappings)

// 配置 DNS 记录
err := s.dnsService.ConfigureEnvironmentDNS(env, portMappings, publicIP)
```

### 3. 配置 Jumpserver/Guacamole (TODO)

```go
if env.UseJumpserver {
    err := s.jumpserverService.ConfigureEnvironmentJumpserver(env, portMappings)
}

if env.UseGuacamole {
    err := s.guacamoleService.ConfigureEnvironmentGuacamole(env, portMappings)
}
```

### 4. 生成访问信息

```go
accessInfo, err := s.accessInfoService.GenerateAccessInfo(env, host)
// 返回包含内网、公网、Jumpserver、Guacamole 的完整访问信息
```

### 5. 删除环境时清理资源

```go
// 释放端口
err := s.portPoolService.ReleasePortsByEnvID(env.ID)

// 清理防火墙规则 (TODO)
err := s.firewallService.CleanupEnvironmentFirewall(env)

// 清理 DNS 记录 (TODO)
err := s.dnsService.CleanupEnvironmentDNS(env)

// 清理 Jumpserver 配置 (TODO)
err := s.jumpserverService.CleanupEnvironmentJumpserver(env)

// 清理 Guacamole 配置 (TODO)
err := s.guacamoleService.CleanupEnvironmentGuacamole(env)
```

## 后期扩展指南

### 1. 实现防火墙集成

**步骤:**
1. 在 `firewall.go` 中实现 `CreatePortMapping()` 方法
2. 根据防火墙类型调用相应的实现:
   - `createIPTablesMapping()` - iptables
   - `createFirewalldMapping()` - firewalld
   - `createCloudFirewallMapping()` - 云厂商
3. 在 `ConfigureEnvironmentFirewall()` 中遍历端口映射,创建防火墙规则
4. 更新 PortMapping 的 `PublicPort` 字段

**配置文件示例:**
```yaml
firewall:
  type: iptables  # iptables/firewalld/cloud_firewall
  endpoint: ""
  api_key: ""
```

### 2. 实现 DNS 自动配置

**步骤:**
1. 在 `dns.go` 中实现 `CreateDNSRecord()` 方法
2. 根据 DNS 提供商调用相应的实现:
   - `createCloudflareRecord()` - Cloudflare
   - `createAliyunRecord()` - 阿里云
   - `createTencentRecord()` - 腾讯云
   - `createAWSRecord()` - AWS Route53
3. 在 `ConfigureEnvironmentDNS()` 中为每个服务创建 DNS 记录
4. 更新 PortMapping 的 `PublicDomain` 和 `PublicAccessURL` 字段

**配置文件示例:**
```yaml
dns:
  provider: cloudflare  # cloudflare/aliyun/tencent/aws
  api_key: "your-api-key"
  api_secret: "your-api-secret"
  base_domain: "example.com"
  ttl: 300
```

### 3. 实现 Jumpserver 集成

**步骤:**
1. 安装 Jumpserver SDK 或使用 HTTP 客户端
2. 在 `jumpserver.go` 中实现 `CreateAsset()` 方法
3. 实现 `CreateAccount()` 方法
4. 在 `ConfigureEnvironmentJumpserver()` 中:
   - 为每个服务类型(SSH/RDP/VNC)创建资产
   - 创建默认账号
   - 配置用户授权
5. 保存资产 ID 到数据库

**配置文件示例:**
```yaml
jumpserver:
  endpoint: "https://jumpserver.example.com"
  access_key: "your-access-key"
  secret_key: "your-secret-key"
  org_id: "default"
```

### 4. 实现 Guacamole 集成

**步骤:**
1. 安装 Guacamole SDK 或使用 HTTP 客户端
2. 在 `guacamole.go` 中实现 `CreateConnection()` 方法
3. 在 `ConfigureEnvironmentGuacamole()` 中:
   - 为每个协议(SSH/RDP/VNC)创建连接
   - 配置连接参数(使用 `buildSSHParameters()` 等)
   - 保存连接 ID 到环境记录
4. 实现 `GetGuacamoleAccessURL()` 生成访问地址

**配置文件示例:**
```yaml
guacamole:
  endpoint: "https://guacamole.example.com"
  username: "guacadmin"
  password: "your-password"
  data_source: "mysql"
```

### 5. 前端集成

**API 响应示例:**
```json
{
  "id": "env-123",
  "name": "我的开发环境",
  "status": "running",
  "access_info": {
    "access_type": "internal",
    "ssh": {
      "internal_host": "192.168.1.100",
      "internal_port": 22001,
      "internal_url": "ssh://192.168.1.100:22001",
      "public_domain": "ssh-env123.example.com",
      "public_url": "ssh://ssh-env123.example.com:22001",
      "username": "root",
      "password": "Pass_12345678",
      "command": "ssh root@192.168.1.100 -p 22001"
    }
  }
}
```

**前端展示:**
- 内网用户显示内网访问地址
- 外网用户显示公网访问地址
- 提供一键复制命令按钮
- 如果启用了 Jumpserver/Guacamole,显示 Web 访问按钮

## 配置文件结构

建议在 `config.yaml` 中添加以下配置:

```yaml
# 防火墙配置
firewall:
  enabled: true
  type: iptables  # iptables/firewalld/cloud_firewall
  endpoint: ""
  api_key: ""
  region: ""

# DNS 配置
dns:
  enabled: true
  provider: cloudflare  # cloudflare/aliyun/tencent/aws
  api_key: "your-api-key"
  api_secret: "your-api-secret"
  base_domain: "example.com"
  ttl: 300

# Jumpserver 配置
jumpserver:
  enabled: false
  endpoint: "https://jumpserver.example.com"
  access_key: "your-access-key"
  secret_key: "your-secret-key"
  org_id: "default"

# Guacamole 配置
guacamole:
  enabled: false
  endpoint: "https://guacamole.example.com"
  username: "guacadmin"
  password: "your-password"
  data_source: "mysql"
```

## 测试建议

### 单元测试

为每个服务创建单元测试:
- `port_pool_test.go` - 测试端口分配和释放
- `firewall_test.go` - 测试防火墙规则创建(使用 mock)
- `dns_test.go` - 测试 DNS 记录创建(使用 mock)
- `access_info_test.go` - 测试访问信息生成

### 集成测试

创建端到端测试:
1. 创建环境
2. 验证端口已分配
3. 验证防火墙规则已创建
4. 验证 DNS 记录已创建
5. 验证访问信息正确生成
6. 删除环境
7. 验证资源已清理

## 注意事项

1. **安全性:**
   - 密码应该使用安全的随机生成算法
   - API 密钥应该加密存储
   - 防火墙规则应该限制来源 IP

2. **并发安全:**
   - 端口分配使用了 mutex 保护
   - 防火墙和 DNS 操作应该考虑并发场景

3. **错误处理:**
   - 所有外部 API 调用都应该有重试机制
   - 失败时应该回滚已创建的资源

4. **监控和日志:**
   - 记录所有防火墙和 DNS 操作
   - 监控端口使用情况
   - 告警端口池即将用尽

## 总结

本框架提供了完整的端口映射和访问管理解决方案,支持:
- ✅ 自动端口分配和管理
- ✅ 内网和公网访问
- ⚠️ 防火墙集成(框架已完成,需实现具体逻辑)
- ⚠️ DNS 自动配置(框架已完成,需实现具体逻辑)
- ⚠️ Jumpserver 集成(框架已完成,需实现具体逻辑)
- ⚠️ Guacamole 集成(框架已完成,需实现具体逻辑)

所有 TODO 标记的地方都是需要后期实现的具体逻辑,框架和接口已经定义完成,便于团队协作开发。
