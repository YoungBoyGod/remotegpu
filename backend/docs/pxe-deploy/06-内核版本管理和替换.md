# 内核版本管理和替换

## 一、为什么需要指定内核版本

### 1.1 常见场景

在GPU服务器和生产环境中，指定内核版本非常重要：

**GPU驱动兼容性：**
- NVIDIA驱动对内核版本有严格要求
- 某些CUDA版本只支持特定内核范围
- 新内核可能导致驱动编译失败

**稳定性考虑：**
- 新内核可能存在未知bug
- 生产环境需要经过验证的稳定版本
- 避免自动更新导致的系统问题

**软件兼容性：**
- 某些专业软件依赖特定内核特性
- 容器运行时可能对内核有要求
- 网络驱动兼容性问题

### 1.2 内核版本选择建议

**Ubuntu 22.04 LTS推荐内核版本：**

```
5.15.0-x-generic  # LTS内核，最稳定（推荐）
5.19.0-x-generic  # HWE内核，硬件支持更好
6.2.0-x-generic   # 最新HWE内核，新硬件支持
```

**选择原则：**
1. **GPU服务器**：选择与NVIDIA驱动兼容的版本
2. **生产环境**：选择LTS内核（5.15系列）
3. **新硬件**：选择HWE内核（6.2系列）

### 1.3 查看可用内核版本

```bash
# 查看当前内核版本
uname -r

# 查看已安装的内核
dpkg --list | grep linux-image

# 查看可用的内核版本
apt-cache search linux-image-5.15

# 查看特定版本的详细信息
apt-cache show linux-image-5.15.0-91-generic
```

---

## 二、方法一：在Preseed中指定内核版本

### 2.1 修改user-data配置

**编辑 /var/www/html/preseed/user-data：**

```yaml
#cloud-config
autoinstall:
  version: 1

  # 其他配置...

  # 指定内核版本
  packages:
    - ubuntu-desktop
    - openssh-server
    # 指定特定版本的内核
    - linux-image-5.15.0-91-generic
    - linux-headers-5.15.0-91-generic
    - linux-modules-extra-5.15.0-91-generic

  # 后期配置
  late-commands:
    # 设置默认启动内核
    - curtin in-target --target=/target -- update-grub
    - curtin in-target --target=/target -- grub-set-default 0
```

### 2.2 固定内核版本（防止自动更新）

```yaml
late-commands:
  # 标记内核包为手动安装，防止自动更新
  - curtin in-target --target=/target -- apt-mark hold linux-image-5.15.0-91-generic
  - curtin in-target --target=/target -- apt-mark hold linux-headers-5.15.0-91-generic
  - curtin in-target --target=/target -- apt-mark hold linux-modules-extra-5.15.0-91-generic
```

### 2.3 完整配置示例

```yaml
#cloud-config
autoinstall:
  version: 1

  locale: zh_CN.UTF-8
  keyboard:
    layout: us

  identity:
    hostname: gpu-server
    username: remotegpu
    password: "$6$rounds=4096$..."

  storage:
    layout:
      name: lvm

  # 指定内核和其他软件包
  packages:
    - ubuntu-desktop
    - openssh-server
    - build-essential
    # 指定内核版本
    - linux-image-5.15.0-91-generic
    - linux-headers-5.15.0-91-generic
    - linux-modules-extra-5.15.0-91-generic

  late-commands:
    # 固定内核版本
    - curtin in-target -- apt-mark hold linux-image-5.15.0-91-generic
    - curtin in-target -- apt-mark hold linux-headers-5.15.0-91-generic

    # 更新grub
    - curtin in-target -- update-grub

    # 下载并执行后期脚本
    - curtin in-target -- wget -O /tmp/post-install.sh http://192.168.1.10/preseed/post-install.sh
    - curtin in-target -- bash /tmp/post-install.sh
```

---

## 三、方法二：在后期脚本中替换内核

### 3.1 创建内核替换脚本

**创建 /var/www/html/preseed/kernel-replace.sh：**

```bash
#!/bin/bash
# 内核版本替换脚本

set -e

echo "=== 开始内核版本替换 ==="

# 配置变量
TARGET_KERNEL_VERSION="5.15.0-91"
TARGET_KERNEL="linux-image-${TARGET_KERNEL_VERSION}-generic"
TARGET_HEADERS="linux-headers-${TARGET_KERNEL_VERSION}-generic"
TARGET_MODULES="linux-modules-extra-${TARGET_KERNEL_VERSION}-generic"

# 1. 更新软件源
echo "[1/6] 更新软件源..."
apt update

# 2. 安装指定版本内核
echo "[2/6] 安装内核 ${TARGET_KERNEL_VERSION}..."
apt install -y \
    ${TARGET_KERNEL} \
    ${TARGET_HEADERS} \
    ${TARGET_MODULES}

# 3. 获取当前默认内核
CURRENT_KERNEL=$(uname -r)
echo "当前内核: ${CURRENT_KERNEL}"
echo "目标内核: ${TARGET_KERNEL_VERSION}-generic"

# 4. 设置默认启动内核
echo "[3/6] 配置grub默认启动项..."
# 查找新内核在grub菜单中的位置
KERNEL_ENTRY=$(grep "menuentry.*${TARGET_KERNEL_VERSION}" /boot/grub/grub.cfg | head -1 | sed "s/.*'\(.*\)'.*/\1/")
if [ -n "$KERNEL_ENTRY" ]; then
    grub-set-default "$KERNEL_ENTRY"
    echo "已设置默认内核: $KERNEL_ENTRY"
else
    # 如果找不到，设置为第一个
    grub-set-default 0
    echo "设置默认为第一个内核"
fi

# 5. 更新grub配置
echo "[4/6] 更新grub配置..."
update-grub

# 6. 固定内核版本（防止自动更新）
echo "[5/6] 固定内核版本..."
apt-mark hold ${TARGET_KERNEL}
apt-mark hold ${TARGET_HEADERS}
apt-mark hold ${TARGET_MODULES}

# 7. 卸载其他内核（可选）
echo "[6/6] 清理旧内核..."
# 列出所有已安装的内核
INSTALLED_KERNELS=$(dpkg --list | grep linux-image | grep -v ${TARGET_KERNEL_VERSION} | awk '{print $2}')

if [ -n "$INSTALLED_KERNELS" ]; then
    echo "发现以下旧内核:"
    echo "$INSTALLED_KERNELS"

    # 可选：自动删除旧内核
    # for kernel in $INSTALLED_KERNELS; do
    #     apt remove -y $kernel
    # done

    echo "提示: 重启后可手动删除旧内核"
else
    echo "没有发现其他内核版本"
fi

echo "=== 内核替换完成 ==="
echo "请重启系统以使用新内核"
```

### 3.2 设置脚本权限

```bash
sudo chmod +x /var/www/html/preseed/kernel-replace.sh
sudo chown www-data:www-data /var/www/html/preseed/kernel-replace.sh
```

### 3.3 在后期脚本中调用

**修改 /var/www/html/preseed/post-install.sh：**

```bash
#!/bin/bash
set -e

echo "=== RemoteGPU 后期配置脚本 ==="

# ... 其他配置 ...

# 替换内核版本
echo "[X/N] 替换内核版本..."
wget -O /tmp/kernel-replace.sh http://192.168.1.10/preseed/kernel-replace.sh
chmod +x /tmp/kernel-replace.sh
bash /tmp/kernel-replace.sh

# ... 继续其他配置 ...

echo "=== 配置完成，系统将重启 ==="
```

### 3.4 自动重启配置

**在user-data中添加自动重启：**

```yaml
late-commands:
  # 执行后期脚本
  - curtin in-target -- wget -O /tmp/post-install.sh http://192.168.1.10/preseed/post-install.sh
  - curtin in-target -- bash /tmp/post-install.sh

  # 配置自动重启（可选）
  - curtin in-target -- shutdown -r +1 "系统将在1分钟后重启以应用新内核"
```

---

## 四、内核参数配置

### 4.1 常用内核参数

**GPU服务器推荐参数：**

```bash
# 编辑grub配置
sudo vim /etc/default/grub

# 修改GRUB_CMDLINE_LINUX_DEFAULT
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash nomodeset"

# 常用参数说明：
# nomodeset - 禁用KMS，解决显卡驱动冲突
# intel_iommu=on - 启用IOMMU（GPU直通需要）
# iommu=pt - IOMMU直通模式
# pci=realloc - 重新分配PCI资源
# acpi=off - 禁用ACPI（某些硬件兼容性问题）
```

### 4.2 在Preseed中配置内核参数

**在user-data中添加：**

```yaml
late-commands:
  # 配置内核参数
  - curtin in-target -- sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT=".*"/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash nomodeset intel_iommu=on iommu=pt"/' /etc/default/grub
  - curtin in-target -- update-grub
```

### 4.3 在后期脚本中配置

**添加到kernel-replace.sh：**

```bash
# 配置内核参数
configure_kernel_params() {
    echo "配置内核参数..."

    # 备份原配置
    cp /etc/default/grub /etc/default/grub.bak

    # 设置内核参数
    sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT=".*"/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash nomodeset intel_iommu=on iommu=pt"/' /etc/default/grub

    # 更新grub
    update-grub

    echo "内核参数配置完成"
}

# 在主流程中调用
configure_kernel_params
```

---

## 五、验证和测试

### 5.1 验证内核版本

**安装完成后检查：**

```bash
# 查看当前内核版本
uname -r

# 查看已安装的内核
dpkg --list | grep linux-image

# 查看grub默认启动项
grep "^GRUB_DEFAULT" /etc/default/grub

# 查看内核参数
cat /proc/cmdline
```

### 5.2 测试内核功能

```bash
# 测试GPU识别
lspci | grep -i nvidia

# 测试内核模块
lsmod | grep nvidia

# 查看内核日志
dmesg | grep -i error
journalctl -k | tail -50
```

### 5.3 验证内核固定

```bash
# 查看被hold的包
apt-mark showhold

# 应该显示：
# linux-image-5.15.0-91-generic
# linux-headers-5.15.0-91-generic
# linux-modules-extra-5.15.0-91-generic
```

---

## 六、故障排查

### 6.1 内核安装失败

**问题：找不到指定版本的内核**

```bash
# 检查可用版本
apt-cache search linux-image-5.15

# 更新软件源
apt update

# 如果版本太旧，添加HWE源
apt install --install-recommends linux-generic-hwe-22.04
```

### 6.2 启动失败

**问题：更换内核后无法启动**

```bash
# 解决方案：从grub菜单选择旧内核启动

# 1. 重启时按住Shift键进入grub菜单
# 2. 选择"Advanced options"
# 3. 选择旧内核版本启动
# 4. 启动后卸载问题内核

sudo apt remove linux-image-5.15.0-91-generic
sudo update-grub
```

### 6.3 NVIDIA驱动不兼容

**问题：内核版本与驱动不兼容**

```bash
# 查看驱动支持的内核版本
modinfo nvidia | grep vermagic

# 重新编译驱动（如果是dkms安装）
sudo dkms autoinstall

# 或重新安装驱动
sudo apt install --reinstall nvidia-driver-535
```

---

## 七、最佳实践

### 7.1 推荐配置

**生产环境推荐：**

1. **使用LTS内核**（5.15系列）
2. **固定内核版本**（apt-mark hold）
3. **禁用自动更新**
4. **保留一个旧内核**作为备份

### 7.2 完整配置示例

**创建 /var/www/html/preseed/gpu-server-user-data：**

```yaml
#cloud-config
autoinstall:
  version: 1

  locale: zh_CN.UTF-8
  keyboard:
    layout: us

  identity:
    hostname: gpu-server
    username: remotegpu
    password: "$6$rounds=4096$..."

  storage:
    layout:
      name: lvm
    swap:
      size: 0

  # 指定内核版本
  packages:
    - ubuntu-desktop
    - openssh-server
    - build-essential
    - linux-image-5.15.0-91-generic
    - linux-headers-5.15.0-91-generic
    - linux-modules-extra-5.15.0-91-generic

  late-commands:
    # 固定内核版本
    - curtin in-target -- apt-mark hold linux-image-5.15.0-91-generic
    - curtin in-target -- apt-mark hold linux-headers-5.15.0-91-generic

    # 配置内核参数
    - curtin in-target -- sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT=".*"/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash nomodeset intel_iommu=on"/' /etc/default/grub
    - curtin in-target -- update-grub

    # 执行后期脚本
    - curtin in-target -- wget -O /tmp/post-install.sh http://192.168.1.10/preseed/post-install.sh
    - curtin in-target -- bash /tmp/post-install.sh
```

---

## 八、总结

**内核版本管理要点：**

1. ✅ **选择合适的内核版本**
   - GPU服务器：与驱动兼容的版本
   - 生产环境：LTS内核（5.15系列）
   - 新硬件：HWE内核

2. ✅ **两种实现方式**
   - Preseed配置：简单直接
   - 后期脚本：灵活可控

3. ✅ **固定内核版本**
   - 使用apt-mark hold
   - 防止自动更新

4. ✅ **配置内核参数**
   - 根据硬件需求调整
   - GPU服务器需要特殊参数

5. ✅ **验证和测试**
   - 检查内核版本
   - 测试GPU识别
   - 验证驱动兼容性

**下一步：** 集成到完整的PXE部署流程
