# 故障排查和测试指南

## 一、完整测试流程

### 1.1 测试前准备

**检查清单：**

```bash
# 1. 检查DHCP服务
sudo systemctl status isc-dhcp-server

# 2. 检查TFTP服务
sudo systemctl status tftpd-hpa

# 3. 检查HTTP服务
sudo systemctl status apache2

# 4. 验证文件完整性
ls -lh /var/lib/tftpboot/pxelinux.0
ls -lh /var/lib/tftpboot/vmlinuz
ls -lh /var/lib/tftpboot/initrd
ls -lh /var/www/html/preseed/user-data
ls -lh /var/www/html/preseed/post-install.sh
```

### 1.2 网络测试

```bash
# 测试TFTP连接
tftp 192.168.1.10
> get pxelinux.0
> quit

# 测试HTTP访问
curl -I http://192.168.1.10/preseed/user-data
curl -I http://192.168.1.10/preseed/post-install.sh

# 测试DNS解析（如果配置了）
nslookup pxe-server.local
```

### 1.3 启动测试服务器

**步骤：**

1. **配置BIOS**
   - 进入BIOS设置（F2或Del）
   - 启用Network Boot
   - 设置启动顺序：Network → Hard Disk

2. **启动服务器**
   - 保存BIOS设置并重启
   - 观察PXE启动过程

3. **监控日志**
   ```bash
   # 终端1：DHCP日志
   sudo tail -f /var/log/syslog | grep dhcpd

   # 终端2：TFTP日志
   sudo tail -f /var/log/syslog | grep tftpd

   # 终端3：HTTP日志
   sudo tail -f /var/log/apache2/access.log
   ```

### 1.4 验证安装结果

**安装完成后检查：**

```bash
# SSH连接测试
ssh remotegpu@192.168.1.101

# 检查服务状态
systemctl status jupyter
systemctl status code-server@remotegpu
systemctl status docker

# 检查GPU驱动（如果安装了）
nvidia-smi

# 检查工作目录
ls -la /home/remotegpu/workspace/
```

---

## 二、常见问题排查

### 2.1 PXE启动失败

**问题1：显示"PXE-E32: TFTP open timeout"**

```bash
# 原因：无法连接到TFTP服务器

# 解决方案：
# 1. 检查TFTP服务状态
sudo systemctl status tftpd-hpa

# 2. 检查防火墙
sudo ufw status
sudo ufw allow 69/udp

# 3. 检查DHCP配置中的next-server
grep next-server /etc/dhcp/dhcpd.conf

# 4. 测试TFTP连接
tftp 192.168.1.10
```

**问题2：显示"PXE-E3B: TFTP Error - File Not Found"**

```bash
# 原因：找不到启动文件

# 解决方案：
# 1. 检查文件是否存在
ls -l /var/lib/tftpboot/pxelinux.0

# 2. 检查文件权限
sudo chmod 644 /var/lib/tftpboot/pxelinux.0

# 3. 检查DHCP配置中的filename
grep filename /etc/dhcp/dhcpd.conf
```

**问题3：无法获取IP地址**

```bash
# 原因：DHCP服务器未响应

# 解决方案：
# 1. 检查DHCP服务
sudo systemctl status isc-dhcp-server

# 2. 查看DHCP日志
sudo journalctl -u isc-dhcp-server -n 50

# 3. 检查网卡配置
grep INTERFACES /etc/default/isc-dhcp-server

# 4. 测试DHCP
sudo dhclient -v eth0
```

### 2.2 安装过程问题

**问题1：卡在"Downloading installer components"**

```bash
# 原因：网络速度慢或HTTP服务器问题

# 解决方案：
# 1. 检查HTTP服务
sudo systemctl status apache2

# 2. 检查ISO文件
ls -lh /var/www/html/ubuntu/

# 3. 使用本地镜像源
# 在user-data中配置本地镜像
```

**问题2：安装失败，显示"Failed to download packages"**

```bash
# 原因：软件包下载失败

# 解决方案：
# 1. 检查网络连接
ping -c 4 8.8.8.8

# 2. 修改镜像源为国内镜像
# 在user-data中添加：
apt:
  primary:
    - arches: [default]
      uri: http://mirrors.aliyun.com/ubuntu/
```

**问题3：Preseed配置未生效**

```bash
# 原因：user-data配置错误或无法访问

# 解决方案：
# 1. 验证YAML语法
yamllint /var/www/html/preseed/user-data

# 2. 测试HTTP访问
curl http://192.168.1.10/preseed/user-data

# 3. 检查PXE配置中的ds参数
cat /var/lib/tftpboot/pxelinux.cfg/default
# 应该包含：ds=nocloud-net;s=http://192.168.1.10/preseed/
```

### 2.3 后期脚本问题

**问题1：后期脚本未执行**

```bash
# 原因：late-commands配置错误

# 解决方案：
# 1. 检查脚本是否可访问
curl http://192.168.1.10/preseed/post-install.sh

# 2. 检查脚本权限
ls -l /var/www/html/preseed/post-install.sh

# 3. 查看安装日志
cat /var/log/installer/autoinstall-user-data
cat /var/log/cloud-init-output.log
```

**问题2：脚本执行失败**

```bash
# 原因：脚本中的命令错误

# 解决方案：
# 1. 查看脚本日志
cat /var/log/post-install.log

# 2. 手动执行脚本测试
bash -x /var/www/html/preseed/post-install.sh

# 3. 检查网络连接
ping -c 4 8.8.8.8
```

---

## 三、性能优化

### 3.1 加速安装

**使用本地镜像源：**

```bash
# 创建本地镜像目录
sudo mkdir -p /var/www/html/ubuntu-mirror

# 使用apt-mirror同步镜像
sudo apt install apt-mirror
sudo vim /etc/apt/mirror.list

# 在user-data中配置
apt:
  primary:
    - arches: [default]
      uri: http://192.168.1.10/ubuntu-mirror/
```

**使用apt-cacher-ng：**

```bash
# 安装apt-cacher-ng
sudo apt install apt-cacher-ng

# 在user-data中配置
apt:
  http_proxy: http://192.168.1.10:3142
```

### 3.2 并行安装

**批量部署脚本：**

```bash
#!/bin/bash
# 批量重装服务器

SERVERS=(
    "192.168.1.101:00:11:22:33:44:55"
    "192.168.1.102:00:11:22:33:44:56"
    "192.168.1.103:00:11:22:33:44:57"
)

for server in "${SERVERS[@]}"; do
    IP="${server%%:*}"
    MAC="${server##*:}"

    echo "触发重装: $IP ($MAC)"
    ssh remotegpu@$IP "sudo reboot" &
    sleep 2
done

wait
echo "所有服务器重装任务已启动"
```

### 3.3 减少安装时间

**优化策略：**

1. **最小化软件包**
   - 只在preseed中安装必要的包
   - 其他软件在后期脚本中安装

2. **使用SSD存储**
   - 将ISO和preseed文件存储在SSD上
   - 提高读取速度

3. **优化网络**
   - 使用千兆网络
   - 减少网络跳数

---

## 四、维护指南

### 4.1 定期维护

**每周任务：**

```bash
# 检查服务状态
sudo systemctl status isc-dhcp-server
sudo systemctl status tftpd-hpa
sudo systemctl status apache2

# 检查磁盘空间
df -h /var/lib/tftpboot
df -h /var/www/html

# 清理日志
sudo journalctl --vacuum-time=7d
```

**每月任务：**

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 更新Ubuntu ISO
# 下载最新版本并替换旧版本

# 备份配置文件
sudo tar -czf /backup/pxe-config-$(date +%Y%m%d).tar.gz \
    /etc/dhcp/dhcpd.conf \
    /etc/default/tftpd-hpa \
    /var/lib/tftpboot/pxelinux.cfg/ \
    /var/www/html/preseed/
```

### 4.2 监控脚本

**创建监控脚本：**

```bash
#!/bin/bash
# /usr/local/bin/monitor-pxe.sh

LOG_FILE="/var/log/pxe-monitor.log"

check_service() {
    SERVICE=$1
    if ! systemctl is-active --quiet $SERVICE; then
        echo "[$(date)] 警告: $SERVICE 服务未运行" >> $LOG_FILE
        systemctl restart $SERVICE
    fi
}

check_service isc-dhcp-server
check_service tftpd-hpa
check_service apache2

# 检查磁盘空间
DISK_USAGE=$(df -h /var/www/html | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "[$(date)] 警告: 磁盘使用率超过80%" >> $LOG_FILE
fi
```

**添加到crontab：**

```bash
# 每5分钟检查一次
*/5 * * * * /usr/local/bin/monitor-pxe.sh
```

### 4.3 备份和恢复

**备份脚本：**

```bash
#!/bin/bash
# 备份PXE配置

BACKUP_DIR="/backup/pxe"
DATE=$(date +%Y%m%d)

mkdir -p $BACKUP_DIR

# 备份配置文件
tar -czf $BACKUP_DIR/config-$DATE.tar.gz \
    /etc/dhcp/ \
    /etc/default/tftpd-hpa \
    /var/lib/tftpboot/pxelinux.cfg/ \
    /var/www/html/preseed/

# 保留最近7天的备份
find $BACKUP_DIR -name "config-*.tar.gz" -mtime +7 -delete
```

**恢复脚本：**

```bash
#!/bin/bash
# 恢复PXE配置

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
    echo "用法: $0 <备份文件>"
    exit 1
fi

# 解压备份
tar -xzf $BACKUP_FILE -C /

# 重启服务
systemctl restart isc-dhcp-server
systemctl restart tftpd-hpa
systemctl restart apache2
```

---

## 五、总结

**PXE部署系统要点：**
1. ✅ 定期检查服务状态
2. ✅ 监控磁盘空间和网络
3. ✅ 定期备份配置文件
4. ✅ 保持系统和软件更新
5. ✅ 记录所有变更

**完整的PXE部署系统已配置完成！**

**文档系列：**
- 01-DHCP服务器配置详解
- 02-TFTP和PXE启动配置
- 03-Preseed自动化安装配置
- 04-后期配置脚本详解
- 05-故障排查和测试指南（本文档）
