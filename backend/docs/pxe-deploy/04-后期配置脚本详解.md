# 后期配置脚本详解

## 一、后期脚本概述

### 1.1 什么是后期配置脚本

后期配置脚本（Post-Installation Script）是在系统安装完成后自动执行的脚本，用于：
- 安装额外的软件包
- 配置系统服务
- 设置用户环境
- 部署应用程序
- 执行安全加固

### 1.2 执行时机

```
系统安装完成 → 执行late-commands
              → 下载post-install.sh
              → 执行配置脚本
              → 重启进入新系统
```

### 1.3 脚本位置

```
/var/www/html/preseed/post-install.sh        # 默认脚本
/var/www/html/preseed/gpu-setup.sh           # GPU服务器专用
/var/www/html/preseed/workstation-setup.sh   # 工作站专用
```

---

## 二、基础配置脚本

### 2.1 脚本模板

**创建 /var/www/html/preseed/post-install.sh：**

```bash
#!/bin/bash
# RemoteGPU 后期配置脚本
# 适用于：Ubuntu 22.04 Desktop

set -e  # 遇到错误立即退出
set -x  # 显示执行的命令（调试用）

# 日志文件
LOG_FILE="/var/log/post-install.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "==================================="
echo "开始后期配置"
echo "时间: $(date)"
echo "==================================="

# 配置变量
USERNAME="remotegpu"
WORKSPACE_DIR="/home/$USERNAME/workspace"

# 1. 系统更新
echo "[1/10] 更新系统..."
apt update
apt upgrade -y

# 2. 配置时区
echo "[2/10] 配置时区..."
timedatectl set-timezone Asia/Shanghai

# 3. 配置主机名
echo "[3/10] 配置主机名..."
hostnamectl set-hostname remotegpu-server

echo "==================================="
echo "后期配置完成"
echo "时间: $(date)"
echo "==================================="
```

### 2.2 用户和权限配置

```bash
# 配置用户权限
configure_user() {
    echo "配置用户权限..."

    # 添加sudo权限（无需密码）
    echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/$USERNAME
    chmod 440 /etc/sudoers.d/$USERNAME

    # 添加到docker组
    usermod -aG docker $USERNAME

    # 添加到其他必要的组
    usermod -aG sudo $USERNAME
    usermod -aG video $USERNAME
    usermod -aG audio $USERNAME

    echo "用户权限配置完成"
}
```

### 2.3 SSH配置

```bash
# 配置SSH服务
configure_ssh() {
    echo "配置SSH服务..."

    # 备份原配置
    cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

    # 修改SSH配置
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
    sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config

    # 禁用空密码登录
    sed -i 's/#PermitEmptyPasswords no/PermitEmptyPasswords no/' /etc/ssh/sshd_config

    # 重启SSH服务
    systemctl restart sshd
    systemctl enable sshd

    echo "SSH配置完成"
}
```

### 2.4 防火墙配置

```bash
# 配置防火墙
configure_firewall() {
    echo "配置防火墙..."

    # 安装ufw（如果未安装）
    apt install -y ufw

    # 默认策略
    ufw default deny incoming
    ufw default allow outgoing

    # 允许SSH
    ufw allow 22/tcp

    # 允许Jupyter
    ufw allow 8888/tcp

    # 允许Code Server
    ufw allow 8080/tcp

    # 允许RDP（如果需要）
    ufw allow 3389/tcp

    # 启用防火墙
    ufw --force enable

    echo "防火墙配置完成"
}
```

---

## 三、Docker配置

### 3.1 Docker安装和配置

```bash
# 配置Docker
configure_docker() {
    echo "配置Docker..."

    # Docker应该已经通过packages安装
    # 这里只做配置

    # 启动Docker服务
    systemctl start docker
    systemctl enable docker

    # 配置Docker镜像加速（阿里云）
    mkdir -p /etc/docker
    cat > /etc/docker/daemon.json << 'EOF'
{
  "registry-mirrors": [
    "https://mirror.ccs.tencentyun.com",
    "https://registry.docker-cn.com"
  ],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  },
  "storage-driver": "overlay2"
}
EOF

    # 重启Docker
    systemctl daemon-reload
    systemctl restart docker

    # 验证Docker
    docker --version
    docker run hello-world

    echo "Docker配置完成"
}
```

### 3.2 Docker Compose安装

```bash
# 安装Docker Compose
install_docker_compose() {
    echo "安装Docker Compose..."

    # 下载最新版本
    COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
    curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

    # 设置执行权限
    chmod +x /usr/local/bin/docker-compose

    # 验证安装
    docker-compose --version

    echo "Docker Compose安装完成"
}
```

---

## 四、开发工具安装

### 4.1 Python环境配置

```bash
# 配置Python环境
configure_python() {
    echo "配置Python环境..."

    # 更新pip
    pip3 install --upgrade pip

    # 安装常用Python包
    pip3 install --no-cache-dir \
        numpy \
        pandas \
        matplotlib \
        scikit-learn \
        jupyter \
        jupyterlab \
        ipywidgets \
        notebook

    # 安装深度学习框架（可选）
    # pip3 install torch torchvision torchaudio

    # 验证安装
    python3 --version
    pip3 --version

    echo "Python环境配置完成"
}
```

### 4.2 Jupyter Lab配置

```bash
# 配置Jupyter Lab
configure_jupyter() {
    echo "配置Jupyter Lab..."

    # 创建Jupyter配置目录
    mkdir -p /home/$USERNAME/.jupyter

    # 生成配置文件
    sudo -u $USERNAME jupyter lab --generate-config

    # 配置Jupyter
    cat >> /home/$USERNAME/.jupyter/jupyter_lab_config.py << 'EOF'
c.ServerApp.ip = '0.0.0.0'
c.ServerApp.port = 8888
c.ServerApp.open_browser = False
c.ServerApp.allow_root = True
c.ServerApp.token = ''
c.ServerApp.password = ''
EOF

    # 设置权限
    chown -R $USERNAME:$USERNAME /home/$USERNAME/.jupyter

    # 创建systemd服务
    cat > /etc/systemd/system/jupyter.service << EOF
[Unit]
Description=Jupyter Lab
After=network.target

[Service]
Type=simple
User=$USERNAME
WorkingDirectory=$WORKSPACE_DIR
ExecStart=/usr/local/bin/jupyter lab --config=/home/$USERNAME/.jupyter/jupyter_lab_config.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

    # 启动服务
    systemctl daemon-reload
    systemctl enable jupyter
    systemctl start jupyter

    echo "Jupyter Lab配置完成"
}
```

### 4.3 Code Server配置

```bash
# 安装和配置Code Server
configure_code_server() {
    echo "配置Code Server..."

    # 安装Code Server
    curl -fsSL https://code-server.dev/install.sh | sh

    # 创建配置目录
    mkdir -p /home/$USERNAME/.config/code-server

    # 配置Code Server
    cat > /home/$USERNAME/.config/code-server/config.yaml << 'EOF'
bind-addr: 0.0.0.0:8080
auth: password
password: remotegpu123
cert: false
EOF

    # 设置权限
    chown -R $USERNAME:$USERNAME /home/$USERNAME/.config

    # 启动服务
    systemctl enable --now code-server@$USERNAME

    echo "Code Server配置完成"
}
```

---

## 五、桌面环境配置

### 5.1 自动登录配置

```bash
# 配置自动登录
configure_auto_login() {
    echo "配置自动登录..."

    # 创建GDM配置目录
    mkdir -p /etc/gdm3

    # 配置自动登录
    cat > /etc/gdm3/custom.conf << EOF
[daemon]
AutomaticLoginEnable=true
AutomaticLogin=$USERNAME

[security]

[xdmcp]

[chooser]

[debug]
EOF

    echo "自动登录配置完成"
}
```

### 5.2 禁用屏幕锁定

```bash
# 禁用屏幕锁定和省电模式
disable_screen_lock() {
    echo "禁用屏幕锁定..."

    # 使用dbus-launch执行gsettings命令
    sudo -u $USERNAME dbus-launch gsettings set org.gnome.desktop.screensaver lock-enabled false
    sudo -u $USERNAME dbus-launch gsettings set org.gnome.desktop.screensaver idle-activation-enabled false
    sudo -u $USERNAME dbus-launch gsettings set org.gnome.desktop.session idle-delay 0

    # 禁用自动挂起
    sudo -u $USERNAME dbus-launch gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-type 'nothing'
    sudo -u $USERNAME dbus-launch gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-battery-type 'nothing'

    echo "屏幕锁定已禁用"
}
```

### 5.3 工作目录配置

```bash
# 创建工作目录
setup_workspace() {
    echo "创建工作目录..."

    # 创建主工作目录
    mkdir -p $WORKSPACE_DIR

    # 创建子目录
    mkdir -p $WORKSPACE_DIR/projects
    mkdir -p $WORKSPACE_DIR/datasets
    mkdir -p $WORKSPACE_DIR/models
    mkdir -p $WORKSPACE_DIR/notebooks

    # 设置权限
    chown -R $USERNAME:$USERNAME $WORKSPACE_DIR
    chmod -R 755 $WORKSPACE_DIR

    # 创建README
    cat > $WORKSPACE_DIR/README.md << 'EOF'
# RemoteGPU Workspace

## 目录结构

- `projects/` - 项目代码
- `datasets/` - 数据集
- `models/` - 训练模型
- `notebooks/` - Jupyter笔记本

## 访问方式

- Jupyter Lab: http://localhost:8888
- Code Server: http://localhost:8080
- SSH: ssh remotegpu@localhost
EOF

    chown $USERNAME:$USERNAME $WORKSPACE_DIR/README.md

    echo "工作目录创建完成"
}
```

---

## 六、GPU驱动安装

### 6.1 NVIDIA驱动安装

```bash
# 安装NVIDIA驱动
install_nvidia_driver() {
    echo "安装NVIDIA驱动..."

    # 检测GPU
    if ! lspci | grep -i nvidia > /dev/null; then
        echo "未检测到NVIDIA GPU，跳过驱动安装"
        return
    fi

    # 添加NVIDIA PPA
    add-apt-repository -y ppa:graphics-drivers/ppa
    apt update

    # 安装驱动（535版本）
    apt install -y nvidia-driver-535 nvidia-utils-535

    # 验证安装（重启后才能生效）
    echo "NVIDIA驱动安装完成，重启后生效"
}
```

### 6.2 CUDA安装

```bash
# 安装CUDA Toolkit
install_cuda() {
    echo "安装CUDA Toolkit..."

    # 下载CUDA安装包
    CUDA_VERSION="12.0.0"
    CUDA_INSTALLER="cuda-repo-ubuntu2204-12-0-local_12.0.0-525.60.13-1_amd64.deb"

    cd /tmp
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/$CUDA_INSTALLER

    # 安装
    dpkg -i $CUDA_INSTALLER
    cp /var/cuda-repo-ubuntu2204-12-0-local/cuda-*-keyring.gpg /usr/share/keyrings/
    apt update
    apt install -y cuda

    # 配置环境变量
    cat >> /home/$USERNAME/.bashrc << 'EOF'

# CUDA环境变量
export PATH=/usr/local/cuda/bin:$PATH
export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
EOF

    # 清理安装包
    rm -f /tmp/$CUDA_INSTALLER

    echo "CUDA安装完成"
}
```

### 6.3 cuDNN安装

```bash
# 安装cuDNN
install_cudnn() {
    echo "安装cuDNN..."

    # 注意：cuDNN需要从NVIDIA官网下载
    # 这里假设已经下载到/tmp目录

    CUDNN_TAR="cudnn-linux-x86_64-8.9.0.131_cuda12-archive.tar.xz"

    if [ -f "/tmp/$CUDNN_TAR" ]; then
        cd /tmp
        tar -xvf $CUDNN_TAR

        # 复制文件
        cp cudnn-*-archive/include/cudnn*.h /usr/local/cuda/include
        cp -P cudnn-*-archive/lib/libcudnn* /usr/local/cuda/lib64
        chmod a+r /usr/local/cuda/include/cudnn*.h /usr/local/cuda/lib64/libcudnn*

        echo "cuDNN安装完成"
    else
        echo "cuDNN安装包不存在，跳过安装"
    fi
}
```

---

## 七、完整主脚本示例

### 7.1 完整的post-install.sh

```bash
#!/bin/bash
# RemoteGPU 后期配置脚本 - 完整版
# 适用于：Ubuntu 22.04 Desktop

set -e
set -x

# 日志配置
LOG_FILE="/var/log/post-install.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "==================================="
echo "RemoteGPU 后期配置脚本"
echo "开始时间: $(date)"
echo "==================================="

# 配置变量
USERNAME="remotegpu"
WORKSPACE_DIR="/home/$USERNAME/workspace"

# 导入所有函数
configure_user() {
    echo "[1/12] 配置用户权限..."
    echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/$USERNAME
    chmod 440 /etc/sudoers.d/$USERNAME
    usermod -aG docker,sudo,video,audio $USERNAME
}

configure_ssh() {
    echo "[2/12] 配置SSH服务..."
    cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
    systemctl restart sshd
}

configure_firewall() {
    echo "[3/12] 配置防火墙..."
    apt install -y ufw
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow 22/tcp
    ufw allow 8888/tcp
    ufw allow 8080/tcp
    ufw --force enable
}

configure_docker() {
    echo "[4/12] 配置Docker..."
    systemctl start docker
    systemctl enable docker
    mkdir -p /etc/docker
    cat > /etc/docker/daemon.json << 'EOF'
{
  "registry-mirrors": ["https://mirror.ccs.tencentyun.com"],
  "log-driver": "json-file",
  "log-opts": {"max-size": "100m", "max-file": "3"}
}
EOF
    systemctl daemon-reload
    systemctl restart docker
}

configure_python() {
    echo "[5/12] 配置Python环境..."
    pip3 install --upgrade pip
    pip3 install --no-cache-dir numpy pandas matplotlib scikit-learn jupyter jupyterlab ipywidgets notebook
}

configure_jupyter() {
    echo "[6/12] 配置Jupyter Lab..."
    mkdir -p /home/$USERNAME/.jupyter
    sudo -u $USERNAME jupyter lab --generate-config
    cat >> /home/$USERNAME/.jupyter/jupyter_lab_config.py << 'EOF'
c.ServerApp.ip = '0.0.0.0'
c.ServerApp.port = 8888
c.ServerApp.open_browser = False
c.ServerApp.allow_root = True
EOF
    chown -R $USERNAME:$USERNAME /home/$USERNAME/.jupyter

    cat > /etc/systemd/system/jupyter.service << EOF
[Unit]
Description=Jupyter Lab
After=network.target
[Service]
Type=simple
User=$USERNAME
WorkingDirectory=$WORKSPACE_DIR
ExecStart=/usr/local/bin/jupyter lab
Restart=always
[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable jupyter
}

configure_code_server() {
    echo "[7/12] 配置Code Server..."
    curl -fsSL https://code-server.dev/install.sh | sh
    mkdir -p /home/$USERNAME/.config/code-server
    cat > /home/$USERNAME/.config/code-server/config.yaml << 'EOF'
bind-addr: 0.0.0.0:8080
auth: password
password: remotegpu123
cert: false
EOF
    chown -R $USERNAME:$USERNAME /home/$USERNAME/.config
    systemctl enable --now code-server@$USERNAME
}

configure_auto_login() {
    echo "[8/12] 配置自动登录..."
    mkdir -p /etc/gdm3
    cat > /etc/gdm3/custom.conf << EOF
[daemon]
AutomaticLoginEnable=true
AutomaticLogin=$USERNAME
EOF
}

disable_screen_lock() {
    echo "[9/12] 禁用屏幕锁定..."
    sudo -u $USERNAME dbus-launch gsettings set org.gnome.desktop.screensaver lock-enabled false
    sudo -u $USERNAME dbus-launch gsettings set org.gnome.desktop.session idle-delay 0
}

setup_workspace() {
    echo "[10/12] 创建工作目录..."
    mkdir -p $WORKSPACE_DIR/{projects,datasets,models,notebooks}
    chown -R $USERNAME:$USERNAME $WORKSPACE_DIR
}

install_nvidia_driver() {
    echo "[11/12] 安装NVIDIA驱动..."
    if lspci | grep -i nvidia > /dev/null; then
        add-apt-repository -y ppa:graphics-drivers/ppa
        apt update
        apt install -y nvidia-driver-535 nvidia-utils-535
    else
        echo "未检测到NVIDIA GPU，跳过"
    fi
}

cleanup() {
    echo "[12/12] 清理..."
    apt clean
    rm -rf /tmp/*
}

# 执行所有配置
configure_user
configure_ssh
configure_firewall
configure_docker
configure_python
configure_jupyter
configure_code_server
configure_auto_login
disable_screen_lock
setup_workspace
install_nvidia_driver
cleanup

echo "==================================="
echo "后期配置完成"
echo "结束时间: $(date)"
echo "==================================="
```

### 7.2 设置脚本权限

```bash
sudo chmod +x /var/www/html/preseed/post-install.sh
sudo chown www-data:www-data /var/www/html/preseed/post-install.sh
```

---

## 八、故障排查

### 8.1 脚本执行失败

**查看日志：**

```bash
# 在安装完成的系统上查看日志
cat /var/log/post-install.log

# 查看cloud-init日志
cat /var/log/cloud-init-output.log
```

**常见错误：**

1. **网络问题导致下载失败**
```bash
# 检查网络连接
ping -c 4 8.8.8.8

# 使用国内镜像
sed -i 's|http://archive.ubuntu.com|http://mirrors.aliyun.com|g' /etc/apt/sources.list
```

2. **权限问题**
```bash
# 确保脚本有执行权限
chmod +x /var/www/html/preseed/post-install.sh

# 检查HTTP服务器权限
ls -l /var/www/html/preseed/
```

### 8.2 服务启动失败

**检查服务状态：**

```bash
# 检查Jupyter服务
systemctl status jupyter

# 检查Code Server服务
systemctl status code-server@remotegpu

# 查看服务日志
journalctl -u jupyter -n 50
journalctl -u code-server@remotegpu -n 50
```

### 8.3 GPU驱动问题

**验证驱动安装：**

```bash
# 检查NVIDIA驱动
nvidia-smi

# 如果命令不存在，重新安装
apt install -y nvidia-driver-535
reboot
```

---

## 九、总结

**后期配置脚本要点：**
1. ✅ 使用函数模块化组织代码
2. ✅ 添加详细的日志记录
3. ✅ 使用set -e确保错误时退出
4. ✅ 配置所有必要的服务
5. ✅ 清理临时文件

**下一步：** 完整测试PXE部署流程
