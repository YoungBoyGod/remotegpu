# CodeX 任务停止 Agent 集成说明

- 作者: CodeX
- 日期: 2026-02-05

## 概念说明

任务停止的 Agent 集成指的是：当用户在平台发起“停止任务”操作时，后端不仅更新数据库状态，还会调用目标机器上的 Agent 接口（StopProcess）终止实际运行的进程，从而保证任务状态与真实运行状态一致。

## 使用场景

- 用户主动取消训练/推理任务，避免继续占用 GPU 资源。
- 任务异常或超时，需要平台强制终止。
- 管理员紧急回收机器资源或处理异常任务。

## 为什么需要

- 仅更新数据库状态会导致任务仍在机器上运行，造成资源泄漏。
- 任务状态与真实运行状态不一致会引发计费与资源调度错误。
- 统一的 Agent 停止接口便于形成可审计、可追踪的运维链路。

## 集成要点

- 任务必须记录对应的 `host_id` 与 `process_id`。
- 停止流程：
  1. 校验 Agent 可用、`host_id/process_id` 完整。
  2. 调用 Agent StopProcess 终止进程。
  3. 成功后更新任务状态为 `stopped`；失败则保持原状态并记录 `error_msg`。
- 禁止使用 `task.id` 代替 `process_id`。

## Review 与改进说明

- 旧实现问题：
  - 调用停止接口时未传入 `process_id`，实际无法终止进程。
  - 失败也直接把任务置为 `stopped`，导致状态与实际运行不一致。
- 新实现改进：
  - 增加 `process_id` 字段并校验必填。
  - 调用 Agent 成功后才更新状态，失败写入 `error_msg`。
  - 使任务停止具有可追踪的失败原因。

## 注意事项

- 任务启动流程需要写入 `process_id`，否则停止会返回 “process id missing”。
- 建议在任务运行器/调度器侧完成 `process_id` 回写与状态更新。
