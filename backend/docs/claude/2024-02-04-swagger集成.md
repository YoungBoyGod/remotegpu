# Swagger API 文档集成

**日期**: 2024-02-04
**任务**: 为项目集成 OpenAPI v3 Swagger 文档

---

## 完成的工作

### 1. 配置层
- **config.go**: 添加 `SwaggerConfig` 结构体
  - 包含: enabled, title, description, version, base_path, openapi_path, schemes
  - 新增 `ServerConfig.Host` 字段用于对外访问域名

- **config.yaml**: 添加 swagger 配置项
  ```yaml
  swagger:
    enabled: true
    title: "RemoteGPU API"
    openapi_path: "/openapi.yaml"
  ```

### 2. 中间件层
- **创建文件**: `internal/middleware/swagger.go`
- **核心功能**:
  - `SetupSwagger(r *gin.Engine)` 函数
  - 动态替换 OpenAPI 文档中的服务器地址
  - 提供 `/swagger/openapi.yaml` 端点
  - 集成 gin-swagger UI

### 3. 路由集成
- **router.go**: 在 `InitRouter` 中调用 `SetupSwagger(r)`
- **自动启动**: 通过 `server.go` 的 `createGinEngine()` 自动执行

### 4. OpenAPI 文档
- **创建文件**: `docs/openapi.yaml`
- **内容**: 完整的 API 定义（26个接口）
  - 认证模块: 4个接口
  - 管理员模块: 13个接口
  - 客户模块: 9个接口

### 5. 依赖安装
```bash
go get -u github.com/swaggo/gin-swagger github.com/swaggo/files
```

---

## 关键特性

✅ **自动启动**: 服务启动时自动加载 Swagger UI
✅ **动态地址**: 服务器地址根据请求 host 动态替换
✅ **配置开关**: 通过 `swagger.enabled` 控制启用/禁用
✅ **完整集成**: 融入现有的 server.go 启动流程（热更新、优雅启动等）

---

## 使用方法

### 启动服务
```bash
# 方式1: 直接运行
go run cmd/*.go server

# 方式2: 编译后运行
go build -o remotegpu cmd/*.go
./remotegpu server --config ./config/config.yaml
```

### 访问文档
- **Swagger UI**: http://localhost:8080/swagger/index.html
- **OpenAPI YAML**: http://localhost:8080/swagger/openapi.yaml
- **API 基础路径**: http://localhost:8080/api/v1

---

## 注意事项

1. **文件位置**: OpenAPI 文档位于 `docs/openapi.yaml`
2. **配置依赖**: 需要在 `config.yaml` 中正确配置 swagger 部分
3. **端口一致**: Swagger 自动使用 `server.port` 配置的端口
4. **开发模式**: debug 模式下可直接访问 `/swagger` 重定向到文档页面

---

## 文件清单

**新增文件**:
- `internal/middleware/swagger.go`
- `docs/openapi.yaml`

**修改文件**:
- `config/config.go` - 添加 SwaggerConfig
- `config/config.yaml` - 添加 swagger 配置
- `internal/router/router.go` - 调用 SetupSwagger
- `cmd/main.go` - 恢复为 cobra 入口

**依赖更新**:
- `go.mod` / `go.sum` - 新增 swagger 相关依赖
