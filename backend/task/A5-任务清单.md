# A5 - Environment 模型任务清单

## 👤 基本信息

**员工编号**: A5
**负责模块**: Environment 模型
**优先级**: P0（最高）
**预估总工时**: 14 小时
**开始日期**: 2026-02-01
**预计完成**: 2026-02-03

---

## 📋 任务概述

负责实现 Environment（环境）和 PortMapping（端口映射）的数据模型和数据访问层，包括：
- Environment 实体模型设计和实现
- PortMapping 实体模型设计和实现
- EnvironmentDao 实现
- PortMappingDao 实现
- 端口分配逻辑
- 单元测试

**重要性**: Environment 是核心业务模型，A6 的环境创建逻辑依赖此模块。

---

## 🎯 交付目标

### 必须交付
- [ ] Environment 实体模型
- [ ] PortMapping 实体模型
- [ ] EnvironmentDao（完整 CRUD）
- [ ] PortMappingDao（完整 CRUD）
- [ ] 端口分配逻辑
- [ ] 单元测试（覆盖率 > 80%）

### 质量标准
- 代码符合 Go 规范
- 所有公开方法有注释
- 错误处理完善
- 测试覆盖率 > 80%
- 通过代码审查

---

## 📝 详细任务分解

### Task 5.1: Environment 实体模型 ⏸️

**预估工时**: 4 小时
**优先级**: P0
**依赖**: A1 完成 Workspace 实体（Task 1.1）
**状态**: ⏸️ 待开始

#### 子任务

**5.1.1 创建文件和基础结构** (1.5h)
- [ ] 创建文件 `internal/model/entity/environment.go`
- [ ] 添加 package 声明和必要的 import
- [ ] 定义 Environment 结构体
- [ ] 参考 SQL: `sql/04_resources.sql`
- [ ] 添加所有字段：
  - ID (uint, 主键)
  - UUID (string, 唯一索引)
  - Name (string)
  - CustomerID (uint, 外键)
  - WorkspaceID (uint, 外键)
  - HostID (uint, 外键)
  - Image (string)
  - Command ([]string, JSON)
  - Args ([]string, JSON)
  - Env (map[string]string, JSON)
  - CPU (int)
  - Memory (int64)
  - GPUIDs ([]uint, JSON)
  - Storage (int64)
  - Status (string)
  - AccessInfo (JSON)
  - CreatedAt, UpdatedAt, DeletedAt

**5.1.2 添加 GORM 标签** (1h)
- [ ] 添加 GORM 标签（主键、索引、外键）
- [ ] 添加 JSON 标签
- [ ] 配置 JSONB 类型（Command, Args, Env, GPUIDs, AccessInfo）
- [ ] 添加状态枚举验证

**5.1.3 添加关联关系** (0.5h)
- [ ] 添加 Customer 关联（belongs to）
- [ ] 添加 Workspace 关联（belongs to）
- [ ] 添加 Host 关联（belongs to）
- [ ] 添加 PortMappings 关联（has many）
- [ ] 实现 TableName() 方法返回 "environments"

**5.1.4 单元测试** (1h)
- [ ] 创建测试文件 `environment_test.go`
- [ ] 测试结构体创建
- [ ] 测试 JSONB 字段序列化
- [ ] 测试关联关系

#### 验收标准
- [ ] 文件创建成功
- [ ] 所有字段定义正确
- [ ] GORM 标签完整
- [ ] JSONB 配置正确
- [ ] 关联关系正确
- [ ] 单元测试通过

#### Git 提交
```bash
git add internal/model/entity/environment.go
git add internal/model/entity/environment_test.go
git commit -m "[Environment] 添加 Environment 实体模型

- 创建 Environment 结构体
- 添加所有必需字段和 GORM 标签
- 配置 JSONB 字段
- 添加关联关系
- 单元测试覆盖率: XX%
"
```

---

### Task 5.2: PortMapping 实体模型 ⏸️

**预估工时**: 2 小时
**优先级**: P0
**依赖**: Task 5.1
**状态**: ⏸️ 待开始

#### 子任务

**5.2.1 创建文件和基础结构** (0.5h)
- [ ] 在 `environment.go` 中添加 PortMapping 结构体
- [ ] 定义字段：
  - ID (uint, 主键)
  - EnvironmentID (uint, 外键)
  - HostID (uint, 外键)
  - ContainerPort (int)
  - HostPort (int)
  - Protocol (string, TCP/UDP)
  - CreatedAt

**5.2.2 添加唯一约束** (0.5h)
- [ ] 添加唯一索引：`idx_host_port` (HostID, HostPort, Protocol)
- [ ] 添加 GORM 标签
- [ ] 实现 TableName() 方法

**5.2.3 单元测试** (1h)
- [ ] 测试结构体创建
- [ ] 测试唯一约束
- [ ] 测试关联关系

#### 验收标准
- [ ] PortMapping 结构体定义正确
- [ ] 唯一约束配置正确
- [ ] 单元测试通过

#### Git 提交
```bash
git add internal/model/entity/environment.go
git commit -m "[Environment] 添加 PortMapping 实体模型

- 创建 PortMapping 结构体
- 添加唯一约束 (HostID, HostPort, Protocol)
- 添加关联关系
- 单元测试覆盖率: XX%
"
```

---

### Task 5.3: EnvironmentDao ⏸️

**预估工时**: 4 小时
**优先级**: P0
**依赖**: Task 5.1
**状态**: ⏸️ 待开始

#### 子任务

**5.3.1 创建基础结构** (0.5h)
- [ ] 创建文件 `internal/dao/environment.go`
- [ ] 定义 EnvironmentDao 结构体
- [ ] 实现 NewEnvironmentDao() 构造函数

**5.3.2 实现 CRUD 方法** (2h)
- [ ] Create(env *entity.Environment) error
- [ ] GetByID(id uint) (*entity.Environment, error)
- [ ] GetByUUID(uuid string) (*entity.Environment, error)
- [ ] Update(env *entity.Environment) error
- [ ] Delete(id uint) error
- [ ] 添加 Preload 关联数据

**5.3.3 实现查询方法** (0.5h)
- [ ] GetByCustomerID(customerID uint) ([]*entity.Environment, error)
- [ ] GetByWorkspaceID(workspaceID uint) ([]*entity.Environment, error)
- [ ] GetByHostID(hostID uint) ([]*entity.Environment, error)
- [ ] GetByStatus(status string) ([]*entity.Environment, error)
- [ ] List(page, pageSize int) ([]*entity.Environment, int64, error)

**5.3.4 单元测试** (1h)
- [ ] 创建测试文件 `environment_test.go`
- [ ] 测试所有 CRUD 方法
- [ ] 测试查询方法
- [ ] 测试关联数据加载

#### 验收标准
- [ ] 所有方法实现正确
- [ ] 关联数据加载正确
- [ ] 单元测试通过
- [ ] 测试覆盖率 > 80%

#### Git 提交
```bash
git add internal/dao/environment.go
git add internal/dao/environment_test.go
git commit -m "[Environment] 实现 EnvironmentDao

- 实现完整的 CRUD 方法
- 实现查询方法
- 支持关联数据加载
- 单元测试覆盖率: XX%
"
```

---

### Task 5.4: PortMappingDao ⏸️

**预估工时**: 4 小时
**优先级**: P0
**依赖**: Task 5.2
**状态**: ⏸️ 待开始

#### 子任务

**5.4.1 创建基础结构** (0.5h)
- [ ] 在 `environment.go` 中添加 PortMappingDao
- [ ] 实现构造函数

**5.4.2 实现端口分配逻辑** (2h)
- [ ] AllocatePort(hostID uint, containerPort int, protocol string) (*entity.PortMapping, error)
  - 查询主机上已使用的端口
  - 从端口范围中分配可用端口（如 30000-32767）
  - 使用事务和行锁防止并发冲突
  - 创建 PortMapping 记录
- [ ] ReleasePort(id uint) error
- [ ] GetAvailablePort(hostID uint) (int, error)

**5.4.3 实现查询方法** (0.5h)
- [ ] GetByEnvironmentID(envID uint) ([]*entity.PortMapping, error)
- [ ] GetByHostID(hostID uint) ([]*entity.PortMapping, error)
- [ ] GetByHostPort(hostID uint, hostPort int) (*entity.PortMapping, error)
- [ ] Delete(id uint) error
- [ ] DeleteByEnvironmentID(envID uint) error

**5.4.4 单元测试** (1h)
- [ ] 测试端口分配
- [ ] 测试端口释放
- [ ] 测试并发分配
- [ ] 测试唯一约束

#### 验收标准
- [ ] 端口分配逻辑正确
- [ ] 并发安全
- [ ] 唯一约束生效
- [ ] 单元测试通过

#### Git 提交
```bash
git add internal/dao/environment.go
git commit -m "[Environment] 实现 PortMappingDao

- 实现端口分配逻辑
- 实现查询和删除方法
- 支持并发安全
- 单元测试覆盖率: XX%
"
```

---

## 🧪 测试策略

### 单元测试

**测试文件位置**:
- `internal/model/entity/environment_test.go`
- `internal/dao/environment_test.go`

**测试覆盖**:
- 实体模型创建
- JSONB 字段序列化
- CRUD 操作
- 端口分配逻辑
- 并发场景
- 唯一约束

**运行命令**:
```bash
go test -v ./internal/model/entity ./internal/dao
go test -cover ./internal/model/entity ./internal/dao
```

---

## 📦 依赖关系

### 输入依赖
- ⏳ A1: Workspace 实体（Task 1.1）
- ✅ Customer 模型（已完成）
- ✅ Host 模型（已完成）

### 输出依赖（其他人依赖你）
- → A6: 环境创建逻辑需要 Environment 和 PortMapping 模型

**重要**: 完成后立即通知 A6！

---

## 📊 进度跟踪

### 任务进度

| 任务 | 状态 | 开始时间 | 完成时间 | 实际工时 |
|------|------|----------|----------|----------|
| Task 5.1: Environment 实体 | ⏸️ 待开始 | - | - | 0h |
| Task 5.2: PortMapping 实体 | ⏸️ 待开始 | - | - | 0h |
| Task 5.3: EnvironmentDao | ⏸️ 待开始 | - | - | 0h |
| Task 5.4: PortMappingDao | ⏸️ 待开始 | - | - | 0h |

**总进度**: 0/4 (0%)

### 工时统计

- **计划工时**: 14 小时
- **已用工时**: 0 小时
- **剩余工时**: 14 小时

---

## ⚠️ 注意事项

### JSONB 字段配置

```go
type Environment struct {
    // ...
    Command []string          `gorm:"type:jsonb" json:"command"`
    Args    []string          `gorm:"type:jsonb" json:"args"`
    Env     map[string]string `gorm:"type:jsonb" json:"env"`
    GPUIDs  []uint            `gorm:"type:jsonb" json:"gpu_ids"`
}
```

### 端口分配范围

- **NodePort 范围**: 30000-32767
- **自定义范围**: 可在配置中指定

### 常见问题

**Q: 如何处理 JSONB 字段？**
A: 使用 `gorm:"type:jsonb"` 标签，GORM 会自动序列化。

**Q: 端口分配如何防止并发冲突？**
A: 使用数据库事务和 `SELECT ... FOR UPDATE` 行锁。

**Q: 如何测试端口分配？**
A: 使用 goroutine 并发测试，验证不会分配重复端口。

---

## ✅ 完成检查清单

### 代码质量
- [ ] 所有代码通过 `go fmt`
- [ ] 所有代码通过 `go vet`
- [ ] 所有公开方法有注释
- [ ] 错误处理完善

### 测试质量
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 并发测试通过

### 提交
- [ ] 所有代码已提交
- [ ] Pull Request 已创建
- [ ] 代码审查通过
- [ ] 已合并到 dev 分支

### 通知
- [ ] 已通知 A6（Environment 逻辑）
- [ ] 已更新进度文档

---

**文档版本**: v1.0
**创建时间**: 2026-01-30
**最后更新**: 2026-01-30
