# A4 - K8s 集成（网络存储）任务清单

## 👤 基本信息

**员工编号**: A4
**负责模块**: K8s 集成 - 网络和存储管理
**优先级**: P0（最高）
**预估总工时**: 20 小时
**开始日期**: 2026-01-31
**预计完成**: 2026-02-04

---

## 📋 任务概述

负责实现 Kubernetes 网络和存储管理功能，包括：
- Service 创建和管理
- Ingress 配置
- PVC（持久卷）管理
- ConfigMap 管理
- 集成测试

**重要性**: 网络和存储是环境访问和数据持久化的基础，A6 的环境创建依赖此模块。

---

## 🎯 交付目标

### 必须交付
- [ ] Service 管理功能
- [ ] Ingress 配置
- [ ] PVC 管理功能
- [ ] ConfigMap 管理
- [ ] 单元测试（覆盖率 > 80%）
- [ ] 集成测试
- [ ] 使用文档

### 质量标准
- 代码符合 Go 规范
- 所有公开方法有注释
- 错误处理完善
- 测试覆盖率 > 80%
- 通过代码审查

---

## 📝 详细任务分解

### Task 4.1: Service 和网络管理 ⏸️

**预估工时**: 8 小时
**优先级**: P0
**依赖**: A3 完成 K8s 客户端封装（Task 3.1）
**状态**: ⏸️ 待开始

#### 子任务

**4.1.1 CreateService** (3h)
- [ ] 创建文件 `pkg/k8s/service.go`
- [ ] 定义 ServiceConfig 结构体
  - Name, Namespace
  - Type (ClusterIP, NodePort, LoadBalancer)
  - Selector (标签选择器)
  - Ports (端口映射列表)
- [ ] 实现 CreateService(config *ServiceConfig) (*corev1.Service, error)
- [ ] 构建 Service Spec
  - 端口配置
  - 选择器配置
  - 类型配置
- [ ] 调用 K8s API 创建 Service
- [ ] 添加错误处理

**4.1.2 DeleteService** (2h)
- [ ] 实现 GetService(namespace, name string) (*corev1.Service, error)
- [ ] 实现 DeleteService(namespace, name string) error
- [ ] 实现 UpdateService(service *corev1.Service) error
- [ ] 添加错误处理

**4.1.3 Ingress 配置** (3h)
- [ ] 创建文件 `pkg/k8s/ingress.go`
- [ ] 定义 IngressConfig 结构体
  - Name, Namespace
  - Host (域名)
  - Path (路径)
  - ServiceName, ServicePort
  - TLS 配置
- [ ] 实现 CreateIngress(config *IngressConfig) (*networkingv1.Ingress, error)
- [ ] 实现 DeleteIngress(namespace, name string) error
- [ ] 添加错误处理

#### 验收标准
- [ ] Service 创建成功
- [ ] Service 删除成功
- [ ] Ingress 配置正确
- [ ] 端口映射工作正常
- [ ] 错误处理完善

#### Git 提交
```bash
git add pkg/k8s/service.go pkg/k8s/ingress.go
git add pkg/k8s/service_test.go pkg/k8s/ingress_test.go
git commit -m "[K8s] 实现 Service 和 Ingress 管理

- 实现 Service 创建和删除
- 支持多种 Service 类型
- 实现 Ingress 配置
- 单元测试覆盖率: XX%
"
```

---

### Task 4.2: 存储管理 ⏸️

**预估工时**: 6 小时
**优先级**: P0
**依赖**: A3 完成 K8s 客户端封装（Task 3.1）
**状态**: ⏸️ 待开始

#### 子任务

**4.2.1 CreatePVC** (3h)
- [ ] 创建文件 `pkg/k8s/storage.go`
- [ ] 定义 PVCConfig 结构体
  - Name, Namespace
  - StorageClassName
  - Size (存储大小)
  - AccessModes
- [ ] 实现 CreatePVC(config *PVCConfig) (*corev1.PersistentVolumeClaim, error)
- [ ] 构建 PVC Spec
  - 存储类配置
  - 大小配置
  - 访问模式配置
- [ ] 调用 K8s API 创建 PVC
- [ ] 等待 PVC 绑定（可选）
- [ ] 添加错误处理

**4.2.2 DeletePVC** (2h)
- [ ] 实现 GetPVC(namespace, name string) (*corev1.PersistentVolumeClaim, error)
- [ ] 实现 GetPVCStatus(namespace, name string) (string, error)
- [ ] 实现 DeletePVC(namespace, name string) error
- [ ] 添加错误处理

**4.2.3 ConfigMap 管理** (1h)
- [ ] 创建文件 `pkg/k8s/configmap.go`
- [ ] 实现 CreateConfigMap(namespace, name string, data map[string]string) error
- [ ] 实现 GetConfigMap(namespace, name string) (*corev1.ConfigMap, error)
- [ ] 实现 DeleteConfigMap(namespace, name string) error
- [ ] 添加错误处理

#### 验收标准
- [ ] PVC 创建成功
- [ ] PVC 删除成功
- [ ] ConfigMap 管理正常
- [ ] 错误处理完善

#### Git 提交
```bash
git add pkg/k8s/storage.go pkg/k8s/configmap.go
git add pkg/k8s/storage_test.go pkg/k8s/configmap_test.go
git commit -m "[K8s] 实现存储管理功能

- 实现 PVC 创建和删除
- 实现 ConfigMap 管理
- 添加错误处理
- 单元测试覆盖率: XX%
"
```

---

### Task 4.3: 集成测试 ⏸️

**预估工时**: 6 小时
**优先级**: P0
**依赖**: Task 4.1, Task 4.2
**状态**: ⏸️ 待开始

#### 子任务

**4.3.1 网络测试** (2h)
- [ ] 创建测试文件 `pkg/k8s/integration_test.go`
- [ ] 测试场景1：创建 Pod → 创建 Service → 访问 Service
- [ ] 测试场景2：创建 Ingress → 验证路由
- [ ] 测试场景3：端口映射测试

**4.3.2 存储测试** (2h)
- [ ] 测试场景1：创建 PVC → 创建 Pod 挂载 PVC → 写入数据
- [ ] 测试场景2：删除 Pod → 重新创建 Pod → 验证数据持久化
- [ ] 测试场景3：ConfigMap 挂载测试

**4.3.3 端到端测试** (2h)
- [ ] 测试场景：创建完整环境
  - 创建 PVC
  - 创建 ConfigMap
  - 创建 Pod（挂载 PVC 和 ConfigMap）
  - 创建 Service
  - 创建 Ingress
  - 验证访问
  - 清理资源

#### 验收标准
- [ ] 所有集成测试通过
- [ ] 网络访问正常
- [ ] 存储持久化正常
- [ ] 资源清理完整

#### Git 提交
```bash
git add pkg/k8s/integration_test.go
git commit -m "[K8s] 添加集成测试

- 测试网络功能
- 测试存储功能
- 测试端到端场景
"
```

---

## 🧪 测试策略

### 单元测试

**测试文件位置**:
- `pkg/k8s/service_test.go`
- `pkg/k8s/ingress_test.go`
- `pkg/k8s/storage_test.go`
- `pkg/k8s/configmap_test.go`

**测试覆盖**:
- Service 创建和删除
- Ingress 配置
- PVC 创建和删除
- ConfigMap 管理
- 错误处理

**运行命令**:
```bash
go test -v ./pkg/k8s
go test -cover ./pkg/k8s
```

### 集成测试

**测试环境**:
- K8s 测试集群（minikube 或 kind）
- 配置 StorageClass
- 准备测试命名空间

**测试场景**:
1. 网络测试：Pod → Service → Ingress
2. 存储测试：PVC → Pod 挂载 → 数据持久化
3. 端到端测试：完整环境创建和清理

**运行命令**:
```bash
go test -v ./pkg/k8s -tags=integration
```

---

## 📦 依赖关系

### 输入依赖
- ⏳ A3: K8s 客户端封装（Task 3.1）
- ✅ K8s 集群（测试环境）

### 输出依赖（其他人依赖你）
- → A6: 环境创建需要网络和存储管理

**重要**: 完成后立即通知 A6！

---

## 📊 进度跟踪

### 任务进度

| 任务 | 状态 | 开始时间 | 完成时间 | 实际工时 |
|------|------|----------|----------|----------|
| Task 4.1: Service 和网络管理 | ⏸️ 待开始 | - | - | 0h |
| Task 4.2: 存储管理 | ⏸️ 待开始 | - | - | 0h |
| Task 4.3: 集成测试 | ⏸️ 待开始 | - | - | 0h |

**总进度**: 0/3 (0%)

### 工时统计

- **计划工时**: 20 小时
- **已用工时**: 0 小时
- **剩余工时**: 20 小时

---

## ⚠️ 注意事项

### Service 类型

1. **ClusterIP**: 集群内部访问
2. **NodePort**: 通过节点端口访问
3. **LoadBalancer**: 通过负载均衡器访问

### 存储配置

1. **StorageClass**: 使用集群默认或指定
2. **AccessModes**:
   - ReadWriteOnce (RWO)
   - ReadOnlyMany (ROX)
   - ReadWriteMany (RWX)

### 常见问题

**Q: 如何选择 Service 类型？**
A: 开发环境使用 NodePort，生产环境使用 LoadBalancer。

**Q: PVC 如何选择 StorageClass？**
A: 使用集群默认 StorageClass，或在配置中指定。

**Q: Ingress 需要什么前置条件？**
A: 需要安装 Ingress Controller（如 nginx-ingress）。

---

## ✅ 完成检查清单

### 代码质量
- [ ] 所有代码通过 `go fmt`
- [ ] 所有代码通过 `go vet`
- [ ] 所有公开方法有注释
- [ ] 错误处理完善

### 测试质量
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 集成测试通过

### 文档
- [ ] 代码注释完整
- [ ] 使用文档
- [ ] 配置说明

### 提交
- [ ] 所有代码已提交
- [ ] Pull Request 已创建
- [ ] 代码审查通过
- [ ] 已合并到 dev 分支

### 通知
- [ ] 已通知 A6（Environment 逻辑）
- [ ] 已更新进度文档

---

**文档版本**: v1.0
**创建时间**: 2026-01-30
**最后更新**: 2026-01-30
