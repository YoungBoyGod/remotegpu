# A3 - K8s 集成（Pod 管理）任务清单

## 👤 基本信息

**员工编号**: A3
**负责模块**: K8s 集成 - Pod 管理
**优先级**: P0（最高）
**预估总工时**: 20 小时
**开始日期**: 2026-01-30
**预计完成**: 2026-02-03

---

## 📋 任务概述

负责实现 Kubernetes 客户端封装和 Pod 管理功能，包括：
- K8s 客户端初始化和配置
- Pod 创建、查询、删除
- Pod 日志获取
- Pod 状态监控
- 错误处理和重试机制

**重要性**: K8s 集成是环境管理的核心基础设施，A4、A6 都依赖此模块。

---

## 🎯 交付目标

### 必须交付
- [ ] K8s 客户端封装（pkg/k8s）
- [ ] Pod 管理功能（Create、Get、Delete）
- [ ] Pod 日志获取
- [ ] Pod 状态监控
- [ ] 单元测试（覆盖率 > 80%）
- [ ] 集成测试（需要 K8s 测试环境）
- [ ] 使用文档

### 质量标准
- 代码符合 Go 规范
- 所有公开方法有注释
- 错误处理完善
- 测试覆盖率 > 80%
- 通过代码审查

---

## 📝 详细任务分解

### Task 3.1: K8s 客户端封装 ⏸️

**预估工时**: 8 小时
**优先级**: P0
**依赖**: 无
**状态**: ⏸️ 待开始

#### 子任务

**3.1.1 初始化客户端** (2h)
- [ ] 创建目录 `pkg/k8s`
- [ ] 创建文件 `pkg/k8s/client.go`
- [ ] 定义 Client 结构体
- [ ] 实现 NewClient() 函数
  - 支持 kubeconfig 文件
  - 支持 in-cluster 配置
  - 支持命名空间配置
- [ ] 实现 GetClient() 单例模式
- [ ] 添加包注释和文档

**3.1.2 配置管理** (2h)
- [ ] 创建文件 `pkg/k8s/config.go`
- [ ] 定义 Config 结构体
  - KubeConfig 路径
  - Namespace
  - InCluster 标志
  - Timeout 配置
- [ ] 实现 LoadConfig() 函数
- [ ] 从全局配置读取 K8s 配置
- [ ] 添加配置验证

**3.1.3 错误处理** (2h)
- [ ] 创建文件 `pkg/k8s/errors.go`
- [ ] 定义自定义错误类型
  - ErrPodNotFound
  - ErrPodCreationFailed
  - ErrPodDeletionFailed
  - ErrConnectionFailed
- [ ] 实现错误包装函数
- [ ] 添加错误日志记录

**3.1.4 单元测试** (2h)
- [ ] 创建测试文件 `client_test.go`
- [ ] 测试客户端初始化
- [ ] 测试配置加载
- [ ] 测试错误处理
- [ ] Mock K8s API

#### 验收标准
- [ ] 客户端初始化成功
- [ ] 配置加载正确
- [ ] 错误处理完善
- [ ] 单元测试通过
- [ ] 代码格式化（go fmt）
- [ ] 代码检查通过（go vet）

#### 测试命令
```bash
go test -v ./pkg/k8s -run TestClient
go test -cover ./pkg/k8s -run TestClient
```

#### Git 提交
```bash
git add pkg/k8s/client.go pkg/k8s/config.go pkg/k8s/errors.go
git add pkg/k8s/client_test.go
git commit -m "[K8s] 实现 K8s 客户端封装

- 实现客户端初始化（kubeconfig 和 in-cluster）
- 实现配置管理
- 实现错误处理
- 单元测试覆盖率: XX%
"
```

---

### Task 3.2: Pod 管理 ⏸️

**预估工时**: 12 小时
**优先级**: P0
**依赖**: Task 3.1
**状态**: ⏸️ 待开始

#### 子任务

**3.2.1 CreatePod 方法** (4h)
- [ ] 创建文件 `pkg/k8s/pod.go`
- [ ] 定义 PodConfig 结构体
  - Name, Namespace
  - Image, Command, Args
  - Resources (CPU, Memory, GPU)
  - Env, Volumes
  - Labels, Annotations
- [ ] 实现 CreatePod(config *PodConfig) (*corev1.Pod, error)
- [ ] 构建 Pod Spec
  - 容器配置
  - 资源限制
  - GPU 设备插件配置
  - 环境变量
  - 卷挂载
- [ ] 调用 K8s API 创建 Pod
- [ ] 等待 Pod 进入 Running 状态（可选）
- [ ] 添加错误处理和重试

**3.2.2 GetPod 和 DeletePod** (3h)
- [ ] 实现 GetPod(namespace, name string) (*corev1.Pod, error)
- [ ] 实现 GetPodStatus(namespace, name string) (string, error)
- [ ] 实现 DeletePod(namespace, name string) error
- [ ] 实现 DeletePodGracefully(namespace, name string, gracePeriod int64) error
- [ ] 添加错误处理

**3.2.3 GetPodLogs** (2h)
- [ ] 实现 GetPodLogs(namespace, name string, opts *LogOptions) (string, error)
- [ ] 定义 LogOptions 结构体
  - Container 名称
  - TailLines 行数
  - Follow 标志
  - Timestamps 标志
- [ ] 调用 K8s API 获取日志
- [ ] 处理多容器场景
- [ ] 添加错误处理

**3.2.4 WatchPodStatus** (3h)
- [ ] 实现 WatchPodStatus(namespace, name string, callback func(status string)) error
- [ ] 使用 K8s Watch API
- [ ] 监控 Pod 状态变化
- [ ] 调用回调函数通知状态变化
- [ ] 处理 Watch 连接断开和重连
- [ ] 添加超时机制
- [ ] 添加错误处理

#### 验收标准
- [ ] 所有方法实现正确
- [ ] Pod 创建成功
- [ ] Pod 删除成功
- [ ] 日志获取正确
- [ ] 状态监控工作正常
- [ ] 错误处理完善

#### 测试命令
```bash
# 单元测试
go test -v ./pkg/k8s -run TestPod

# 集成测试（需要 K8s 环境）
go test -v ./pkg/k8s -run TestPodIntegration -tags=integration
```

#### Git 提交
```bash
git add pkg/k8s/pod.go pkg/k8s/pod_test.go
git commit -m "[K8s] 实现 Pod 管理功能

- 实现 CreatePod（支持 GPU、资源限制）
- 实现 GetPod 和 DeletePod
- 实现 GetPodLogs
- 实现 WatchPodStatus
- 单元测试覆盖率: XX%
"
```

---

## 🧪 测试策略

### 单元测试

**测试文件位置**:
- `pkg/k8s/client_test.go`
- `pkg/k8s/pod_test.go`

**测试覆盖**:
- 客户端初始化
- Pod 创建（各种配置）
- Pod 查询和删除
- 日志获取
- 状态监控
- 错误处理

**Mock K8s API**:
使用 `k8s.io/client-go/kubernetes/fake` 进行单元测试

**运行命令**:
```bash
go test -v ./pkg/k8s
go test -cover ./pkg/k8s
```

### 集成测试

**测试环境**:
- 需要一个 K8s 测试集群（minikube 或 kind）
- 配置 kubeconfig
- 准备测试命名空间

**测试场景**:
1. 创建 Pod → 等待 Running → 获取日志 → 删除 Pod
2. 创建 GPU Pod → 验证 GPU 分配
3. 监控 Pod 状态变化
4. 并发创建多个 Pod

**运行命令**:
```bash
# 启动测试集群
minikube start

# 运行集成测试
go test -v ./pkg/k8s -tags=integration
```

---

## 📦 依赖关系

### 输入依赖
- ✅ K8s 集群（测试环境）
- ✅ kubeconfig 配置
- ✅ 数据库连接（已完成）

### 输出依赖（其他人依赖你）
- → A4: Service 和存储管理需要客户端
- → A6: 环境创建需要 Pod 管理

**重要**: 完成 Task 3.1 后立即通知 A4！

---

## 🔄 开发流程

### 每个任务的标准流程

1. **开始任务**
   - 在进度文档中更新状态为 "🔄 进行中"
   - 创建功能分支: `git checkout -b feature/k8s-pod-xxx`

2. **编写代码**
   - 按照子任务逐步实现
   - 遵循 Go 代码规范
   - 添加必要的注释

3. **编写测试**
   - 单元测试覆盖率 > 80%
   - 集成测试覆盖主要场景

4. **运行测试**
   ```bash
   go fmt ./...
   go vet ./...
   go test -v ./pkg/k8s
   ```

5. **提交代码**
   - 按照提交规范编写提交信息
   - 推送到远程分支
   - 创建 Pull Request

6. **代码审查**
   - 等待至少一人审查
   - 根据反馈修改代码
   - 审查通过后合并

7. **更新进度**
   - 在进度文档中标记任务为 "✅ 已完成"
   - 更新工时统计
   - 通知依赖方（A4、A6）

---

## 📊 进度跟踪

### 任务进度

| 任务 | 状态 | 开始时间 | 完成时间 | 实际工时 |
|------|------|----------|----------|----------|
| Task 3.1: K8s 客户端封装 | ⏸️ 待开始 | - | - | 0h |
| Task 3.2: Pod 管理 | ⏸️ 待开始 | - | - | 0h |

**总进度**: 0/2 (0%)

### 工时统计

- **计划工时**: 20 小时
- **已用工时**: 0 小时
- **剩余工时**: 20 小时

---

## ⚠️ 注意事项

### K8s 配置

1. **GPU 支持**
   - 使用 NVIDIA Device Plugin
   - 资源名称: `nvidia.com/gpu`
   - 示例配置:
   ```yaml
   resources:
     limits:
       nvidia.com/gpu: 1
   ```

2. **命名空间**
   - 使用配置的默认命名空间
   - 支持动态指定命名空间

3. **资源限制**
   - 必须设置 CPU 和 Memory 限制
   - GPU 限制通过 Device Plugin

### 常见问题

**Q: 如何配置 GPU？**
A: 在 Pod Spec 的 resources.limits 中添加 `nvidia.com/gpu: N`

**Q: 如何处理 Pod 创建失败？**
A: 检查错误类型，记录日志，返回详细错误信息

**Q: 如何测试 K8s 集成？**
A: 使用 minikube 或 kind 搭建本地测试集群

**Q: Watch API 断开如何处理？**
A: 实现自动重连机制，使用指数退避策略

---

## 💡 实现提示

### CreatePod 示例代码

```go
func (c *Client) CreatePod(config *PodConfig) (*corev1.Pod, error) {
    pod := &corev1.Pod{
        ObjectMeta: metav1.ObjectMeta{
            Name:      config.Name,
            Namespace: config.Namespace,
            Labels:    config.Labels,
        },
        Spec: corev1.PodSpec{
            Containers: []corev1.Container{
                {
                    Name:    config.Name,
                    Image:   config.Image,
                    Command: config.Command,
                    Args:    config.Args,
                    Resources: corev1.ResourceRequirements{
                        Limits: corev1.ResourceList{
                            corev1.ResourceCPU:    resource.MustParse(fmt.Sprintf("%d", config.CPU)),
                            corev1.ResourceMemory: resource.MustParse(fmt.Sprintf("%dMi", config.Memory)),
                        },
                    },
                },
            },
        },
    }

    // 添加 GPU 配置
    if config.GPU > 0 {
        pod.Spec.Containers[0].Resources.Limits["nvidia.com/gpu"] = resource.MustParse(fmt.Sprintf("%d", config.GPU))
    }

    // 创建 Pod
    return c.clientset.CoreV1().Pods(config.Namespace).Create(context.TODO(), pod, metav1.CreateOptions{})
}
```

---

## ✅ 完成检查清单

### 代码质量
- [ ] 所有代码通过 `go fmt`
- [ ] 所有代码通过 `go vet`
- [ ] 所有公开方法有注释
- [ ] 错误处理完善

### 测试质量
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 集成测试通过
- [ ] GPU 配置测试

### 文档
- [ ] 代码注释完整
- [ ] 使用文档
- [ ] 配置说明

### 提交
- [ ] 所有代码已提交
- [ ] Pull Request 已创建
- [ ] 代码审查通过
- [ ] 已合并到 dev 分支

### 通知
- [ ] 已通知 A4（K8s 网络存储）
- [ ] 已通知 A6（Environment 逻辑）
- [ ] 已更新进度文档

---

**文档版本**: v1.0
**创建时间**: 2026-01-30
**最后更新**: 2026-01-30
