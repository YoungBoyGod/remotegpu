# A6 - Environment 逻辑任务清单

## 👤 基本信息

**员工编号**: A6
**负责模块**: Environment 逻辑（核心）
**优先级**: P0（最高）
**预估总工时**: 46 小时
**开始日期**: 2026-02-04
**预计完成**: 2026-02-11

---

## 📋 任务概述

负责实现 Environment（环境）的核心业务逻辑，包括：
- 环境创建流程（主机选择、GPU分配、配额检查、K8s集成）
- 环境生命周期管理（启动、停止、重启、删除）
- EnvironmentService 实现
- EnvironmentController 和 API
- 事务处理和错误回滚
- 集成测试

**重要性**: 这是整个系统的核心功能，是P0任务的最后一环。

---

## 🎯 交付目标

### 必须交付
- [ ] 环境创建逻辑（完整流程）
- [ ] 环境生命周期管理
- [ ] EnvironmentService
- [ ] EnvironmentController
- [ ] API 路由配置
- [ ] 事务处理和回滚
- [ ] 单元测试（覆盖率 > 80%）
- [ ] 集成测试
- [ ] API 文档

### 质量标准
- 代码符合 Go 规范
- 所有公开方法有注释
- 错误处理完善
- 事务处理正确
- 测试覆盖率 > 80%
- 通过代码审查

---

## 📝 详细任务分解

### Task 6.1: 环境创建逻辑 ⏸️

**预估工时**: 20 小时
**优先级**: P0
**依赖**: A1, A2, A3, A4, A5 全部完成
**状态**: ⏸️ 待开始

#### 子任务

**6.1.1 主机选择算法** (4h)
- [ ] 创建文件 `internal/service/environment.go`
- [ ] 定义 EnvironmentService 结构体
- [ ] 实现 selectHost() 方法
  - 查询可用主机（状态为 active）
  - 过滤资源不足的主机
  - 按资源使用率排序（负载均衡）
  - 返回最优主机
- [ ] 添加主机选择策略配置
- [ ] 编写单元测试

**6.1.2 GPU 分配逻辑** (4h)
- [ ] 实现 allocateGPUs() 方法
  - 查询主机上可用的 GPU
  - 按需分配指定数量的 GPU
  - 使用事务和行锁防止并发冲突
  - 更新 GPU 状态为 allocated
  - 记录分配信息
- [ ] 实现 releaseGPUs() 方法
- [ ] 编写单元测试

**6.1.3 配额检查集成** (3h)
- [ ] 集成 ResourceQuotaService
- [ ] 在创建前检查配额
- [ ] 配额不足时返回详细错误
- [ ] 编写单元测试

**6.1.4 K8s Pod 创建集成** (5h)
- [ ] 集成 K8s 客户端
- [ ] 构建 Pod 配置
  - 镜像、命令、参数
  - 资源限制（CPU、Memory、GPU）
  - 环境变量
  - 卷挂载（PVC）
- [ ] 创建 Service（端口映射）
- [ ] 创建 PVC（如果需要）
- [ ] 等待 Pod 启动
- [ ] 记录访问信息
- [ ] 编写单元测试

**6.1.5 事务处理** (4h)
- [ ] 实现完整的事务流程
- [ ] 实现回滚逻辑
  - 释放 GPU
  - 删除 K8s 资源
  - 删除 Environment 记录
  - 删除 PortMapping 记录
- [ ] 添加错误处理
- [ ] 编写单元测试

#### 验收标准
- [ ] 主机选择正确
- [ ] GPU 分配成功
- [ ] 配额检查生效
- [ ] K8s Pod 创建成功
- [ ] 事务处理正确
- [ ] 回滚逻辑完善

#### Git 提交
```bash
git add internal/service/environment.go
git add internal/service/environment_test.go
git commit -m "[Environment] 实现环境创建逻辑

- 实现主机选择算法
- 实现 GPU 分配逻辑
- 集成配额检查
- 集成 K8s Pod 创建
- 实现事务处理和回滚
- 单元测试覆盖率: XX%
"
```

---

### Task 6.2: 环境生命周期管理 ⏸️

**预估工时**: 16 小时
**优先级**: P0
**依赖**: Task 6.1
**状态**: ⏸️ 待开始

#### 子任务

**6.2.1 StartEnvironment** (4h)
- [ ] 实现 StartEnvironment(id uint) error
- [ ] 检查环境状态（只能启动 stopped 状态）
- [ ] 调用 K8s API 启动 Pod
- [ ] 更新环境状态为 running
- [ ] 记录启动时间
- [ ] 添加错误处理
- [ ] 编写单元测试

**6.2.2 StopEnvironment** (4h)
- [ ] 实现 StopEnvironment(id uint) error
- [ ] 检查环境状态（只能停止 running 状态）
- [ ] 调用 K8s API 停止 Pod
- [ ] 更新环境状态为 stopped
- [ ] 记录停止时间
- [ ] 添加错误处理
- [ ] 编写单元测试

**6.2.3 RestartEnvironment** (3h)
- [ ] 实现 RestartEnvironment(id uint) error
- [ ] 调用 Stop 然后 Start
- [ ] 或直接调用 K8s API 重启
- [ ] 更新状态
- [ ] 添加错误处理
- [ ] 编写单元测试

**6.2.4 DeleteEnvironment** (5h)
- [ ] 实现 DeleteEnvironment(id uint) error
- [ ] 检查环境状态（建议先停止）
- [ ] 删除 K8s 资源（Pod、Service、PVC）
- [ ] 释放 GPU
- [ ] 释放端口
- [ ] 删除 PortMapping 记录
- [ ] 软删除 Environment 记录
- [ ] 使用事务确保一致性
- [ ] 添加错误处理
- [ ] 编写单元测试

#### 验收标准
- [ ] 启动功能正常
- [ ] 停止功能正常
- [ ] 重启功能正常
- [ ] 删除功能正常
- [ ] 资源清理完整
- [ ] 状态转换正确

#### Git 提交
```bash
git add internal/service/environment.go
git commit -m "[Environment] 实现环境生命周期管理

- 实现 StartEnvironment
- 实现 StopEnvironment
- 实现 RestartEnvironment
- 实现 DeleteEnvironment
- 实现资源清理逻辑
- 单元测试覆盖率: XX%
"
```

---

### Task 6.3: EnvironmentService 完善 ⏸️

**预估工时**: 10 小时
**优先级**: P0
**依赖**: Task 6.2
**状态**: ⏸️ 待开始

#### 子任务

**6.3.1 Service 层实现** (6h)
- [ ] 实现 GetEnvironment(id uint) (*entity.Environment, error)
- [ ] 实现 ListEnvironments(customerID uint, filters map[string]interface{}) ([]*entity.Environment, error)
- [ ] 实现 GetAccessInfo(id uint) (map[string]interface{}, error)
  - 返回访问 URL
  - 返回端口映射
  - 返回连接信息
- [ ] 实现 GetLogs(id uint, opts *LogOptions) (string, error)
- [ ] 实现 GetStatus(id uint) (string, error)
- [ ] 添加权限检查
- [ ] 编写单元测试

**6.3.2 错误处理和回滚** (4h)
- [ ] 完善所有方法的错误处理
- [ ] 实现统一的错误类型
- [ ] 实现回滚机制
- [ ] 添加日志记录
- [ ] 编写错误场景测试

#### 验收标准
- [ ] 所有方法实现正确
- [ ] 权限检查完善
- [ ] 错误处理完善
- [ ] 单元测试通过

#### Git 提交
```bash
git add internal/service/environment.go
git commit -m "[Environment] 完善 EnvironmentService

- 实现查询和列表方法
- 实现访问信息获取
- 实现日志获取
- 完善错误处理和回滚
- 单元测试覆盖率: XX%
"
```

---

### Task 6.4: EnvironmentController 和 API ⏸️

**预估工时**: 8 小时 (分段完成)
**优先级**: P0
**依赖**: Task 6.3
**状态**: ⏸️ 待开始

#### 子任务 (第一部分)

**6.4.1 创建 API 定义** (2h)
- [ ] 创建文件 `api/v1/environment.go`
- [ ] 定义请求结构体
  - CreateEnvironmentRequest
  - UpdateEnvironmentRequest
  - ListEnvironmentsRequest
- [ ] 定义响应结构体
  - EnvironmentResponse
  - EnvironmentListResponse
  - AccessInfoResponse
- [ ] 添加验证标签

**6.4.2 实现 Controller (CRUD)** (3h)
- [ ] 创建文件 `internal/controller/v1/environment.go`
- [ ] 实现 Create(c *gin.Context)
- [ ] 实现 GetByID(c *gin.Context)
- [ ] 实现 List(c *gin.Context)
- [ ] 实现 Delete(c *gin.Context)
- [ ] 添加参数验证
- [ ] 添加错误处理

#### Git 提交 (第一部分)
```bash
git add api/v1/environment.go
git add internal/controller/v1/environment.go
git commit -m "[Environment] 实现 Environment Controller (Part 1)

- 创建 API 定义
- 实现 CRUD 接口
- 添加参数验证
"
```

---

#### 子任务 (第二部分)

**6.4.3 实现 Controller (操作)** (3h)
- [ ] 实现 Start(c *gin.Context)
- [ ] 实现 Stop(c *gin.Context)
- [ ] 实现 Restart(c *gin.Context)
- [ ] 实现 GetAccessInfo(c *gin.Context)
- [ ] 实现 GetLogs(c *gin.Context)
- [ ] 添加错误处理

#### Git 提交 (第二部分)
```bash
git add internal/controller/v1/environment.go
git commit -m "[Environment] 实现 Environment Controller (Part 2)

- 实现生命周期操作接口
- 实现访问信息接口
- 实现日志接口
"
```

---

### Task 6.5: 路由配置 ⏸️

**预估工时**: 2 小时
**优先级**: P0
**依赖**: Task 6.4
**状态**: ⏸️ 待开始

#### 子任务

**6.5.1 配置路由** (2h)
- [ ] 编辑 `internal/router/router.go`
- [ ] 添加 Environment 路由组
- [ ] 配置认证中间件
- [ ] 配置权限检查
- [ ] 路由列表：
  ```
  POST   /api/v1/environments          - 创建环境
  GET    /api/v1/environments/:id      - 获取环境
  GET    /api/v1/environments          - 列表
  DELETE /api/v1/environments/:id      - 删除
  POST   /api/v1/environments/:id/start   - 启动
  POST   /api/v1/environments/:id/stop    - 停止
  POST   /api/v1/environments/:id/restart - 重启
  GET    /api/v1/environments/:id/access  - 访问信息
  GET    /api/v1/environments/:id/logs    - 日志
  ```

#### Git 提交
```bash
git add internal/router/router.go
git commit -m "[Environment] 配置 Environment 路由

- 添加所有 Environment API 路由
- 配置认证和权限中间件
"
```

---

### Task 6.6: 集成测试 ⏸️

**预估工时**: 6 小时
**优先级**: P0
**依赖**: Task 6.5
**状态**: ⏸️ 待开始

#### 子任务

**6.6.1 环境创建流程测试** (2h)
- [ ] 创建测试文件 `internal/service/environment_integration_test.go`
- [ ] 测试完整创建流程
- [ ] 测试配额检查
- [ ] 测试 GPU 分配
- [ ] 测试 K8s 集成

**6.6.2 生命周期测试** (2h)
- [ ] 测试启动、停止、重启
- [ ] 测试删除和资源清理
- [ ] 测试状态转换

**6.6.3 错误场景测试** (2h)
- [ ] 测试配额不足
- [ ] 测试 GPU 不足
- [ ] 测试 K8s 创建失败
- [ ] 测试回滚逻辑

#### Git 提交
```bash
git add internal/service/environment_integration_test.go
git commit -m "[Environment] 添加集成测试

- 测试环境创建流程
- 测试生命周期管理
- 测试错误场景和回滚
"
```

---

## 🧪 测试策略

### 单元测试

**测试文件位置**:
- `internal/service/environment_test.go`
- `internal/controller/v1/environment_test.go`

**测试覆盖**:
- 主机选择算法
- GPU 分配逻辑
- 配额检查
- 生命周期管理
- 错误处理
- 回滚逻辑

### 集成测试

**测试环境**:
- 测试数据库
- K8s 测试集群
- 测试数据准备

**测试场景**:
1. 完整创建流程
2. 生命周期管理
3. 并发创建
4. 错误场景

---

## 📦 依赖关系

### 输入依赖
- ⏳ A1: Workspace 模型和 Service
- ⏳ A2: ResourceQuota Service
- ⏳ A3: K8s Pod 管理
- ⏳ A4: K8s 网络存储
- ⏳ A5: Environment 和 PortMapping 模型
- ✅ Host 和 GPU 模型（已完成）

**重要**: 这是依赖最多的任务，需要等待所有前置任务完成！

---

## 📊 进度跟踪

### 任务进度

| 任务 | 状态 | 开始时间 | 完成时间 | 实际工时 |
|------|------|----------|----------|----------|
| Task 6.1: 环境创建逻辑 | ⏸️ 待开始 | - | - | 0h |
| Task 6.2: 生命周期管理 | ⏸️ 待开始 | - | - | 0h |
| Task 6.3: Service 完善 | ⏸️ 待开始 | - | - | 0h |
| Task 6.4: Controller 和 API | ⏸️ 待开始 | - | - | 0h |
| Task 6.5: 路由配置 | ⏸️ 待开始 | - | - | 0h |
| Task 6.6: 集成测试 | ⏸️ 待开始 | - | - | 0h |

**总进度**: 0/6 (0%)

### 工时统计

- **计划工时**: 46 小时
- **已用工时**: 0 小时
- **剩余工时**: 46 小时

---

## ⚠️ 注意事项

### 事务处理

1. **创建环境事务**:
   ```
   开始事务
   → 检查配额
   → 选择主机
   → 分配 GPU
   → 分配端口
   → 创建 Environment 记录
   → 创建 K8s Pod
   → 提交事务

   如果失败 → 回滚所有操作
   ```

2. **删除环境事务**:
   ```
   开始事务
   → 删除 K8s 资源
   → 释放 GPU
   → 释放端口
   → 删除记录
   → 提交事务
   ```

### 常见问题

**Q: 如何处理 K8s 创建失败？**
A: 回滚所有已分配的资源（GPU、端口、数据库记录）。

**Q: 如何处理并发创建？**
A: 使用数据库事务和行锁，确保资源分配的原子性。

**Q: 如何测试完整流程？**
A: 使用集成测试，准备完整的测试环境（数据库、K8s）。

---

## ✅ 完成检查清单

### 代码质量
- [ ] 所有代码通过 `go fmt`
- [ ] 所有代码通过 `go vet`
- [ ] 所有公开方法有注释
- [ ] 错误处理完善
- [ ] 事务处理正确

### 测试质量
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 集成测试通过
- [ ] 错误场景测试充分

### 文档
- [ ] 代码注释完整
- [ ] API 文档完整
- [ ] 使用文档

### 提交
- [ ] 所有代码已提交
- [ ] Pull Request 已创建
- [ ] 代码审查通过
- [ ] 已合并到 dev 分支

### 通知
- [ ] 已更新进度文档
- [ ] 已通知团队完成

---

**文档版本**: v1.0
**创建时间**: 2026-01-30
**最后更新**: 2026-01-30
