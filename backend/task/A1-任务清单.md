# A1 - Workspace 管理模块任务清单

## 👤 基本信息

**员工编号**: A1
**负责模块**: Workspace 管理
**优先级**: P0（最高）
**预估总工时**: 20 小时
**开始日期**: 2026-01-30
**预计完成**: 2026-02-03

---

## 📋 任务概述

负责实现 Workspace（工作空间）和 WorkspaceMember（工作空间成员）的完整功能，包括：
- 实体模型设计和实现
- 数据访问层（Dao）实现
- 业务逻辑层（Service）实现
- 单元测试和集成测试

**重要性**: Workspace 是其他模块的基础依赖，A2、A5、A6 都依赖此模块。

---

## 🎯 交付目标

### 必须交付
- [x] Workspace 实体模型
- [x] WorkspaceMember 实体模型
- [x] WorkspaceDao（完整 CRUD）
- [x] WorkspaceMemberDao（完整 CRUD）
- [x] WorkspaceService（业务逻辑）
- [x] 单元测试（覆盖率 > 80%）
- [x] 集成测试
- [x] API 文档

### 质量标准
- 代码符合 Go 规范
- 所有公开方法有注释
- 错误处理完善
- 测试覆盖率 > 80%
- 通过代码审查

---

## 📝 详细任务分解

### Task 1.1: Workspace 实体模型 ⏸️

**预估工时**: 4 小时
**优先级**: P0
**依赖**: 无
**状态**: ⏸️ 待开始

#### 子任务

**1.1.1 创建文件和基础结构** (1h)
- [ ] 创建文件 `internal/model/entity/workspace.go`
- [ ] 添加 package 声明和必要的 import
- [ ] 定义 Workspace 结构体基础框架
- [ ] 参考 SQL: `sql/03_users_and_permissions.sql`

**1.1.2 定义字段和 GORM 标签** (1h)
- [ ] 添加所有字段：
  - ID (uint, 主键)
  - UUID (string, 唯一索引)
  - Name (string)
  - OwnerID (uint, 外键)
  - Description (string)
  - Status (string)
  - CreatedAt, UpdatedAt, DeletedAt
- [ ] 添加 GORM 标签（主键、索引、外键、默认值）
- [ ] 添加 JSON 标签

**1.1.3 添加关联关系** (1h)
- [ ] 添加 Owner 关联（belongs to Customer）
- [ ] 添加 Members 关联（has many WorkspaceMember）
- [ ] 实现 TableName() 方法返回 "workspaces"
- [ ] 添加字段注释和文档

**1.1.4 编写单元测试** (1h)
- [ ] 创建测试文件 `workspace_test.go`
- [ ] 测试结构体创建
- [ ] 测试 TableName 方法
- [ ] 测试 GORM 标签正确性

#### 验收标准
- [x] 文件创建成功
- [x] 所有字段定义正确
- [x] GORM 标签完整
- [x] 关联关系正确
- [x] 单元测试通过
- [x] 代码格式化（go fmt）
- [x] 代码检查通过（go vet）

#### 测试命令
```bash
# 运行测试
go test -v ./internal/model/entity -run TestWorkspace

# 检查覆盖率
go test -cover ./internal/model/entity -run TestWorkspace
```

#### Git 提交
```bash
git add internal/model/entity/workspace.go
git add internal/model/entity/workspace_test.go
git commit -m "[Workspace] 添加 Workspace 实体模型

- 创建 Workspace 结构体
- 添加所有必需字段和 GORM 标签
- 添加与 Customer 的关联关系
- 实现 TableName 方法
- 单元测试覆盖率: XX%
"
```

---

### Task 1.2: WorkspaceMember 实体模型 ⏸️

**预估工时**: 2 小时
**优先级**: P0
**依赖**: Task 1.1
**状态**: ⏸️ 待开始

#### 子任务

**1.2.1 创建文件和基础结构** (0.5h)
- [ ] 在 `workspace.go` 中添加 WorkspaceMember 结构体
- [ ] 定义基础字段

**1.2.2 添加唯一约束** (0.5h)
- [ ] 添加字段：
  - ID (uint, 主键)
  - WorkspaceID (uint, 外键)
  - CustomerID (uint, 外键)
  - Role (string)
  - JoinedAt (time.Time)
- [ ] 添加唯一索引：`idx_workspace_customer` (WorkspaceID, CustomerID)
- [ ] 添加 GORM 标签

**1.2.3 编写单元测试** (1h)
- [ ] 测试结构体创建
- [ ] 测试唯一约束
- [ ] 测试关联关系

#### 验收标准
- [x] WorkspaceMember 结构体定义正确
- [x] 唯一约束配置正确
- [x] 单元测试通过

#### Git 提交
```bash
git add internal/model/entity/workspace.go
git commit -m "[Workspace] 添加 WorkspaceMember 实体模型

- 创建 WorkspaceMember 结构体
- 添加唯一约束 (WorkspaceID, CustomerID)
- 添加关联关系
- 单元测试覆盖率: XX%
"
```

---

### Task 1.3: WorkspaceDao ⏸️

**预估工时**: 6 小时
**优先级**: P0
**依赖**: Task 1.1
**状态**: ⏸️ 待开始

#### 子任务

**1.3.1 创建基础结构** (1h)
- [ ] 创建文件 `internal/dao/workspace.go`
- [ ] 定义 WorkspaceDao 结构体
- [ ] 实现 NewWorkspaceDao() 构造函数
- [ ] 添加包注释和文档

**1.3.2 实现 CRUD 方法** (3h)
- [ ] Create(workspace *entity.Workspace) error
- [ ] GetByID(id uint) (*entity.Workspace, error)
- [ ] GetByUUID(uuid string) (*entity.Workspace, error)
- [ ] Update(workspace *entity.Workspace) error
- [ ] Delete(id uint) error
- [ ] 添加错误处理

**1.3.3 实现查询方法** (1h)
- [ ] GetByOwnerID(ownerID uint) ([]*entity.Workspace, error)
- [ ] List(page, pageSize int) ([]*entity.Workspace, int64, error)
- [ ] GetByStatus(status string) ([]*entity.Workspace, error)

**1.3.4 编写单元测试** (1h)
- [ ] 创建测试文件 `workspace_test.go`
- [ ] 测试所有 CRUD 方法
- [ ] 测试查询方法
- [ ] 测试错误处理
- [ ] 使用测试数据库

#### 验收标准
- [x] 所有方法实现正确
- [x] 错误处理完善
- [x] 单元测试通过
- [x] 测试覆盖率 > 80%

#### 测试命令
```bash
# 运行测试
go test -v ./internal/dao -run TestWorkspaceDao

# 检查覆盖率
go test -cover ./internal/dao -run TestWorkspaceDao
```

#### Git 提交
```bash
git add internal/dao/workspace.go
git add internal/dao/workspace_test.go
git commit -m "[Workspace] 实现 WorkspaceDao

- 实现完整的 CRUD 方法
- 实现查询方法（按 Owner、状态、分页）
- 添加错误处理
- 单元测试覆盖率: XX%
"
```

---

### Task 1.4: WorkspaceMemberDao ⏸️

**预估工时**: 4 小时
**优先级**: P0
**依赖**: Task 1.2
**状态**: ⏸️ 待开始

#### 子任务

**1.4.1 创建基础结构** (0.5h)
- [ ] 在 `workspace.go` 中添加 WorkspaceMemberDao
- [ ] 实现构造函数

**1.4.2 实现 CRUD 方法** (2h)
- [ ] Create(member *entity.WorkspaceMember) error
- [ ] GetByID(id uint) (*entity.WorkspaceMember, error)
- [ ] Update(member *entity.WorkspaceMember) error
- [ ] Delete(id uint) error

**1.4.3 实现查询方法** (0.5h)
- [ ] GetByWorkspaceID(workspaceID uint) ([]*entity.WorkspaceMember, error)
- [ ] GetByCustomerID(customerID uint) ([]*entity.WorkspaceMember, error)
- [ ] GetByWorkspaceAndCustomer(workspaceID, customerID uint) (*entity.WorkspaceMember, error)

**1.4.4 编写单元测试** (1h)
- [ ] 测试所有方法
- [ ] 测试唯一约束
- [ ] 测试错误处理

#### 验收标准
- [x] 所有方法实现正确
- [x] 唯一约束生效
- [x] 单元测试通过

#### Git 提交
```bash
git add internal/dao/workspace.go
git commit -m "[Workspace] 实现 WorkspaceMemberDao

- 实现完整的 CRUD 方法
- 实现查询方法
- 测试唯一约束
- 单元测试覆盖率: XX%
"
```

---

### Task 1.5: WorkspaceService ⏸️

**预估工时**: 4 小时
**优先级**: P0
**依赖**: Task 1.3, Task 1.4
**状态**: ⏸️ 待开始

#### 子任务

**1.5.1 实现 CRUD 操作** (2h)
- [ ] 创建文件 `internal/service/workspace.go`
- [ ] 定义 WorkspaceService 结构体
- [ ] CreateWorkspace(workspace *entity.Workspace) error
- [ ] GetWorkspace(id uint) (*entity.Workspace, error)
- [ ] UpdateWorkspace(workspace *entity.Workspace) error
- [ ] DeleteWorkspace(id uint) error
- [ ] ListWorkspaces(ownerID uint, page, pageSize int) ([]*entity.Workspace, int64, error)

**1.5.2 实现成员管理** (1h)
- [ ] AddMember(workspaceID, customerID uint, role string) error
- [ ] RemoveMember(workspaceID, customerID uint) error
- [ ] ListMembers(workspaceID uint) ([]*entity.WorkspaceMember, error)
- [ ] CheckPermission(workspaceID, customerID uint) (bool, error)

**1.5.3 编写单元测试** (1h)
- [ ] 创建测试文件 `workspace_test.go`
- [ ] 测试所有业务逻辑
- [ ] 测试权限检查
- [ ] 测试错误场景

#### 验收标准
- [x] 所有业务逻辑正确
- [x] 权限检查完善
- [x] 单元测试通过
- [x] 测试覆盖率 > 80%

#### Git 提交
```bash
git add internal/service/workspace.go
git add internal/service/workspace_test.go
git commit -m "[Workspace] 实现 WorkspaceService

- 实现工作空间 CRUD 操作
- 实现成员管理功能
- 实现权限检查
- 单元测试覆盖率: XX%
"
```

---

## 🧪 测试策略

### 单元测试

**测试文件位置**:
- `internal/model/entity/workspace_test.go`
- `internal/dao/workspace_test.go`
- `internal/service/workspace_test.go`

**测试覆盖**:
- 所有公开方法
- 错误处理路径
- 边界条件
- 并发场景（如果有）

**运行命令**:
```bash
# 运行所有测试
go test -v ./internal/model/entity ./internal/dao ./internal/service

# 检查覆盖率
go test -cover ./internal/model/entity ./internal/dao ./internal/service

# 生成覆盖率报告
go test -coverprofile=coverage.out ./internal/...
go tool cover -html=coverage.out
```

### 集成测试

**测试场景**:
1. 创建工作空间 → 添加成员 → 查询成员
2. 创建工作空间 → 更新信息 → 删除工作空间
3. 权限检查流程
4. 并发创建工作空间

**测试数据库**:
- 使用独立的测试数据库
- 每次测试后清理数据
- 不要使用生产数据

---

## 📦 依赖关系

### 输入依赖
- ✅ Customer 模型（已完成）
- ✅ 数据库连接（已完成）

### 输出依赖（其他人依赖你）
- → A2: ResourceQuota 需要 WorkspaceID 外键
- → A5: Environment 需要 WorkspaceID 外键
- → A6: 环境创建需要 Workspace 权限检查

**重要**: 完成 Task 1.1 后立即通知 A2 和 A5！

---

## 🔄 开发流程

### 每个任务的标准流程

1. **开始任务**
   - 在进度文档中更新状态为 "🔄 进行中"
   - 创建功能分支: `git checkout -b feature/workspace-xxx`

2. **编写代码**
   - 按照子任务逐步实现
   - 遵循 Go 代码规范
   - 添加必要的注释

3. **编写测试**
   - 单元测试覆盖率 > 80%
   - 测试所有公开方法
   - 测试错误处理

4. **运行测试**
   ```bash
   go fmt ./...
   go vet ./...
   go test -v ./internal/...
   ```

5. **提交代码**
   - 按照提交规范编写提交信息
   - 推送到远程分支
   - 创建 Pull Request

6. **代码审查**
   - 等待至少一人审查
   - 根据反馈修改代码
   - 审查通过后合并

7. **更新进度**
   - 在进度文档中标记任务为 "✅ 已完成"
   - 更新工时统计
   - 通知依赖方

---

## 📊 进度跟踪

### 任务进度

| 任务 | 状态 | 开始时间 | 完成时间 | 实际工时 |
|------|------|----------|----------|----------|
| Task 1.1: Workspace 实体 | ⏸️ 待开始 | - | - | 0h |
| Task 1.2: WorkspaceMember 实体 | ⏸️ 待开始 | - | - | 0h |
| Task 1.3: WorkspaceDao | ⏸️ 待开始 | - | - | 0h |
| Task 1.4: WorkspaceMemberDao | ⏸️ 待开始 | - | - | 0h |
| Task 1.5: WorkspaceService | ⏸️ 待开始 | - | - | 0h |

**总进度**: 0/5 (0%)

### 工时统计

- **计划工时**: 20 小时
- **已用工时**: 0 小时
- **剩余工时**: 20 小时

---

## ⚠️ 注意事项

### 开发规范

1. **代码风格**
   - 遵循 Go 官方代码规范
   - 使用 `go fmt` 格式化代码
   - 使用 `go vet` 检查代码

2. **命名规范**
   - 结构体：大驼峰（PascalCase）
   - 方法：大驼峰（公开）或小驼峰（私有）
   - 变量：小驼峰（camelCase）
   - 常量：全大写（UPPER_CASE）

3. **注释规范**
   - 所有公开的结构体、方法必须有注释
   - 注释以名称开头
   - 示例：`// Workspace 表示工作空间实体`

4. **错误处理**
   - 所有错误必须处理
   - 使用 `fmt.Errorf` 包装错误
   - 提供有意义的错误信息

### 常见问题

**Q: Workspace 的 UUID 如何生成？**
A: 使用 `github.com/google/uuid` 包生成 UUID v4。

**Q: 如何处理软删除？**
A: 使用 GORM 的 `gorm.DeletedAt` 字段，GORM 会自动处理。

**Q: 如何测试数据库操作？**
A: 使用测试数据库，参考 `internal/dao/user_test.go` 的实现。

**Q: 如何处理并发问题？**
A: 使用数据库事务和乐观锁（version 字段）。

---

## 📞 联系方式

### 遇到问题时

1. **技术问题**: 在团队群中提问
2. **阻塞问题**: 立即通知项目经理
3. **依赖问题**: 直接联系依赖方（A2、A5）

### 每日站会

- **时间**: 每天上午 10:00
- **时长**: 15 分钟
- **内容**: 昨天完成、今天计划、遇到的问题

---

## ✅ 完成检查清单

### 代码质量
- [ ] 所有代码通过 `go fmt`
- [ ] 所有代码通过 `go vet`
- [ ] 所有公开方法有注释
- [ ] 错误处理完善

### 测试质量
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有测试通过
- [ ] 集成测试通过
- [ ] 边界条件测试

### 文档
- [ ] 代码注释完整
- [ ] API 文档更新
- [ ] README 更新（如果需要）

### 提交
- [ ] 所有代码已提交
- [ ] Pull Request 已创建
- [ ] 代码审查通过
- [ ] 已合并到 dev 分支

### 通知
- [ ] 已通知 A2（ResourceQuota）
- [ ] 已通知 A5（Environment）
- [ ] 已更新进度文档

---

**文档版本**: v1.0
**创建时间**: 2026-01-30
**最后更新**: 2026-01-30
